<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>VOXEL ENGINE - REALISTIC TEXTURES</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Segoe UI', sans-serif; }
        #ui {
            position: absolute; top: 20px; left: 20px; color: #e2e8f0;
            pointer-events: none; z-index: 10; background: rgba(15, 23, 42, 0.85);
            padding: 20px; border-radius: 15px; border: 1px solid #1e293b;
            backdrop-filter: blur(5px);
        }
        #controls {
            position: absolute; bottom: 30px; left: 30px; display: grid;
            grid-template-columns: 60px 60px 60px; gap: 10px; z-index: 100;
        }
        .btn {
            width: 60px; height: 60px; background: rgba(30, 41, 59, 0.8); color: #94a3b8;
            border: 1px solid #334155; border-radius: 10px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-weight: bold;
            font-size: 20px; user-select: none; transition: 0.2s;
        }
        .btn:active { background: #94a3b8; color: #1e293b; }
        .btn-audio {
            position: absolute; top: 20px; right: 20px; background: #0ea5e9;
            color: white; border: none; padding: 15px 30px; cursor: pointer;
            border-radius: 50px; font-weight: bold; z-index: 100;
        }
        #instructions { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #64748b; }
    </style>
</head>
<body>

    <div id="ui">
        <h1 style="margin:0; font-size: 22px;">REALISTIC DESTRUCTION</h1>
        <div id="status">> RENDERER: TEXTURE_MAPPED | PHYSICS: ACTIVE</div>
    </div>

    <div id="controls">
        <div></div><div class="btn" onmousedown="moveCam('up')">▲</div><div></div>
        <div class="btn" onmousedown="moveCam('left')">◀</div>
        <div class="btn" onmousedown="moveCam('down')">▼</div>
        <div class="btn" onmousedown="moveCam('right')">▶</div>
    </div>

    <div id="instructions">השתמש בחצים לניווט | לחץ על בניין להשמדה</div>
    <button class="btn-audio" id="audioBtn" onclick="initAudio()">הפעל סאונד</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <script>
        /** 1. מנוע סאונד **/
        let audioCtx = null;
        function initAudio() { /* ... קוד סאונד נשאר זהה ... */ }
        function playSound(type) { /* ... קוד סאונד נשאר זהה ... */ }

        /** 2. אתחול עולם עם טקסטורות **/
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f172a);
        scene.fog = new THREE.Fog(0x0f172a, 200, 800);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 3000);
        let camAngle = 1, camHeight = 100, camRadius = 350;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(200, 400, 200);
        scene.add(sun);

        // קרקע משקפת
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(2000, 2000),
            new THREE.MeshStandardMaterial({ color: 0x0f172a, roughness: 0.2, metalness: 0.8 })
        );
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        /** 3. בניית עיר עם טקסטורות **/
        let buildings = []; // חשוב: לא const כי נעדכן את המערך
        const debris = [];
        
        // טוען טקסטורות
        const textureLoader = new THREE.TextureLoader();
        const textureUrls = [
            'https://threejs.org/examples/textures/brick_diffuse.jpg',
            'https://threejs.org/examples/textures/carbon/Carbon.png',
            'https://threejs.org/examples/textures/water.jpg'
        ];
        
        // טעינה מראש של הטקסטורות
        const textures = textureUrls.map(url => textureLoader.load(url));

        function createCity() {
            for (let i = 0; i < 40; i++) {
                const bx = (Math.random() - 0.5) * 500;
                const bz = (Math.random() - 0.5) * 500;
                const bh = Math.floor(Math.random() * 80) + 40;
                const bw = Math.floor(Math.random() * 10) + 10;

                const geo = new THREE.BoxGeometry(bw, bh, bw);
                
                // בחירת טקסטורה אקראית
                const texture = textures[i % textures.length];
                // מיפוי UV חכם: גורם לטקסטורה לחזור על עצמה במקום להימתח
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(1, Math.round(bh / bw)); // חוזרת על עצמה אנכית

                const mat = new THREE.MeshStandardMaterial({
                    map: texture,
                    roughness: 0.5,
                    metalness: 0.2
                });

                const building = new THREE.Mesh(geo, mat);
                building.position.set(bx, bh / 2, bz);
                
                scene.add(building);
                buildings.push(building);
            }
        }
        createCity();

        /** 4. מנגנון התחדשות **/
        function scheduleRegeneration(config) {
            setTimeout(() => {
                rebuildBuilding(config);
            }, 8000 + Math.random() * 10000);
        }

        function rebuildBuilding(config) {
            // בונה מחדש בניין שנהרס
            const { x, z, w, h } = config;
            const geo = new THREE.BoxGeometry(w, h, w);
            const texture = textures[Math.floor(Math.random() * textures.length)];
            texture.repeat.set(1, Math.round(h / w));

            const mat = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.5, metalness: 0.2 });
            const building = new THREE.Mesh(geo, mat);
            building.position.set(x, h / 2, z);
            
            // אנימציית בנייה
            building.scale.set(0, 0, 0);
            scene.add(building);
            buildings.push(building);
            
            gsap.to(building.scale, { x: 1, y: 1, z: 1, duration: 1, ease: "expo.out" });
        }

        /** 5. שליטת מצלמה וירי **/
        function moveCam(dir) { /* ... קוד נשאר זהה ... */ }
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('mousedown', (e) => {
            if (e.target.className.includes('btn')) return;
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            
            // ירי רק על המבנים
            const intersects = raycaster.intersectObjects(buildings);
            
            if (intersects.length > 0) {
                const hitBuilding = intersects[0].object;
                launch(intersects[0].point, hitBuilding);
            }
        });

        function launch(target, building) {
            // ... (קוד שיגור נשאר זהה)
            detonate(target, building); // פיצוץ מיידי לצורך הדגמה
        }

        function detonate(pos, building) {
            if (!building || building.destroyed) return;
            building.destroyed = true;

            // שמירת נתונים לשיקום
            const config = {
                x: building.position.x,
                z: building.position.z,
                w: building.geometry.parameters.width,
                h: building.geometry.parameters.height
            };

            // הסרת הבניין מהמערכת
            scene.remove(building);
            buildings = buildings.filter(b => b !== building);

            // יצירת רסיסים מהטקסטורה של הבניין
            const debrisGeo = new THREE.BoxGeometry(3, 3, 3);
            for (let i = 0; i < 30; i++) {
                // כל רסיס מקבל את החומר של הבניין המקורי
                const v = new THREE.Mesh(debrisGeo, building.material);
                v.position.copy(pos);
                scene.add(v);

                const angle = Math.random() * Math.PI * 2;
                v.userData.velocity = new THREE.Vector3(Math.cos(angle)*5, 5+Math.random()*8, Math.sin(angle)*5);
                debris.push(v);
            }
            
            scheduleRegeneration(config);
            // ... (קוד סאונד ופלאש)
        }

        /** 6. אנימציה **/
        function animate() {
            requestAnimationFrame(animate);
            // ... (קוד מצלמה ופיזיקת רסיסים נשאר זהה)
            renderer.render(scene, camera);
        }
        
        // ... (כל שאר הקוד נשאר זהה)
        animate();
    </script>
</body>
</html>
