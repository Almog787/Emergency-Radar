<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuantIntel Pro | Market Terminal</title>
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&family=JetBrains+Mono&display=swap');
        
        body { 
            background-color: #020617; 
            color: #f1f5f9; 
            font-family: 'Assistant', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        /* Watchlist scroll styling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .active-stock {
            background: rgba(59, 130, 246, 0.2) !important;
            border: 1px solid rgba(59, 130, 246, 0.5) !important;
        }

        .tab-active { background: #3b82f6; color: white; }

        /* Chart container needs specific height on mobile */
        #chart-wrapper { height: 400px; }
        @media (min-width: 1024px) { #chart-wrapper { height: 500px; } }

        img#v-chart-img {
            max-width: 100%;
            height: auto;
            object-fit: contain;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="h-16 glass border-b border-white/10 flex items-center justify-between px-4 md:px-8 shrink-0 z-50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-1.5 rounded-lg shadow-lg">
                <i class="fas fa-chart-line text-white text-lg"></i>
            </div>
            <h1 class="font-black text-lg md:text-xl tracking-tighter uppercase italic">QuantIntel <span class="text-blue-500 font-bold">Pro</span></h1>
        </div>

        <div class="flex items-center gap-3 md:gap-6">
            <div class="flex bg-slate-800 rounded-lg p-1 border border-white/5">
                <button onclick="setLang('en')" id="btn-en" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all bg-blue-600 text-white">EN</button>
                <button onclick="setLang('he')" id="btn-he" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all text-slate-400">עב</button>
            </div>
        </div>
    </header>

    <!-- Layout Container -->
    <div class="flex flex-col lg:flex-row flex-1 overflow-hidden lg:overflow-visible">
        
        <!-- Sidebar / Topbar for Mobile -->
        <aside class="w-full lg:w-80 bg-slate-950 border-b lg:border-b-0 lg:border-r border-white/5 flex flex-col shrink-0">
            <div class="p-3 bg-slate-900/50 lg:block hidden border-b border-white/5">
                <span class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Market Watchlist</span>
            </div>
            <!-- scrollable list -->
            <div id="rankings-list" class="flex lg:flex-col overflow-x-auto lg:overflow-y-auto no-scrollbar p-2 gap-2 lg:p-3">
                <!-- Data injected by JS -->
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 space-y-6 overflow-y-auto">
            
            <!-- Price Summary -->
            <div class="glass p-5 md:p-8 rounded-3xl flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4 md:gap-8 w-full md:w-auto justify-between md:justify-start">
                    <div>
                        <h2 id="v-symbol" class="text-4xl md:text-6xl font-black italic tracking-tighter">---</h2>
                        <div id="v-name" class="text-slate-500 text-[10px] md:text-xs font-bold uppercase truncate max-w-[150px]">Select Asset</div>
                    </div>
                    <div class="text-right md:text-left px-4 md:border-l border-white/10">
                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-1" id="ui-price-label">Price</div>
                        <div id="v-price" class="text-xl md:text-3xl font-bold mono">---</div>
                    </div>
                </div>
                <div class="flex items-center justify-between w-full md:w-auto gap-8 border-t border-white/5 pt-4 md:border-0 md:pt-0">
                    <div class="text-center">
                        <div class="text-[10px] text-slate-500 uppercase font-bold mb-1" id="ui-score-label">AI Health</div>
                        <div id="v-score" class="text-3xl md:text-5xl font-black text-blue-500">--</div>
                    </div>
                </div>
            </div>

            <!-- Switcher & Chart -->
            <div class="space-y-4">
                <div class="flex gap-2 bg-slate-900/80 p-1 rounded-xl w-fit">
                    <button onclick="switchChartView('interactive')" id="tab-interactive" class="px-4 py-2 text-[10px] md:text-xs font-bold rounded-lg transition-all tab-active">Interactive</button>
                    <button onclick="switchChartView('static')" id="tab-static" class="px-4 py-2 text-[10px] md:text-xs font-bold rounded-lg transition-all text-slate-500">Institutional</button>
                </div>

                <div class="glass rounded-[2rem] p-1 shadow-2xl bg-slate-900/40 relative overflow-hidden" id="chart-wrapper">
                    <div id="interactive-chart" class="w-full h-full"></div>
                    <div id="static-chart" class="hidden w-full h-full flex items-center justify-center p-2 md:p-6">
                        <img id="v-chart-img" src="" alt="Analysis">
                    </div>
                </div>
            </div>

            <!-- Footer Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="glass p-5 rounded-3xl">
                    <h4 class="text-[10px] text-slate-500 uppercase font-bold mb-3 tracking-widest" id="ui-signals-label">Intelligence Signals</h4>
                    <div id="v-signals" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="glass p-5 rounded-3xl flex items-center border-l-4 border-blue-600">
                    <p id="ui-disclaimer" class="text-[10px] text-slate-400 leading-relaxed italic">
                        Real-time quantitative analysis synced via GitHub Actions.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const i18n = {
            en: { price: "Price", score: "AI Score", signals: "Signals", interactive: "Interactive", static: "Institutional", dir: "ltr" },
            he: { price: "מחיר", score: "ציון AI", signals: "איתותים", interactive: "אינטראקטיבי", static: "ניתוח מוסדי", dir: "rtl" }
        };

        let currentLang = 'en', chart, candleSeries, currentRankings = [], activeSymbol = '';

        async function init() {
            try {
                const res = await fetch('data/market_rankings.json?v=' + Date.now());
                currentRankings = await res.json();
                renderWatchlist();
                if(currentRankings.length) loadStock(currentRankings[0]);
                
                updateClock();
                setInterval(updateClock, 1000);
            } catch (e) {
                console.error("Data syncing...");
            }
        }

        function setLang(lang) {
            currentLang = lang;
            document.documentElement.dir = i18n[lang].dir;
            document.getElementById('ui-price-label').innerText = i18n[lang].price;
            document.getElementById('ui-score-label').innerText = i18n[lang].score;
            document.getElementById('ui-signals-label').innerText = i18n[lang].signals;
            document.getElementById('tab-interactive').innerText = i18n[lang].interactive;
            document.getElementById('tab-static').innerText = i18n[lang].static;
            
            document.getElementById('btn-en').className = lang === 'en' ? "px-3 py-1 text-[10px] font-bold rounded-md bg-blue-600 text-white" : "px-3 py-1 text-[10px] font-bold rounded-md text-slate-400";
            document.getElementById('btn-he').className = lang === 'he' ? "px-3 py-1 text-[10px] font-bold rounded-md bg-blue-600 text-white" : "px-3 py-1 text-[10px] font-bold rounded-md text-slate-400";
            
            renderWatchlist();
            if(activeSymbol) {
                const s = currentRankings.find(x => x.symbol === activeSymbol);
                updateSignalsUI(s);
            }
        }

        function renderWatchlist() {
            const list = document.getElementById('rankings-list');
            list.innerHTML = currentRankings.map(s => {
                const isActive = s.symbol === activeSymbol;
                return `
                <div onclick="loadStockByName('${s.symbol}')" class="flex-shrink-0 w-32 lg:w-full p-3 lg:p-4 rounded-2xl lg:rounded-none lg:border-b border-white/5 cursor-pointer hover:bg-white/5 transition flex flex-col lg:flex-row lg:justify-between lg:items-center glass lg:bg-transparent ${isActive ? 'active-stock' : ''}">
                    <div class="mb-1 lg:mb-0">
                        <div class="text-white font-black text-sm lg:text-lg">${s.symbol}</div>
                        <div class="text-[8px] lg:text-[9px] text-slate-500 font-bold uppercase truncate">${s.name}</div>
                    </div>
                    <div class="text-left lg:text-right flex lg:flex-col justify-between items-center lg:items-end">
                        <div class="text-[10px] lg:text-xs font-bold text-blue-400">${s.score}</div>
                        <div class="text-[8px] lg:text-[10px] ${s.change >= 0 ? 'text-emerald-500' : 'text-rose-500'} font-black">${s.change >= 0 ? '+' : ''}${s.change.toFixed(1)}%</div>
                    </div>
                </div>
            `}).join('');
        }

        async function loadStockByName(sym) {
            const stock = currentRankings.find(x => x.symbol === sym);
            loadStock(stock);
        }

        async function loadStock(s) {
            activeSymbol = s.symbol;
            renderWatchlist();

            document.getElementById('v-symbol').innerText = s.symbol;
            document.getElementById('v-name').innerText = s.name;
            document.getElementById('v-price').innerText = `$${s.price.toFixed(2)}`;
            document.getElementById('v-score').innerText = s.score;
            
            document.getElementById('v-chart-img').src = `charts/${s.symbol.toLowerCase()}.png?v=${Date.now()}`;
            updateSignalsUI(s);

            const res = await fetch(`data/${s.symbol.toLowerCase()}_daily.json?v=` + Date.now());
            const detail = await res.json();
            renderInteractiveChart(detail.history);
        }

        function updateSignalsUI(s) {
            const signals = currentLang === 'en' ? s.signals.en : s.signals.he;
            document.getElementById('v-signals').innerHTML = signals.map(sig => 
                `<span class="bg-blue-600/20 text-blue-400 text-[9px] md:text-[10px] px-2 py-1 rounded-lg border border-blue-500/20 font-bold">${sig}</span>`
            ).join('');
        }

        function renderInteractiveChart(data) {
            const container = document.getElementById('interactive-chart');
            container.innerHTML = '';
            
            chart = LightweightCharts.createChart(container, {
                layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#94a3b8', fontSize: 10 },
                grid: { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
                timeScale: { borderColor: 'rgba(255,255,255,0.1)', fixLeftEdge: true, fixRightEdge: true },
                rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)' },
                handleScroll: { vertTouchDrag: false }, // disable vertical scroll for easier mobile use
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#10b981', downColor: '#f43f5e', borderVisible: false, wickUpColor: '#10b981', wickDownColor: '#f43f5e'
            });

            // Format data: ensure time is YYYY-MM-DD
            const formatted = data.map(d => ({
                time: d.Date.split(' ')[0],
                open: parseFloat(d.Open),
                high: parseFloat(d.High),
                low: parseFloat(d.Low),
                close: parseFloat(d.Close)
            }));

            candleSeries.setData(formatted);
            chart.timeScale().fitContent();
        }

        function switchChartView(view) {
            const interactive = document.getElementById('interactive-chart');
            const staticChart = document.getElementById('static-chart');
            const btnInt = document.getElementById('tab-interactive');
            const btnStat = document.getElementById('tab-static');

            if(view === 'interactive') {
                interactive.classList.remove('hidden');
                staticChart.classList.add('hidden');
                btnInt.classList.add('tab-active');
                btnStat.classList.remove('tab-active');
                if(chart) chart.resize(interactive.clientWidth, interactive.clientHeight);
            } else {
                interactive.classList.add('hidden');
                staticChart.classList.remove('hidden');
                btnStat.classList.add('tab-active');
                btnInt.classList.remove('tab-active');
            }
        }

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB');
        }

        window.onresize = () => {
            if(chart) {
                const wrapper = document.getElementById('chart-wrapper');
                chart.resize(wrapper.clientWidth - 10, wrapper.clientHeight - 10);
            }
        };

        init();
    </script>
</body>
</html>
