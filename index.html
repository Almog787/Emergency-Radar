<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-Light Pro - Stable Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        
        :root {
            --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #0f172a;
            --border-color: #cbd5e1; --primary: #2563eb;
            --gantt-line: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-main: #f8fafc;
            --border-color: #334155; --primary: #3b82f6;
            --gantt-line: #334155;
        }

        body { font-family: 'Assistant', sans-serif; background-color: var(--bg-body); color: var(--text-main); transition: all 0.2s; }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* Utility */
        .hidden { display: none; }
        .tab-btn.active { border-bottom: 3px solid var(--primary); color: var(--primary); font-weight: 800; background: rgba(37,99,235,0.05); }
        
        /* Gantt Specifics */
        .gantt-wrapper { overflow-x: auto; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 0.5rem; position: relative; }
        .gantt-header { display: flex; position: sticky; top: 0; z-index: 20; background: var(--bg-body); border-bottom: 1px solid var(--border-color); }
        .gantt-row { display: flex; height: 50px; position: relative; border-bottom: 1px solid var(--gantt-line); align-items: center; }
        .gantt-label { width: 140px; flex-shrink: 0; position: sticky; right: 0; background: var(--bg-card); z-index: 10; border-left: 2px solid var(--border-color); font-weight: bold; padding: 0 10px; font-size: 0.85rem; }
        .gantt-timeline { position: relative; flex-grow: 1; min-width: 1080px; height: 100%; }
        
        .gantt-block {
            position: absolute; height: 70%; top: 15%; border-radius: 4px;
            font-size: 10px; color: white; display: flex; align-items: center; justify-content: center;
            overflow: hidden; white-space: nowrap; cursor: grab; z-index: 1;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); user-select: none;
        }
        .gantt-block:active { cursor: grabbing; transform: scale(1.02); z-index: 50; }
        
        /* Conflict Animation */
        .conflict { background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #b91c1c 10px, #b91c1c 20px) !important; animation: flash 1s infinite; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Colors */
        .bg-insp { background: #3b82f6; } .bg-travel { background: #f59e0b; }
        .bg-anchor { background: #8b5cf6; } .bg-admin { background: #64748b; }
    </style>
</head>
<body data-theme="light">

    <!-- Navbar -->
    <header class="bg-slate-900 text-white p-3 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <h1 class="font-black italic text-lg tracking-wide">R-LIGHT <span class="text-blue-400">STABLE v5</span></h1>
        </div>
        <div class="flex gap-2 text-xs">
            <button onclick="toggleTheme()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition">ğŸŒ“ ×¢×¨×›×ª × ×•×©×</button>
            <button onclick="hardReset()" class="bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded transition font-bold">âš ï¸ ××™×¤×•×¡ ××œ×</button>
        </div>
    </header>

    <nav class="bg-card border-b border-color sticky top-[52px] z-40 flex overflow-x-auto shadow-sm">
        <button onclick="switchTab('dashboard')" id="btn-dashboard" class="tab-btn active flex-1 py-3 px-4 text-sm font-bold transition whitespace-nowrap">×œ×•×— ×‘×§×¨×”</button>
        <button onclick="switchTab('gantt')" id="btn-gantt" class="tab-btn flex-1 py-3 px-4 text-sm font-bold transition whitespace-nowrap">×’×× ×˜ (×¢×¨×™×›×”)</button>
        <button onclick="switchTab('data')" id="btn-data" class="tab-btn flex-1 py-3 px-4 text-sm font-bold transition whitespace-nowrap">×˜×‘×œ×” ×•× ×ª×•× ×™×</button>
        <button onclick="switchTab('settings')" id="btn-settings" class="tab-btn flex-1 py-3 px-4 text-sm font-bold transition whitespace-nowrap">××™×œ×•×¦×™×</button>
    </nav>

    <main class="container mx-auto p-4 max-w-7xl min-h-screen">
        
        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="card p-5">
                    <h2 class="font-bold text-lg mb-2">âš¡ ××—×•×œ×œ ×©×™×‘×•×¥</h2>
                    <p class="text-xs text-gray-500 mb-3">×œ×—×™×¦×” ×ª××—×§ ××ª ×”×©×™×‘×•×¥ ×”×§×™×™× ×•×ª×™×¦×•×¨ ×—×“×©.</p>
                    <label class="block text-xs font-bold mb-1">×ª××¨×™×š ×”×ª×—×œ×”:</label>
                    <input type="date" id="start-date" class="w-full border p-2 rounded mb-3 bg-gray-50 text-black">
                    <button onclick="runEngine()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition">×‘×¦×¢ ×©×™×‘×•×¥ ×©×‘×•×¢×™</button>
                </div>
                
                <div class="card p-5">
                    <h2 class="font-bold text-lg mb-2 text-red-600">ğŸš¨ ×¡×˜×˜×•×¡ ××¢×¨×›×ª</h2>
                    <div id="sys-status" class="text-sm bg-gray-100 p-2 rounded h-24 overflow-y-auto text-gray-700">×××ª×™×Ÿ ×œ×¤×¢×•×œ×”...</div>
                </div>

                <div class="card p-5 flex flex-col justify-center items-center bg-slate-800 text-white">
                    <div class="text-4xl font-black text-blue-400" id="total-tasks">0</div>
                    <div class="text-xs uppercase tracking-widest opacity-70">××©×™××•×ª × ×•×¦×¨×•</div>
                </div>
            </div>
        </div>

        <!-- GANTT -->
        <div id="tab-gantt" class="hidden space-y-4">
            <div class="flex justify-between items-center card p-3">
                <h2 class="font-bold">×ª×¨×©×™× ×’×× ×˜ (Drag & Drop)</h2>
                <select id="gantt-day" onchange="renderGantt()" class="border p-1 rounded font-bold text-blue-600 bg-white text-black"></select>
            </div>
            
            <div class="gantt-wrapper shadow-lg">
                <div id="gantt-header" class="gantt-header"></div>
                <div id="gantt-body"></div>
            </div>

            <div class="flex flex-wrap gap-3 justify-center text-xs font-bold text-gray-500">
                <span class="flex items-center gap-1"><i class="w-3 h-3 rounded bg-insp"></i> ×‘×§×¨×”</span>
                <span class="flex items-center gap-1"><i class="w-3 h-3 rounded bg-travel"></i> × ×¡×™×¢×”</span>
                <span class="flex items-center gap-1"><i class="w-3 h-3 rounded bg-anchor"></i> ×¢×•×’×Ÿ</span>
                <span class="flex items-center gap-1"><i class="w-3 h-3 rounded bg-admin"></i> ×× ×”×œ×”</span>
                <span class="flex items-center gap-1"><i class="w-3 h-3 rounded conflict"></i> ×”×ª× ×’×©×•×ª</span>
            </div>
        </div>

        <!-- DATA TABLES -->
        <div id="tab-data" class="hidden space-y-6">
            <div class="card overflow-hidden">
                <div class="p-3 bg-slate-100 dark:bg-slate-800 font-bold border-b border-color flex justify-between">
                    <span>ğŸ“‹ ×˜×‘×œ×ª ×©×™×‘×•×¥ ××œ××”</span>
                    <button onclick="exportCSV()" class="text-xs bg-slate-700 text-white px-2 py-1 rounded">Excel Export</button>
                </div>
                <div class="overflow-x-auto max-h-[400px]">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-slate-800 text-white sticky top-0">
                            <tr><th class="p-3">×™×•×</th><th class="p-3">×‘×§×¨</th><th class="p-3">××©×™××”</th><th class="p-3">××™×§×•×</th><th class="p-3">×©×¢×•×ª</th></tr>
                        </thead>
                        <tbody id="schedule-body" class="divide-y divide-color"></tbody>
                    </table>
                </div>
            </div>

            <div class="card overflow-hidden">
                <div class="p-3 bg-slate-100 dark:bg-slate-800 font-bold border-b border-color">ğŸ“Š ×™×¢×“×™ ×ª×—× ×•×ª (KPI)</div>
                <table class="w-full text-sm text-right">
                    <thead class="bg-slate-200 dark:bg-slate-900 text-gray-700 dark:text-gray-200">
                        <tr><th class="p-3">×ª×—× ×”</th><th class="p-3 text-center">×™×¢×“</th><th class="p-3 text-center">×‘×•×¦×¢</th><th class="p-3 w-1/3">×‘×¨</th></tr>
                    </thead>
                    <tbody id="kpi-body" class="divide-y divide-color"></tbody>
                </table>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="tab-settings" class="hidden space-y-6">
            <div class="card p-4">
                <h3 class="font-bold mb-3">âš“ ×”×•×¡×¤×ª ×¢×•×’×Ÿ ×™×“× ×™</h3>
                <div class="flex flex-wrap gap-2 items-end">
                    <select id="anc-insp" class="border p-2 rounded bg-white text-black text-sm"></select>
                    <select id="anc-day" class="border p-2 rounded bg-white text-black text-sm">
                        <option value="0">×¨××©×•×Ÿ</option><option value="1">×©× ×™</option><option value="2">×©×œ×™×©×™</option><option value="3">×¨×‘×™×¢×™</option><option value="4">×—××™×©×™</option><option value="5">×©×™×©×™</option><option value="6">×©×‘×ª</option>
                    </select>
                    <input type="time" id="anc-time" class="border p-2 rounded bg-white text-black text-sm">
                    <select id="anc-station" class="border p-2 rounded bg-white text-black text-sm"></select>
                    <button onclick="addAnchor()" class="bg-purple-600 text-white px-4 py-2 rounded text-sm font-bold">×”×•×¡×£</button>
                </div>
                <div id="anchor-list" class="mt-4 flex flex-wrap gap-2"></div>
            </div>

            <div class="card overflow-hidden">
                <div class="p-3 bg-slate-100 dark:bg-slate-800 font-bold">ğŸ¥ ×”×™×¢×“×¨×•×™×•×ª</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center text-sm">
                        <thead class="bg-slate-900 text-white"><tr><th class="p-3 text-right">×‘×§×¨</th><th>×</th><th>×‘</th><th>×’</th><th>×“</th><th>×”</th><th>×•</th><th>×©</th></tr></thead>
                        <tbody id="constraints-body" class="divide-y divide-color"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        /**
         * STABLE CORE V5.0
         * Uses Integer Math (Minutes) instead of Strings to prevent infinite loops.
         * Optimized Rendering (innerHTML once).
         */

        // --- Data ---
        const inspectors = [
            {n:"×“× ×™××œ ××‘×¨×”×", s:"morning", base:"×ª× ×¤×ª"}, {n:"×¨×•× ×™×ª ×œ×•×™", s:"morning", base:"×”×§×•×××™×•×ª"},
            {n:"×™×•×¡×™ ×›×”×Ÿ", s:"morning", base:"××œ×™×¤×œ×˜"}, {n:"××™×›×œ ×©×—×¨", s:"morning", base:"×©××•×œ ×”××œ×š"},
            {n:"××‘×™ ×‘×™×˜×•×Ÿ", s:"morning", base:"×‘×Ÿ ×’×•×¨×™×•×Ÿ"}, {n:"×©×¨×” ×’×•×œ×Ÿ", s:"morning", base:"×™×•×¡×¤×˜×œ"},
            {n:"×¢×•××¨ ×¤×¨×¥", s:"morning", base:"×§×¨×™×ª ××¨×™×”"}, {n:"× ×•×¢×” ×§×™×¨×œ", s:"morning", base:"×‘×œ×¤×•×¨"},
            {n:"××œ×™×¨×Ÿ ×¡×‘×’", s:"evening", base:"×ª× ×¤×ª"}, {n:"×’×œ×™×ª ×“×™×¡×˜×œ", s:"evening", base:"×”×§×•×××™×•×ª"},
            {n:"××©×” ××©×›× ×–×™", s:"evening", base:"××¨×œ×•×–×•×¨×•×‘"}, {n:"×“× ×” ×¤×¨×™×“×¨", s:"evening", base:"××œ× ×‘×™"},
            {n:"×’×™× ×–×•-××¨×¥", s:"evening", base:"×§×¨×™×ª ××¨×™×”"}, {n:"×¨×•×ª× ×¡×œ×¢", s:"evening", base:"×™×¤×•"},
            {n:"××¡×™ ×¢×–×¨", s:"evening", base:"×©××•×œ ×”××œ×š"}
        ];

        const stations = [
            {n:"×ª× ×¤×ª",g:1,t:20}, {n:"×¤×™× ×¡×§×¨",g:2,t:20}, {n:"×§×¨×™×ª ××¨×™×”",g:4,t:25}, {n:"×©× ×§×¨",g:6,t:20},
            {n:"××”×¨×•× ×•×‘×™×¥",g:9,t:30}, {n:"×‘×Ÿ ×’×•×¨×™×•×Ÿ",g:11,t:30}, {n:"×‘×™××œ×™×§",g:12,t:30}, {n:"××¨×œ×•×–×•×¨×•×‘",g:14,t:35},
            {n:"×©××•×œ ×”××œ×š",g:15,t:35}, {n:"×§×¨×œ×™×‘×š",g:17,t:30}, {n:"××œ× ×‘×™",g:18,t:30}, {n:"××œ×™×¤×œ×˜",g:19,t:25},
            {n:"×‘×œ×•××¤×™×œ×“",g:21,t:20}, {n:"×™×¤×•",g:23,t:20}, {n:"×™×•×¡×¤×˜×œ",g:28,t:25}, {n:"×‘×œ×¤×•×¨",g:30,t:25},
            {n:"×‘× ×™××™×Ÿ",g:31,t:25}, {n:"×”×§×•×××™×•×ª",g:34,t:25}
        ];

        const days = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];

        let appData = {
            startDate: new Date().toISOString().split('T')[0],
            tasks: [],
            constraints: {}, // "Name_Date": true
            anchors: [],
            theme: 'light'
        };

        // --- Init ---
        window.onload = () => {
            try {
                const saved = localStorage.getItem('rail_stable_v5');
                if(saved) appData = JSON.parse(saved);
                
                document.getElementById('start-date').value = appData.startDate;
                document.body.setAttribute('data-theme', appData.theme);
                
                // Fill Selects
                const inspOpts = inspectors.map(i=>`<option>${i.n}</option>`).join('');
                const stOpts = stations.map(s=>`<option>${s.n}</option>`).join('');
                const dayOpts = days.map((d,i)=>`<option value="${i}">${d}</option>`).join('');
                
                document.getElementById('anc-insp').innerHTML = inspOpts;
                document.getElementById('anc-station').innerHTML = stOpts;
                document.getElementById('gantt-day').innerHTML = dayOpts;

                renderAll();
            } catch (e) {
                console.error("Init Error", e);
                hardReset();
            }
        };

        function saveData() {
            appData.startDate = document.getElementById('start-date').value;
            localStorage.setItem('rail_stable_v5', JSON.stringify(appData));
        }

        // --- Core Engine (Integer Math) ---
        function runEngine() {
            const status = document.getElementById('sys-status');
            status.innerHTML = "ğŸ”„ ××¢×‘×“...";
            
            // Allow UI to update before freezing for calc
            setTimeout(() => {
                try {
                    appData.tasks = []; // Clear old
                    const startDt = new Date(document.getElementById('start-date').value);
                    
                    // Pre-calculate counts map
                    let counts = {};
                    stations.forEach(s => counts[s.n] = 0);

                    // Loop 7 days
                    for(let d=0; d<7; d++) {
                        const dateStr = new Date(startDt.getTime() + d*86400000).toISOString().split('T')[0];
                        
                        inspectors.forEach(insp => {
                            if(appData.constraints[`${insp.n}_${dateStr}`]) return; // Skip if sick

                            // Convert times to minutes (06:00 = 360)
                            let time = insp.s === "morning" ? 360 : 840; // 06:00 or 14:00
                            const end = insp.s === "morning" ? 870 : 1350; // 14:30 or 22:30
                            let loc = insp.base;

                            // Get daily anchors sorted by time
                            const dailyAncs = appData.anchors
                                .filter(a => a.insp === insp.n && parseInt(a.day) === d)
                                .map(a => ({...a, mins: timeToMins(a.timeStr)}))
                                .sort((a,b) => a.mins - b.mins);

                            let safety = 0;
                            while(time < end && safety < 50) {
                                safety++;
                                
                                // 1. Check Anchors
                                const nextAnc = dailyAncs.find(a => a.mins >= time);
                                if(nextAnc) {
                                    const travel = getTravel(loc, nextAnc.stat);
                                    if(time + travel + 15 >= nextAnc.mins) {
                                        // Must go to anchor
                                        if(loc !== nextAnc.stat) {
                                            pushTask(d, dateStr, insp.n, "× ×™×•×“", nextAnc.stat, time, travel, "travel");
                                            time += travel;
                                        }
                                        if(time < nextAnc.mins) {
                                            pushTask(d, dateStr, insp.n, "×”××ª× ×”", nextAnc.stat, time, nextAnc.mins - time, "admin");
                                            time = nextAnc.mins;
                                        }
                                        pushTask(d, dateStr, insp.n, "×¢×•×’×Ÿ", nextAnc.stat, time, 45, "anchor");
                                        counts[nextAnc.stat]++;
                                        time += 45;
                                        loc = nextAnc.stat;
                                        continue;
                                    }
                                }

                                // 2. Regular Logic
                                const nextSt = findBest(loc, counts);
                                const travel = getTravel(loc, nextSt.n);
                                
                                // If enough time before anchor
                                if(nextAnc && time + travel + 30 > nextAnc.mins) {
                                    pushTask(d, dateStr, insp.n, "×”××ª× ×”", loc, time, 15, "admin");
                                    time += 15;
                                } else {
                                    if(travel > 5) {
                                        pushTask(d, dateStr, insp.n, "× ×¡×™×¢×”", nextSt.n, time, travel, "travel");
                                        time += travel;
                                    }
                                    pushTask(d, dateStr, insp.n, "×‘×§×¨×ª ×ª×—× ×”", nextSt.n, time, 30, "insp");
                                    counts[nextSt.n]++;
                                    time += 30;
                                    loc = nextSt.n;
                                }
                            }

                            // Fill rest
                            if(time < end) {
                                pushTask(d, dateStr, insp.n, "×¡×’×™×¨×”", "××©×¨×“", time, end-time, "admin");
                            }
                        });
                    }
                    
                    saveData();
                    renderAll();
                    status.innerHTML = `<span class="text-green-600 font-bold">âœ“ ×©×™×‘×•×¥ ×”×•×©×œ× ×‘×”×¦×œ×—×”!</span>`;
                    switchTab('gantt');

                } catch (e) {
                    status.innerHTML = `<span class="text-red-600 font-bold">âŒ ×©×’×™××”: ${e.message}</span>`;
                    console.error(e);
                }
            }, 50);
        }

        function findBest(currLoc, counts) {
            let best = stations[0], min = Infinity;
            const cGeo = stations.find(s=>s.n===currLoc)?.g || 1;
            
            stations.forEach(s => {
                if(s.n === currLoc) return;
                // Score: Distance * 2 + Visits * 10. Low is better.
                const score = Math.abs(s.g - cGeo)*2 + (counts[s.n]||0)*10;
                if(score < min) { min = score; best = s; }
            });
            return best;
        }

        function getTravel(l1, l2) {
            const s1 = stations.find(s=>s.n===l1), s2 = stations.find(s=>s.n===l2);
            if(!s1 || !s2) return 15; // Safe default
            return Math.abs(s1.g - s2.g)*3 + 5;
        }

        function pushTask(dIdx, date, insp, typeName, loc, startMins, dur, typeCode) {
            if(dur <= 0) return;
            appData.tasks.push({
                id: Date.now() + Math.random(),
                dIdx, date, insp, task: typeName, loc,
                start: startMins, dur, type: typeCode,
                end: startMins + dur
            });
        }

        // --- Rendering ---
        function renderAll() {
            renderGantt();
            renderTable();
            renderStats();
            renderConstraints();
            renderAnchors();
            document.getElementById('total-tasks').innerText = appData.tasks.length;
        }

        function renderGantt() {
            const dayIdx = parseInt(document.getElementById('gantt-day').value);
            const header = document.getElementById('gantt-header');
            const body = document.getElementById('gantt-body');
            
            // Header (06:00 - 23:00)
            const pxPerMin = 1.2; 
            const startHour = 6;
            
            let headHtml = `<div class="gantt-label flex items-center bg-slate-100 dark:bg-slate-800">×‘×§×¨</div>`;
            for(let h=6; h<=23; h++) {
                headHtml += `<div style="flex:0 0 72px; text-align:center; font-size:10px; border-right:1px solid var(--border-color);">${h}:00</div>`;
            }
            header.innerHTML = headHtml;

            // Body
            const dateStr = new Date(new Date(appData.startDate).getTime() + dayIdx*86400000).toISOString().split('T')[0];
            
            body.innerHTML = inspectors.map(i => {
                const isSick = appData.constraints[`${i.n}_${dateStr}`];
                const tasks = appData.tasks.filter(t => t.dIdx === dayIdx && t.insp === i.n);
                
                // Conflicts check
                const conflictIds = [];
                for(let x=0; x<tasks.length; x++) {
                    for(let y=x+1; y<tasks.length; y++) {
                        if(tasks[x].start < tasks[y].end && tasks[x].end > tasks[y].start) {
                            conflictIds.push(tasks[x].id, tasks[y].id);
                        }
                    }
                }

                let html = `<div class="gantt-row ${isSick?'bg-red-50 opacity-50':''}" 
                            ondragover="allowDrop(event)" ondrop="onDrop(event, '${i.n}', ${dayIdx})">
                            <div class="gantt-label flex items-center h-full">${i.n}</div>
                            <div class="gantt-timeline">`;
                
                // Grid
                for(let x=0; x<=17; x++) html += `<div style="position:absolute; left:${x*72}px; height:100%; border-right:1px dashed var(--gantt-line);"></div>`;

                if(!isSick) {
                    html += tasks.map(t => {
                        const left = (t.start - 360) * pxPerMin;
                        const width = t.dur * pxPerMin;
                        const bg = conflictIds.includes(t.id) ? 'conflict' : `bg-${t.type}`;
                        
                        return `<div class="gantt-block ${bg}" 
                                style="left:${left}px; width:${width}px;"
                                draggable="true" ondragstart="drag(event, ${t.id})"
                                title="${t.task} ${minsToTime(t.start)}-${minsToTime(t.end)}">
                                ${width>30 ? t.loc : ''}
                                </div>`;
                    }).join('');
                } else {
                    html += `<div class="absolute inset-0 flex items-center justify-center text-red-500 font-bold text-xs">×—×•×¤×©</div>`;
                }

                return html + `</div></div>`;
            }).join('');
        }

        // --- Drag & Drop ---
        let draggedId = null;
        function drag(ev, id) { draggedId = id; }
        function allowDrop(ev) { ev.preventDefault(); }
        function onDrop(ev, newInsp, dIdx) {
            ev.preventDefault();
            const task = appData.tasks.find(t => t.id === draggedId);
            if(!task) return;

            const rect = ev.currentTarget.querySelector('.gantt-timeline').getBoundingClientRect();
            const x = ev.clientX - rect.left + ev.currentTarget.scrollLeft;
            const pxPerMin = 1.2;
            
            // Calc new start (snap to 15m)
            let newStart = 360 + (x / pxPerMin);
            newStart = Math.round(newStart / 15) * 15;
            
            task.insp = newInsp;
            task.dIdx = dIdx;
            task.start = newStart;
            task.end = newStart + task.dur;
            
            saveData();
            renderAll();
        }

        // --- Tables ---
        function renderTable() {
            const html = appData.tasks.map(t => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 border-b border-color">
                    <td class="p-2">${days[t.dIdx]}</td><td class="p-2 font-bold">${t.insp}</td>
                    <td class="p-2">${t.task}</td><td class="p-2">${t.loc}</td>
                    <td class="p-2 font-mono">${minsToTime(t.start)}-${minsToTime(t.end)}</td>
                </tr>`).join('');
            document.getElementById('schedule-body').innerHTML = html;
        }

        function renderStats() {
            const counts = {};
            stations.forEach(s => counts[s.n]=0);
            appData.tasks.forEach(t => { if(t.type==='insp' && counts[t.loc]!==undefined) counts[t.loc]++; });

            document.getElementById('kpi-body').innerHTML = stations.map(s => {
                const act = counts[s.n];
                const pct = Math.min(100, Math.round((act/s.t)*100));
                return `<tr class="border-b border-color">
                    <td class="p-2 font-bold">${s.n}</td><td class="p-2 text-center text-gray-400">${s.t}</td>
                    <td class="p-2 text-center font-bold">${act}</td>
                    <td class="p-2"><div class="w-full h-2 bg-gray-200 rounded"><div style="width:${pct}%" class="h-full rounded ${pct<80?'bg-red-500':'bg-green-500'}"></div></div></td>
                </tr>`;
            }).join('');
        }

        function renderConstraints() {
            const startT = new Date(appData.startDate).getTime();
            document.getElementById('constraints-body').innerHTML = inspectors.map(i => {
                let html = `<tr class="border-b border-color hover:bg-slate-50 dark:hover:bg-slate-800"><td class="p-2 font-bold text-right bg-card sticky left-0 border-l border-color">${i.n}</td>`;
                for(let d=0; d<7; d++) {
                    const date = new Date(startT + d*86400000).toISOString().split('T')[0];
                    const k = `${i.n}_${date}`;
                    html += `<td class="p-2 border-l border-color"><input type="checkbox" ${appData.constraints[k]?'checked':''} onchange="toggleConst('${k}')"></td>`;
                }
                return html + `</tr>`;
            }).join('');
        }
        function toggleConst(k) { 
            if(appData.constraints[k]) delete appData.constraints[k]; else appData.constraints[k]=true; 
            saveData(); renderGantt(); 
        }

        function renderAnchors() {
            document.getElementById('anchor-list').innerHTML = appData.anchors.map(a => 
                `<div class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-bold flex gap-2 items-center">
                    âš“ ${a.insp} ${days[a.day]} ${a.timeStr}
                    <button onclick="delAnchor(${a.id})" class="text-red-500">Ã—</button>
                </div>`
            ).join('');
        }
        function addAnchor() {
            const t = document.getElementById('anc-time').value;
            if(!t) return;
            appData.anchors.push({
                id: Date.now(),
                insp: document.getElementById('anc-insp').value,
                day: document.getElementById('anc-day').value,
                timeStr: t,
                stat: document.getElementById('anc-station').value
            });
            saveData(); renderAnchors();
        }
        function delAnchor(id) { appData.anchors = appData.anchors.filter(a=>a.id!==id); saveData(); renderAnchors(); }

        // --- Helpers ---
        function timeToMins(s) { let [h,m]=s.split(':').map(Number); return h*60+m; }
        function minsToTime(m) { 
            let h = Math.floor(m/60), n = Math.floor(m%60); 
            return `${h.toString().padStart(2,'0')}:${n.toString().padStart(2,'0')}`; 
        }
        function switchTab(id) {
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${id}`).classList.add('active');
            if(id==='gantt') renderGantt();
        }
        function toggleTheme() {
            appData.theme = appData.theme==='light'?'dark':'light';
            document.body.setAttribute('data-theme', appData.theme);
            saveData();
        }
        function hardReset() { if(confirm("×œ××—×•×§ ×”×›×œ?")) { localStorage.removeItem('rail_stable_v5'); location.reload(); } }
        function exportCSV() {
            let csv = "\uFEFF×™×•×,×‘×§×¨,××©×™××”,××™×§×•×,×”×ª×—×œ×”,×¡×™×•×\n" + appData.tasks.map(t => `${days[t.dIdx]},${t.insp},${t.task},${t.loc},${minsToTime(t.start)},${minsToTime(t.end)}`).join('\n');
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); link.download="schedule.csv"; link.click();
        }
    </script>
</body>
</html>
