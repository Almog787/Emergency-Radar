<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Earth Destroyer - Total Annihilation</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; user-select: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; z-index: 100; }
        #weapon-bar { display: flex; justify-content: center; gap: 10px; padding: 30px; pointer-events: auto; background: linear-gradient(transparent, rgba(0,0,0,0.9)); }
        .w-btn { width: 60px; height: 60px; background: #111; border: 2px solid #444; border-radius: 15px; cursor: pointer; font-size: 25px; transition: 0.2s; color: white; display: flex; align-items: center; justify-content: center; }
        .w-btn.active { border-color: #ff3e3e; box-shadow: 0 0 15px #ff3e3e; transform: translateY(-5px); }
        #msg { position: absolute; top: 20px; width: 100%; text-align: center; color: #ff3e3e; font-weight: bold; letter-spacing: 2px; text-shadow: 0 0 10px black; font-size: 18px; }
        #start-overlay { position: absolute; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #start-btn { padding: 20px 60px; font-size: 24px; background: #ff3e3e; border: none; border-radius: 50px; color: white; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="start-overlay">
    <h1 style="color:#ff3e3e; font-size: 40px; margin-bottom: 10px;">EARTH BREAKER</h1>
    <p style="opacity: 0.7;">Click to destroy the crust and reveal the core</p>
    <button id="start-btn" onclick="initGame()">×”×ª×—×œ ×”×©××“×”</button>
</div>

<div id="ui" style="display:none;">
    <div id="msg">INTEGRITY COMPROMISED</div>
    <div id="weapon-bar">
        <button class="w-btn active" onclick="setW('nuke', this)">ğŸš€</button>
        <button class="w-btn" onclick="setW('asteroid', this)">â˜„ï¸</button>
        <button class="w-btn" onclick="setW('laser', this)">âš¡</button>
        <button class="w-btn" onclick="setW('monster', this)">ğŸ‘¾</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

<script>
let scene, camera, renderer, earth, core, clouds;
let weapon = 'nuke', isOver = false, shake = 0;
let minions = [];
const texLoader = new THREE.TextureLoader();

// ×¡××•× ×“
const playSfx = (freq, type, dur) => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(10, ctx.currentTime + dur);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + dur);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + dur);
};

function initGame() {
    document.getElementById('start-overlay').style.display = 'none';
    document.getElementById('ui').style.display = 'flex';

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 3.5;

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    // ×ª××•×¨×”
    scene.add(new THREE.AmbientLight(0x222222));
    const sun = new THREE.DirectionalLight(0xffffff, 1.2);
    sun.position.set(5, 3, 5);
    scene.add(sun);

    // ×œ×™×‘×” ×‘×•×¢×¨×ª (××” ×©×¨×•××™× ×›×©××¤×¨×§×™× ××ª ×”×§×¨×•×)
    core = new THREE.Mesh(
        new THREE.SphereGeometry(0.9, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0xff4400 })
    );
    scene.add(core);

    // ×›×“×•×¨ ×”××¨×¥
    const geo = new THREE.SphereGeometry(1, 100, 100);
    geo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(geo.attributes.position.count * 3), 3));
    const colors = geo.attributes.color;
    for(let i=0; i<colors.count; i++) colors.setXYZ(i, 1, 1, 1);

    const mat = new THREE.MeshStandardMaterial({
        map: texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
        vertexColors: true,
        transparent: true,
        roughness: 0.8
    });

    earth = new THREE.Mesh(geo, mat);
    scene.add(earth);

    // ×¢× × ×™×
    clouds = new THREE.Mesh(
        new THREE.SphereGeometry(1.02, 50, 50),
        new THREE.MeshStandardMaterial({
            map: texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png'),
            transparent: true, opacity: 0.4
        })
    );
    scene.add(clouds);

    window.addEventListener('mousedown', onAttack);
    animate();
}

function setW(t, btn) {
    weapon = t;
    document.querySelectorAll('.w-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function onAttack(e) {
    const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
    const ray = new THREE.Raycaster();
    ray.setFromCamera(mouse, camera);
    const hit = ray.intersectObject(earth);
    if(hit.length > 0) fire(hit[0].point);
}

function fire(pt) {
    if(weapon === 'nuke') {
        playSfx(100, 'sawtooth', 0.5);
        createFireball(pt, 0xffaa00, 0.5);
        decompose(pt, 0.4, 1.0);
        shake = 0.5;
    } else if(weapon === 'asteroid') {
        playSfx(150, 'sine', 0.4);
        createFireball(pt, 0xff4400, 0.3);
        decompose(pt, 0.25, 0.8);
        shake = 0.2;
    } else if(weapon === 'laser') {
        playSfx(800, 'square', 0.1);
        createFireball(pt, 0x00f3ff, 0.1);
        decompose(pt, 0.1, 0.5);
    } else if(weapon === 'monster') {
        playSfx(50, 'sine', 1);
        spawnMinion(pt);
    }
}

// ××¤×§×˜ ×¤×™×¦×•×¥ Mesh ×©× ×¨××” ×œ×¢×™×Ÿ
function createFireball(pt, color, scale) {
    const ball = new THREE.Mesh(
        new THREE.SphereGeometry(0.1, 16, 16),
        new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 1 })
    );
    ball.position.copy(pt);
    scene.add(ball);
    gsap.to(ball.scale, { x: 10 * scale, y: 10 * scale, z: 10 * scale, duration: 0.4 });
    gsap.to(ball.material, { opacity: 0, duration: 0.4, onComplete: () => scene.remove(ball) });
}

// ×× ×•×¢ ×”×”×¨×¡ - ×’×•×¨× ×œ×§×•×“×§×•×“×™× "×œ×”×™×¢×œ×" ×¤× ×™××”
function decompose(pt, radius, strength) {
    const pos = earth.geometry.attributes.position;
    const cols = earth.geometry.attributes.color;
    const v = new THREE.Vector3();
    
    // ×”××¨×” ×—×©×•×‘×”: ×”×¢×‘×¨×ª × ×§×•×“×ª ×”×¤×’×™×¢×” ×œ×§×•××•×¨×“×™× ×˜×•×ª ×”××§×•××™×•×ª ×©×œ ×”×›×“×•×¨ ×”××¡×ª×•×‘×‘
    const localPt = earth.worldToLocal(pt.clone());

    let changed = false;
    for(let i=0; i<pos.count; i++) {
        v.set(pos.getX(i), pos.getY(i), pos.getZ(i));
        const d = v.distanceTo(localPt);
        
        if(d < radius) {
            // ×©××™×‘×ª ×”×§×•×“×§×•×“ ×¤× ×™××” (×™×•×¦×¨ ×—×•×¨)
            const factor = (radius - d) / radius;
            v.multiplyScalar(1 - (factor * strength * 1.2)); 
            
            // ×× ×”×•× ×§×¨×•×‘ ×××•×“ ×œ××¨×›×–, ×”×•× × ×¢×œ× ×œ×’××¨×™
            if(v.length() < 0.91) v.set(0,0,0); 

            pos.setXYZ(i, v.x, v.y, v.z);
            
            // ×¦×‘×™×¢×” ×œ×©×—×•×¨/××“×•×
            cols.setXYZ(i, 0.5, 0, 0); 
            changed = true;
        }
    }
    
    if(changed) {
        pos.needsUpdate = true;
        cols.needsUpdate = true;
        earth.geometry.computeVertexNormals();
        
        // ×¢× × ×™× × ×¢×œ××™× ×‘××–×•×¨ ×”×¤×’×™×¢×”
        const cPos = clouds.geometry.attributes.position;
        for(let i=0; i<cPos.count; i++) {
            v.set(cPos.getX(i), cPos.getY(i), cPos.getZ(i));
            if(v.distanceTo(localPt) < radius) cPos.setXYZ(i, 0, 0, 0);
        }
        cPos.needsUpdate = true;
    }
}

function spawnMinion(pt) {
    for(let i=0; i<5; i++) {
        const m = new THREE.Mesh(
            new THREE.BoxGeometry(0.04, 0.04, 0.04),
            new THREE.MeshBasicMaterial({ color: 0x00ff00 })
        );
        m.position.copy(pt);
        m.userData = {
            v: new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize().multiplyScalar(0.01),
            life: 100 + Math.random() * 200
        };
        scene.add(m);
        minions.push(m);
    }
}

function animate() {
    requestAnimationFrame(animate);

    if(!isOver) {
        earth.rotation.y += 0.002;
        clouds.rotation.y += 0.0025;
        core.rotation.y += 0.001;

        // ×¢×“×›×•×Ÿ ×—×™×™×–×¨×™×
        for(let i = minions.length - 1; i >= 0; i--) {
            const m = minions[i];
            m.position.add(m.userData.v);
            m.position.normalize().multiplyScalar(1.02); // ×”×¦××“×” ×œ×¤× ×™ ×”×©×˜×—
            
            // ×”×—×™×™×–×¨ "××•×›×œ" ××ª ×”××“××” ×ª×—×ª×™×•
            if(Math.random() > 0.8) decompose(m.position, 0.05, 0.2);
            
            m.userData.life--;
            if(m.userData.life <= 0) {
                createFireball(m.position, 0x00ff00, 0.1);
                scene.remove(m);
                minions.splice(i, 1);
            }
        }
    }

    if(shake > 0) {
        camera.position.x = (Math.random()-0.5) * shake;
        camera.position.y = (Math.random()-0.5) * shake;
        shake *= 0.9;
    } else {
        camera.position.x = 0; camera.position.y = 0;
    }

    renderer.render(scene, camera);
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
