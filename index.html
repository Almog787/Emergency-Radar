<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL FUSION | Global Intelligence Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Orbitron:wght@400;900&display=swap');
        
        body { background-color: #020617; margin: 0; overflow: hidden; color: #00f3ff; font-family: 'JetBrains Mono', monospace; }
        .hud-panel { background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(0, 243, 255, 0.2); }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        /* Tactical HUD Elements */
        .scan-line { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 50%, rgba(0, 243, 255, 0.03) 50%); background-size: 100% 4px; pointer-events: none; z-index: 5; }
        .emergency-row { border-right: 3px solid #ff003c; background: rgba(255, 0, 60, 0.1); animation: danger-pulse 2s infinite; }
        
        @keyframes danger-pulse { 0%, 100% { border-color: #ff003c; } 50% { border-color: #7f0000; } }
        
        .weather-badge { background: rgba(59, 130, 246, 0.2); color: #60a5fa; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: bold; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen">

    <div class="scan-line"></div>
    <div id="globeViz" class="absolute inset-0 z-0"></div>

    <!-- UI Overlay -->
    <div class="absolute inset-0 pointer-events-none flex flex-col p-6 z-10">
        
        <!-- Header: Intelligence Status -->
        <header class="flex justify-between items-start mb-6 pointer-events-none">
            <div class="flex items-center gap-6 pointer-events-auto">
                <div class="hud-panel p-4 rounded-2xl border-cyan-500/30 relative">
                    <i class="fas fa-crosshairs text-2xl text-cyan-400"></i>
                    <span class="absolute -top-1 -right-1 flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-cyan-500"></span>
                    </span>
                </div>
                <div>
                    <h1 class="orbitron text-2xl font-black text-white tracking-widest uppercase italic">Tactical_Fusion</h1>
                    <p class="text-[9px] font-bold text-cyan-500 opacity-70 uppercase tracking-[0.3em]">Intelligence Correlation Hub v12.0</p>
                </div>
            </div>

            <div class="hud-panel px-6 py-2 rounded-xl text-right pointer-events-auto">
                <div id="clock" class="orbitron text-xl font-bold text-white">00:00:00</div>
                <div class="flex items-center justify-end gap-2 mt-1">
                    <span id="data-status" class="text-[7px] text-emerald-400 font-black uppercase tracking-widest">Linked: Multispectral</span>
                </div>
            </div>
        </header>

        <div class="flex-1 flex gap-6 overflow-hidden">
            <!-- Sidebar: Correlated Feed -->
            <aside class="w-80 flex flex-col gap-6 pointer-events-auto overflow-hidden">
                <div class="hud-panel rounded-3xl flex-1 flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-white/5 bg-cyan-950/20 flex justify-between items-center">
                        <span class="text-xs font-black uppercase tracking-widest text-cyan-400">Threat_Analysis</span>
                        <div class="flex gap-2">
                            <span id="stat-7700" class="text-red-500 text-xs font-bold">0</span>
                            <span id="stat-quakes" class="text-orange-500 text-xs font-bold">0</span>
                        </div>
                    </div>
                    
                    <div id="event-feed" class="flex-1 overflow-y-auto p-2 space-y-3">
                        <!-- Events with cross-referenced data will appear here -->
                        <div class="p-10 text-center opacity-20 text-[10px] italic">Awaiting high-priority telemetry...</div>
                    </div>
                </div>

                <!-- Control Console -->
                <div class="hud-panel p-5 rounded-3xl space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="toggleLayer('emergencies')" class="bg-red-900/20 text-red-400 text-[8px] font-black p-2 rounded border border-red-500/20">EMERGENCY: ON</button>
                        <button onclick="toggleLayer('quakes')" class="bg-orange-900/20 text-orange-400 text-[8px] font-black p-2 rounded border border-orange-500/20">SEISMIC: ON</button>
                    </div>
                    <div class="text-[8px] text-slate-500 uppercase font-bold text-center">Correlating: Planes | Quakes | Weather</div>
                </div>
            </aside>

            <!-- Main Focus Area -->
            <div class="flex-1 flex flex-col items-center justify-end pb-10">
                <div id="focus-panel" class="hud-panel px-10 py-6 rounded-3xl border-cyan-500/50 hidden animate-in slide-in-from-bottom-5">
                    <div class="flex items-center gap-12">
                        <div class="text-center">
                            <div class="text-[8px] font-bold text-cyan-500 uppercase tracking-widest mb-1">Focused_Target</div>
                            <div id="f-id" class="orbitron text-2xl font-black text-white">---</div>
                        </div>
                        <div class="h-12 w-px bg-cyan-900/30"></div>
                        <div class="grid grid-cols-2 gap-x-10 gap-y-1 text-[10px]">
                            <span class="text-slate-500">ALT:</span> <span id="f-alt" class="text-white font-bold">0 m</span>
                            <span class="text-slate-500">SPD:</span> <span id="f-vel" class="text-white font-bold">0 km/h</span>
                            <span class="text-slate-500">WIND:</span> <span id="f-wind" class="text-emerald-400 font-bold">---</span>
                            <span class="text-slate-500">TEMP:</span> <span id="f-temp" class="text-emerald-400 font-bold">---</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Link Setup ---
        let currentData = { planes: [], quakes: [] };
        const world = Globe()(document.getElementById('globeViz'));

        // --- Globe Configuration ---
        world
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
            .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
            .showAtmosphere(true)
            .atmosphereColor('#00f3ff')
            .atmosphereDaylightAlpha(0.2)
            .pointColor(p => p.type === 'emergency' ? '#ff003c' : (p.type === 'quake' ? '#f59e0b' : '#00ff41'))
            .pointAltitude(p => p.type === 'quake' ? 0.05 : 0.1)
            .pointRadius(p => p.type === 'emergency' ? 0.4 : 0.1)
            .pointLabel(p => `
                <div class="hud-panel p-3 text-[10px] text-white rounded-lg border-cyan-500/50">
                    <b style="color:cyan">UNIT: ${p.id}</b><br>
                    ${p.type.toUpperCase()}<br>
                    ALT: ${Math.round(p.alt)}m | ${p.country}<br>
                    ${p.weather ? `<hr class="my-1 border-white/10">WIND: ${p.weather.wind} km/h` : ''}
                </div>
            `)
            .onPointClick(p => focusUnit(p));

        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.4;

        // --- Correlation Engine ---

        async function updateRadar() {
            try {
                // 1. Fetch Aircraft (OpenSky)
                const planeRes = await fetch('https://opensky-network.org/api/states/all');
                const planeData = await planeRes.json();
                const allPlanes = planeData.states
                    .filter(s => s[5] && s[6])
                    .map(s => ({
                        id: s[1]?.trim() || 'UNK',
                        lng: s[5], lat: s[6], alt: s[7] || 0,
                        country: s[2], squawk: s[14], vel: s[9],
                        type: s[14] === "7700" ? 'emergency' : 'plane'
                    }));

                // 2. Fetch Seismic (USGS)
                const quakeRes = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_day.geojson');
                const quakeData = await quakeRes.json();
                const quakes = quakeData.features.map(f => ({
                    id: `QUAKE_${f.properties.mag}`,
                    lng: f.geometry.coordinates[0],
                    lat: f.geometry.coordinates[1],
                    alt: 0,
                    mag: f.properties.mag,
                    place: f.properties.place,
                    type: 'quake'
                }));

                // Combine Data
                const emergencies = allPlanes.filter(p => p.type === 'emergency');
                world.pointsData([...allPlanes, ...quakes]);

                // 3. Cross-Reference Weather for Emergencies
                await correlateIntelligence(emergencies, quakes);

                // UI Updates
                document.getElementById('stat-7700').innerText = emergencies.length + " SQUAWK";
                document.getElementById('stat-quakes').innerText = quakes.length + " SEISMIC";

            } catch (e) {
                console.error("Uplink Lost");
            }
        }

        async function correlateIntelligence(emergencies, quakes) {
            const feed = document.getElementById('event-feed');
            feed.innerHTML = '';

            for (let p of emergencies) {
                // הצלבת מזג אוויר בזמן אמת עבור מטוס בחירום
                const weather = await fetchWeather(p.lat, p.lng);
                p.weather = weather;
                
                const html = `
                    <div class="p-3 rounded-xl emergency-row cursor-pointer" onclick="focusUnit(${JSON.stringify(p)})">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-white font-black text-xs">${p.id}</span>
                            <span class="text-red-500 font-bold text-[8px]">SQUAWK 7700</span>
                        </div>
                        <div class="text-[8px] text-slate-400 uppercase mb-2">${p.country}</div>
                        <div class="flex gap-2">
                            <span class="weather-badge"><i class="fas fa-wind"></i> ${weather.wind} km/h</span>
                            <span class="weather-badge"><i class="fas fa-thermometer-half"></i> ${weather.temp}°C</span>
                        </div>
                    </div>
                `;
                feed.innerHTML += html;
            }

            // הוספת רעידות אדמה ליומן
            quakes.slice(0, 3).forEach(q => {
                feed.innerHTML += `
                    <div class="p-3 bg-orange-950/20 rounded-xl border border-orange-500/20">
                        <div class="text-orange-500 font-black text-[9px] uppercase">Seismic_Alert: Mag ${q.mag}</div>
                        <div class="text-slate-400 text-[8px] mt-1">${q.place}</div>
                    </div>
                `;
            });
        }

        async function fetchWeather(lat, lng) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                const data = await res.json();
                return {
                    temp: data.current_weather.temperature,
                    wind: data.current_weather.windspeed
                };
            } catch {
                return { temp: '??', wind: '??' };
            }
        }

        function focusUnit(p) {
            world.pointOfView({ lat: p.lat, lng: p.lng, altitude: 0.4 }, 1500);
            
            const panel = document.getElementById('focus-panel');
            panel.classList.remove('hidden');
            
            document.getElementById('f-id').innerText = p.id;
            document.getElementById('f-alt').innerText = Math.round(p.alt).toLocaleString() + " m";
            document.getElementById('f-vel').innerText = Math.round(p.vel * 3.6) + " km/h";
            
            if (p.weather) {
                document.getElementById('f-wind').innerText = p.weather.wind + " km/h";
                document.getElementById('f-temp').innerText = p.weather.temp + "°C";
            }
        }

        // --- Clock & System ---
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB');
        }, 1000);

        updateRadar();
        setInterval(updateRadar, 45000);

        window.addEventListener('resize', () => {
            world.width(window.innerWidth).height(window.innerHeight);
        });
    </script>
</body>
</html>
