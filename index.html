<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIR-SPACE COMMAND PRO | STABLE v11</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Orbitron:wght@400;900&display=swap');
        
        body { background-color: #000; margin: 0; overflow: hidden; color: #00f3ff; font-family: 'JetBrains Mono', monospace; }
        
        .hud-panel {
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }

        /* Scanning line */
        .scanline {
            width: 100%; height: 100%; position: absolute; inset: 0;
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 243, 255, 0.02) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 5;
        }

        /* Emergency Pulse */
        .emergency-alert {
            background: rgba(255, 0, 60, 0.2);
            border: 2px solid #ff003c;
            animation: pulse-red 1s infinite alternate;
        }
        @keyframes pulse-red { from { opacity: 0.5; } to { opacity: 1; } }

        #status-indicator { animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div class="scanline"></div>
    <div id="globeViz" class="absolute inset-0"></div>

    <!-- UI Overlay -->
    <div class="absolute inset-0 pointer-events-none flex flex-col p-6 z-10">
        
        <!-- Header -->
        <header class="flex justify-between items-start mb-6">
            <div class="flex items-center gap-4 pointer-events-auto">
                <div class="hud-panel p-4 rounded-2xl border-cyan-500/50">
                    <i id="status-indicator" class="fas fa-satellite text-2xl text-cyan-400"></i>
                </div>
                <div>
                    <h1 class="orbitron text-2xl font-black text-white tracking-widest uppercase">Air-Space_v11</h1>
                    <p class="text-[9px] text-cyan-500 font-bold uppercase tracking-[0.3em]">Global Tactical Intercept</p>
                </div>
            </div>

            <div class="hud-panel px-6 py-2 rounded-xl text-right pointer-events-auto border-cyan-500/30">
                <div id="clock" class="orbitron text-xl font-bold text-white">00:00:00</div>
                <div id="connection-status" class="text-[8px] text-emerald-400 font-black uppercase">Link: Secure</div>
            </div>
        </header>

        <div class="flex-1 flex justify-between overflow-hidden">
            <!-- Left Side: Radar Data -->
            <aside class="w-80 flex flex-col gap-4 pointer-events-auto overflow-hidden">
                <div class="hud-panel rounded-3xl flex-1 flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-white/10 bg-cyan-950/20 flex justify-between items-center">
                        <span class="text-xs font-bold uppercase tracking-widest text-cyan-400">Target_Intercepts</span>
                        <span id="plane-count" class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold">0</span>
                    </div>
                    
                    <!-- Search/Filter -->
                    <div class="p-3 border-b border-white/5">
                        <input type="text" id="search" oninput="applyFilters()" placeholder="Search Callsign..." 
                            class="w-full bg-black/40 border border-cyan-900/50 rounded-lg p-2 text-[10px] outline-none focus:border-cyan-400 transition">
                    </div>

                    <div id="target-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <div class="p-10 text-center opacity-20 italic text-xs">Scanning Airspace...</div>
                    </div>
                </div>

                <div class="hud-panel p-4 rounded-3xl space-y-2">
                    <div class="text-[9px] font-black text-slate-500 uppercase">Emergency Protocol</div>
                    <button onclick="toggleEmergencyOnly()" id="emerg-btn" class="w-full py-2 rounded-lg border border-red-900/50 text-red-500 text-[10px] font-bold hover:bg-red-600 hover:text-white transition">
                        SQUAWK 7700 ONLY: OFF
                    </button>
                </div>
            </aside>

            <!-- Right Side: Telemetry -->
            <aside class="w-80 flex flex-col gap-4 pointer-events-auto">
                <div class="hud-panel p-6 rounded-3xl text-center">
                    <div class="text-[9px] font-bold text-cyan-500 uppercase tracking-widest mb-1">Global Data Density</div>
                    <div id="density-val" class="text-4xl font-black orbitron text-white">0</div>
                    <div class="w-full bg-slate-800 h-1 rounded-full mt-4 overflow-hidden">
                        <div id="density-bar" class="bg-cyan-400 h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <div class="hud-panel flex-1 rounded-3xl p-4 overflow-hidden flex flex-col">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-3 tracking-widest">Intercept_Log</h3>
                    <div id="log-feed" class="flex-1 overflow-y-auto space-y-2 text-[9px] text-cyan-400/60">
                        <p>> System boot complete.</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // --- System State ---
        let allPlanes = [];
        let emergencyOnly = false;
        const world = Globe()(document.getElementById('globeViz'));

        // --- Globe UI Setup ---
        world
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg') // Bright High-Contrast Map
            .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
            .atmosphereColor('#00f3ff')
            .atmosphereDaylightAlpha(0.2)
            .showAtmosphere(true)
            .pointColor(p => p.emergency ? '#ff003c' : '#00ff41')
            .pointAltitude(p => p.emergency ? 0.12 : 0.04)
            .pointRadius(p => p.emergency ? 0.4 : 0.15) // Large enough to see
            .pointLabel(p => `
                <div style="background:rgba(0,0,0,0.9); padding:8px; border:1px solid cyan; border-radius:5px; font-size:10px; color:white;">
                    <b style="color:#00f3ff">FLIGHT: ${p.id}</b><br>
                    Origin: ${p.country}<br>
                    Altitude: ${Math.round(p.alt)}m<br>
                    Squawk: ${p.squawk || '---'}
                </div>
            `)
            .onPointClick(p => {
                world.pointOfView({ lat: p.lat, lng: p.lng, altitude: 0.5 }, 1500);
                addLog(`Focusing on Unit: ${p.id}`);
            });

        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.4;

        // --- Data Logic ---
        async function fetchRadar() {
            const connStatus = document.getElementById('connection-status');
            try {
                const res = await fetch('https://opensky-network.org/api/states/all');
                if (!res.ok) throw new Error("Rate Limit");
                
                const data = await res.json();
                
                // Parse Data
                allPlanes = (data.states || [])
                    .filter(s => s[5] && s[6]) // Crucial: must have Lat/Lng
                    .map(s => ({
                        id: s[1]?.trim() || 'UNK',
                        lng: s[5],
                        lat: s[6],
                        alt: s[7] || 0,
                        country: s[2],
                        squawk: s[14],
                        emergency: s[14] === "7700"
                    }));

                connStatus.innerText = "Link: Secure";
                connStatus.className = "text-[8px] text-emerald-400 font-black uppercase";
                
                applyFilters();
                addLog(`Sync successful: ${allPlanes.length} targets.`);

            } catch (e) {
                connStatus.innerText = "Link: Restricted / Rate Limit";
                connStatus.className = "text-[8px] text-red-500 font-black uppercase";
                addLog(`Link Warning: API Rate Limit hit. Retrying...`, 'red');
            }
        }

        function applyFilters() {
            const query = document.getElementById('search').value.toUpperCase();
            
            const filtered = allPlanes.filter(p => {
                const matchesSearch = p.id.includes(query) || p.country.toUpperCase().includes(query);
                const matchesEmerg = emergencyOnly ? p.emergency : true;
                return matchesSearch && matchesEmerg;
            });

            // Update Globe
            world.pointsData(filtered);

            // Update Stats
            document.getElementById('plane-count').innerText = filtered.length;
            document.getElementById('density-val').innerText = allPlanes.length.toLocaleString();
            const pct = Math.min((allPlanes.length / 12000) * 100, 100);
            document.getElementById('density-bar').style.width = pct + "%";

            // Update Sidebar (Show top 20 or emergencies)
            updateSidebar(filtered.slice(0, 50));
        }

        function updateSidebar(data) {
            const list = document.getElementById('target-list');
            if (data.length === 0) {
                list.innerHTML = `<div class="p-10 text-center opacity-20 text-xs italic">No Targets in View</div>`;
                return;
            }

            list.innerHTML = data.map(p => `
                <div onclick="focusOn('${p.id}', ${p.lat}, ${p.lng})" class="p-3 bg-white/5 rounded-xl border border-white/5 hover:border-cyan-500/50 cursor-pointer transition group">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-white text-xs">${p.id}</span>
                        <span class="${p.emergency ? 'text-red-500 animate-pulse' : 'text-cyan-500'} text-[10px] font-bold uppercase">${p.emergency ? '7700' : 'Active'}</span>
                    </div>
                    <div class="text-[8px] text-slate-500 mt-1 uppercase group-hover:text-cyan-400 transition">${p.country}</div>
                </div>
            `).join('');
        }

        function focusOn(id, lat, lng) {
            world.pointOfView({ lat, lng, altitude: 0.4 }, 1500);
            addLog(`Tracking: ${id}`);
        }

        function toggleEmergencyOnly() {
            emergencyOnly = !emergencyOnly;
            const btn = document.getElementById('emerg-btn');
            btn.innerText = `SQUAWK 7700 ONLY: ${emergencyOnly ? 'ON' : 'OFF'}`;
            btn.classList.toggle('bg-red-600');
            btn.classList.toggle('text-white');
            applyFilters();
        }

        function addLog(msg, color = 'cyan') {
            const feed = document.getElementById('log-feed');
            const p = document.createElement('p');
            p.className = color === 'red' ? 'text-red-500 font-bold' : 'text-cyan-400 opacity-80';
            p.innerText = `> [${new Date().toLocaleTimeString()}] ${msg}`;
            feed.prepend(p);
            if (feed.children.length > 20) feed.removeChild(feed.lastChild);
        }

        // --- Loops ---
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB');
        }, 1000);

        fetchRadar();
        setInterval(fetchRadar, 40000); // 40s refresh to avoid API bans

        window.addEventListener('resize', () => {
            world.width(window.innerWidth).height(window.innerHeight);
        });

    </script>
</body>
</html>
