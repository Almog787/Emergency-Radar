<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ARTILLERY SIMULATOR - PRO VFX</title>
    <style>
        body { margin: 0; overflow: hidden; background: #020617; font-family: 'Segoe UI', sans-serif; }
        #loading { position: absolute; inset: 0; background: #020617; color: #38bdf8; display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 24px; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 30px; height: 30px; border: 2px solid rgba(0, 210, 255, 0.5); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .btn-audio { position: absolute; top: 20px; right: 20px; background: #0ea5e9; color: white; border: none; padding: 15px 30px; cursor: pointer; border-radius: 50px; font-weight: bold; z-index: 100; box-shadow: 0 0 20px rgba(14, 165, 233, 0.5); }
    </style>
</head>
<body>

    <div id="loading">טוען מערכות פיזיקה ו-VFX...</div>
    <div id="crosshair"></div>
    <button class="btn-audio" id="audioBtn" onclick="initAudio()">הפעל מערכת סאונד</button>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls.js';
        import * as CANNON from 'https://cdn.skypack.dev/cannon-es@0.19.0';
        import * as dat from 'https://cdn.skypack.dev/dat.gui@0.7.9';
        import gsap from 'https://cdn.skypack.dev/gsap';

        // --- ניהול סאונד מתקדם ---
        let audioCtx;
        window.initAudio = () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.getElementById('audioBtn').style.display = 'none';
        };

        function playComplexSound(type) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const master = audioCtx.createGain();
            master.connect(audioCtx.destination);

            if (type === 'launch') {
                const osc = audioCtx.createOscillator();
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(40, now + 0.2);
                const g = audioCtx.createGain();
                g.gain.setValueAtTime(0.4, now);
                g.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.connect(g); g.connect(master);
                osc.start(); osc.stop(now + 0.3);
            } else if (type === 'whistle') {
                const osc = audioCtx.createOscillator();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.exponentialRampToValueAtTime(200, now + 0.8);
                const g = audioCtx.createGain();
                g.gain.setValueAtTime(0, now);
                g.gain.linearRampToValueAtTime(0.1, now + 0.1);
                g.gain.linearRampToValueAtTime(0, now + 0.8);
                osc.connect(g); g.connect(master);
                osc.start(); osc.stop(now + 0.8);
            } else if (type === 'explode') {
                // רעש לבן בשכבות לפיצוץ עמוק
                const bufferSize = audioCtx.sampleRate * 2;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(1000, now);
                filter.frequency.exponentialRampToValueAtTime(40, now + 0.8);
                const g = audioCtx.createGain();
                g.gain.setValueAtTime(1, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
                noise.connect(filter); filter.connect(g); g.connect(master);
                noise.start();
            }
        }

        // --- אתחול מנוע ---
        let scene, camera, renderer, controls, world;
        const objectsToUpdate = [];
        const params = { gravity: -9.82, explosionForce: 25, explosionRadius: 12 };

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x020617);
            scene.fog = new THREE.Fog(0x020617, 20, 150);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(50, 40, 50);

            world = new CANNON.World();
            world.gravity.set(0, params.gravity, 0);
            world.allowSleep = true;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(50, 100, 50);
            sun.castShadow = true;
            scene.add(sun);

            // קרקע
            const floorGeo = new THREE.PlaneGeometry(300, 300);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x0f172a });
            const floorMesh = new THREE.Mesh(floorGeo, floorMat);
            floorMesh.rotation.x = -Math.PI / 2;
            floorMesh.receiveShadow = true;
            scene.add(floorMesh);

            const floorBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
            floorBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            world.addBody(floorBody);

            createCity();
            
            const gui = new dat.GUI();
            gui.add(params, 'explosionForce', 10, 100).name("עוצמת פיצוץ");
            gui.add(params, 'explosionRadius', 5, 30).name("רדיוס נזק");

            document.getElementById('loading').style.display = 'none';
            window.addEventListener('mousedown', onShoot);
        }

        function createCity() {
            const voxelGeo = new THREE.BoxGeometry(2, 2, 2);
            const voxelMat = new THREE.MeshStandardMaterial({ color: 0x1e293b });
            
            for (let i = 0; i < 12; i++) {
                const bx = (Math.random() - 0.5) * 60;
                const bz = (Math.random() - 0.5) * 60;
                const h = 5 + Math.floor(Math.random() * 5);
                
                for (let y = 0; y < h; y++) {
                    const pos = { x: bx, y: y * 2.1 + 1, z: bz };
                    const mesh = new THREE.Mesh(voxelGeo, voxelMat.clone());
                    mesh.position.set(pos.x, pos.y, pos.z);
                    mesh.castShadow = true;
                    scene.add(mesh);

                    const shape = new CANNON.Box(new CANNON.Vec3(1, 1, 1));
                    const body = new CANNON.Body({ mass: 1, position: new CANNON.Vec3(pos.x, pos.y, pos.z) });
                    body.addShape(shape);
                    body.sleep();
                    world.addBody(body);
                    objectsToUpdate.push({ mesh, body });
                }
            }
        }

        function onShoot(e) {
            if (e.button !== 0) return;
            playComplexSound('launch');
            playComplexSound('whistle');

            // יצירת פגז (טיל)
            const shellGroup = new THREE.Group();
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.6), new THREE.MeshBasicMaterial({ color: 0xffffff }));
            const glow = new THREE.PointLight(0x0ea5e9, 2, 10);
            shellGroup.add(head);
            shellGroup.add(glow);
            
            shellGroup.position.copy(camera.position);
            scene.add(shellGroup);

            const body = new CANNON.Body({ mass: 5, shape: new CANNON.Sphere(0.6), position: new CANNON.Vec3(camera.position.x, camera.position.y, camera.position.z) });
            const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion).multiplyScalar(60);
            body.velocity.set(dir.x, dir.y, dir.z);
            world.addBody(body);

            const trailInterval = setInterval(() => {
                const smoke = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({ color: 0x38bdf8, transparent: true, opacity: 0.5 }));
                smoke.position.copy(shellGroup.position);
                scene.add(smoke);
                gsap.to(smoke.scale, { x: 0, y: 0, z: 0, duration: 0.5, onComplete: () => scene.remove(smoke) });
            }, 30);

            const shellData = { mesh: shellGroup, body };
            objectsToUpdate.push(shellData);

            body.addEventListener('collide', (event) => {
                clearInterval(trailInterval);
                createAdvancedExplosion(event.contact.bj.position);
                world.removeBody(body);
                scene.remove(shellGroup);
                objectsToUpdate.splice(objectsToUpdate.indexOf(shellData), 1);
            });
        }

        function createAdvancedExplosion(pos) {
            playComplexSound('explode');

            // 1. פלאש אור
            const light = new THREE.PointLight(0xffaa00, 50, 40);
            light.position.copy(pos);
            scene.add(light);
            gsap.to(light, { intensity: 0, duration: 0.8, onComplete: () => scene.remove(light) });

            // 2. גל הדף (Shockwave)
            const ring = new THREE.Mesh(
                new THREE.RingGeometry(1, 1.5, 32),
                new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, side: THREE.DoubleSide })
            );
            ring.position.copy(pos);
            ring.rotation.x = -Math.PI / 2;
            scene.add(ring);
            gsap.to(ring.scale, { x: params.explosionRadius, y: params.explosionRadius, duration: 0.6, ease: "expo.out" });
            gsap.to(ring.material, { opacity: 0, duration: 0.6, onComplete: () => scene.remove(ring) });

            // 3. כדור אש (Particles)
            for (let i = 0; i < 15; i++) {
                const fire = new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshBasicMaterial({ color: 0xff4400, transparent: true }));
                fire.position.copy(pos);
                scene.add(fire);
                gsap.to(fire.position, { 
                    x: pos.x + (Math.random()-0.5)*10, 
                    y: pos.y + Math.random()*10, 
                    z: pos.z + (Math.random()-0.5)*10, 
                    duration: 1 
                });
                gsap.to(fire.scale, { x: 0, y: 0, z: 0, duration: 1 });
                gsap.to(fire.material, { opacity: 0, duration: 1, onComplete: () => scene.remove(fire) });
            }

            // 4. פיזיקה לרסיסים
            objectsToUpdate.forEach(obj => {
                const dist = obj.body.position.distanceTo(pos);
                if (dist < params.explosionRadius) {
                    obj.body.wakeUp();
                    const forceDir = new CANNON.Vec3().copy(obj.body.position).vsub(pos);
                    forceDir.normalize();
                    const strength = (1 - dist / params.explosionRadius) * params.explosionForce;
                    obj.body.applyImpulse(forceDir.scale(strength), obj.body.position);
                    
                    // אפקט חריכה ויזואלי לרסיסים שנפגעו
                    if (obj.mesh.material) {
                        obj.mesh.material.emissive.setHex(0xff3300);
                        gsap.to(obj.mesh.material.emissive, { r: 0, g: 0, b: 0, duration: 2 });
                    }
                }
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            world.step(1/60);
            objectsToUpdate.forEach(obj => {
                obj.mesh.position.copy(obj.body.position);
                obj.mesh.quaternion.copy(obj.body.quaternion);
            });
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
