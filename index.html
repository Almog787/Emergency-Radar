<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת שיבוץ בקרים - הקו האדום</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #f3f4f6; }
        .dashboard-header { background-color: #003366; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn-primary { background-color: #003366; transition: all 0.3s; }
        .btn-primary:hover { background-color: #004a94; transform: translateY(-1px); }
        tr:nth-child(even) { background-color: #f9fafb; }
        .travel-row { background-color: #f3f4f6; color: #666; font-style: italic; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="dashboard-header text-white p-6 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold">מערכת שיבוץ בקרים חכמה</h1>
            <div id="current-date" class="text-xl italic"></div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b sticky top-0 z-10">
        <div class="container mx-auto flex">
            <button onclick="showTab('dashboard')" class="px-6 py-4 font-bold border-b-2 border-blue-900 text-blue-900 transition-all hover:bg-gray-50">לוח בקרה</button>
            <button onclick="showTab('schedule')" class="px-6 py-4 font-bold border-b-2 border-transparent hover:border-blue-300 transition-all">לו"ז יומי</button>
            <button onclick="showTab('inspectors')" class="px-6 py-4 font-bold border-b-2 border-transparent hover:border-blue-300 transition-all">בקרים (15)</button>
            <button onclick="showTab('stations')" class="px-6 py-4 font-bold border-b-2 border-transparent hover:border-blue-300 transition-all">מסד נתונים תחנות</button>
        </div>
    </nav>

    <main class="container mx-auto p-6">
        
        <!-- Tab: Dashboard -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-800">
                    <h3 class="text-gray-500 font-bold mb-2">תאריך לשיבוץ</h3>
                    <input type="date" id="schedule-date" class="w-full border p-2 rounded mb-4 shadow-inner">
                    <button onclick="generateSchedule()" class="btn-primary text-white w-full py-3 rounded-lg font-bold shadow-md">
                        בצע שיבוץ יומי חכם
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-600">
                    <h3 class="text-gray-500 font-bold mb-2">סטטוס ביצוע (KPI)</h3>
                    <div class="space-y-2">
                        <p class="flex justify-between"><span>סה"כ משמרות:</span> <span id="kpi-shifts" class="font-bold text-green-700">0</span></p>
                        <p class="flex justify-between"><span>בקרות תחנה:</span> <span id="kpi-inspections" class="font-bold text-blue-700">0</span></p>
                        <p class="flex justify-between"><span>נסיעות מנהלתיות:</span> <span id="kpi-travels" class="font-bold text-gray-500">0</span></p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500 text-center flex flex-col justify-center">
                    <p class="text-sm text-gray-500">מוכן להפעלה עבור</p>
                    <p class="text-2xl font-black">15 בקרים</p>
                </div>
            </div>
            
            <div class="bg-blue-50 border-r-4 border-blue-500 p-4 rounded text-blue-800">
                <strong>טיפ מערכת:</strong> האלגוריתם מתעדף תחנות שבהן מספר הבקרות החודשי נמוך מהיעד (KPI Optimization).
            </div>
        </div>

        <!-- Tab: Schedule Results -->
        <div id="schedule" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">תוצאות שיבוץ יומי</h2>
                <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">ייצוא ל-Excel (CSV)</button>
            </div>
            <div class="bg-white rounded-lg shadow-xl overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="px-4 py-3 text-right">בקר</th>
                            <th class="px-4 py-3 text-right">משימה</th>
                            <th class="px-4 py-3 text-right">מיקום</th>
                            <th class="px-4 py-3 text-right">התחלה</th>
                            <th class="px-4 py-3 text-right">סיום</th>
                            <th class="px-4 py-3 text-right">משך</th>
                            <th class="px-4 py-3 text-right">הערות</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body">
                        <tr>
                            <td colspan="7" class="text-center py-10 text-gray-400 italic">טרם בוצע שיבוץ. לחץ על "בצע שיבוץ יומי" בלוח הבקרה.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Inspectors -->
        <div id="inspectors" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">ניהול בקרים (15)</h2>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-3 text-right">שם הבקר</th>
                            <th class="p-3 text-right">משמרת</th>
                            <th class="p-3 text-right">התחלה מועדפת</th>
                            <th class="p-3 text-right">סיום מועדף</th>
                        </tr>
                    </thead>
                    <tbody id="inspectors-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Stations -->
        <div id="stations" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">ניהול תחנות ומכסות</h2>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-gray-100 border-b">
                        <tr>
                            <th class="p-3 text-right">שם תחנה</th>
                            <th class="p-3 text-right">סוג</th>
                            <th class="p-3 text-right">זמן (דק')</th>
                            <th class="p-3 text-right">Geo Index</th>
                            <th class="p-3 text-right">יעד חודשי</th>
                            <th class="p-3 text-right">בוצע</th>
                        </tr>
                    </thead>
                    <tbody id="stations-body"></tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // --- Data ---
        const stations = [
            { name: "תמ פת", type: "עילי", dur: 30, geo: 1, target: 20, actual: 5 },
            { name: "פינסקר", type: "עילי", dur: 30, geo: 2, target: 20, actual: 8 },
            { name: "קרית אריה", type: "עילי", dur: 30, geo: 4, target: 20, actual: 12 },
            { name: "שנקר", type: "עילי", dur: 30, geo: 6, target: 20, actual: 3 },
            { name: "אהרונוביץ", type: "תת-קרקעי", dur: 60, geo: 9, target: 20, actual: 15 },
            { name: "בן גוריון", type: "תת-קרקעי", dur: 60, geo: 11, target: 20, actual: 14 },
            { name: "ביאליק", type: "תת-קרקעי", dur: 60, geo: 12, target: 20, actual: 7 },
            { name: "ארלוזורוב", type: "תת-קרקעי", dur: 60, geo: 14, target: 20, actual: 19 },
            { name: "שאול המלך", type: "תת-קרקעי", dur: 60, geo: 15, target: 20, actual: 11 },
            { name: "קרליבך", type: "תת-קרקעי", dur: 60, geo: 17, target: 20, actual: 4 },
            { name: "אלנבי", type: "תת-קרקעי", dur: 60, geo: 18, target: 20, actual: 9 },
            { name: "אליפלט", type: "תת-קרקעי", dur: 60, geo: 19, target: 20, actual: 13 },
            { name: "בלומפילד", type: "עילי", dur: 30, geo: 21, target: 20, actual: 2 },
            { name: "יפו", type: "עילי", dur: 30, geo: 23, target: 20, actual: 18 },
            { name: "יוספטל", type: "עילי", dur: 30, geo: 28, target: 20, actual: 6 },
            { name: "בלפור", type: "עילי", dur: 30, geo: 30, target: 20, actual: 10 },
            { name: "בנימין", type: "עילי", dur: 30, geo: 31, target: 20, actual: 5 },
            { name: "הקוממיות", type: "עילי", dur: 30, geo: 34, target: 20, actual: 1 }
        ];

        const inspectors = [
            { name: "דניאל אברהם", shift: "בוקר", start: "תמ פת", end: "קרית אריה" },
            { name: "רונית לוי", shift: "בוקר", start: "הקוממיות", end: "בלפור" },
            { name: "יוסי כהן", shift: "בוקר", start: "אליפלט", end: "אלנבי" },
            { name: "מיכל שחר", shift: "בוקר", start: "שאול המלך", end: "ארלוזורוב" },
            { name: "אבי ביטון", shift: "בוקר", start: "בן גוריון", end: "אהרונוביץ" },
            { name: "שרה גולן", shift: "בוקר", start: "יוספטל", end: "העמל" },
            { name: "עומר פרץ", shift: "בוקר", start: "קרית אריה", end: "שנקר" },
            { name: "נועה קירל", shift: "בוקר", start: "בלפור", end: "בנימין" },
            { name: "אלירן סבג", shift: "ערב", start: "תמ פת", end: "פינסקר" },
            { name: "גלית דיסטל", shift: "ערב", start: "הקוממיות", end: "יוספטל" },
            { name: "משה אשכנזי", shift: "ערב", start: "ארלוזורוב", end: "ביאליק" },
            { name: "דנה פרידר", shift: "ערב", start: "אלנבי", end: "קרליבך" },
            { name: "גיא זו-ארץ", shift: "ערב", start: "קרית אריה", end: "אם המושבות" },
            { name: "רותם סלע", shift: "ערב", start: "יפו", end: "בלומפילד" },
            { name: "אסי עזר", shift: "ערב", start: "יהודית", end: "שאול המלך" }
        ];

        let masterSchedule = [];

        // --- Logic Engine ---
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('border-blue-900', 'text-blue-900'));
            event.target.classList.add('border-blue-900', 'text-blue-900');
        }

        function getStationData(name) {
            return stations.find(s => s.name === name) || stations[0];
        }

        function findNextBestStation(currentLocName) {
            const currentGeo = getStationData(currentLocName).geo;
            let best = stations[0];
            let minScore = Infinity;

            stations.forEach(st => {
                if (st.name === currentLocName) return;
                const dist = Math.abs(st.geo - currentGeo);
                const score = (dist * 2) + (st.actual * 5); // Logic from VBA
                if (score < minScore) {
                    minScore = score;
                    best = st;
                }
            });
            return best;
        }

        function generateSchedule() {
            const date = document.getElementById('schedule-date').value || new Date().toISOString().split('T')[0];
            masterSchedule = [];
            
            inspectors.forEach(insp => {
                let currTime = insp.shift === "בוקר" ? "06:00" : "14:00";
                const shiftEnd = insp.shift === "בוקר" ? "14:30" : "22:30";
                let currLoc = insp.start;

                // First Task
                const firstSt = getStationData(currLoc);
                addTask(insp.name, "בקרת תחנה (פתיחה)", currLoc, currTime, firstSt.dur, "עוגן התחלה");
                currTime = addMinutes(currTime, firstSt.dur);

                // Main Loop
                while (isTimeBefore(currTime, addMinutes(shiftEnd, -60))) {
                    const nextSt = findNextBestStation(currLoc);
                    
                    // Travel
                    const dist = Math.abs(getStationData(currLoc).geo - nextSt.geo);
                    const travelTime = (dist * 3) + 5;
                    addTask(insp.name, "נסיעה מנהלתית", `${currLoc} ➔ ${nextSt.name}`, currTime, travelTime, "גישור גיאוגרפי");
                    currTime = addMinutes(currTime, travelTime);

                    // Inspection
                    addTask(insp.name, "בקרת תחנה", nextSt.name, currTime, nextSt.dur, "KPI Optimization");
                    currTime = addMinutes(currTime, nextSt.dur);
                    currLoc = nextSt.name;
                }
                
                // End shift
                addTask(insp.name, "סגירת משמרת", "משרד/קצה", currTime, 30, "סיכום ודיווח");
            });

            renderSchedule();
            updateKPIs();
            alert("השיבוץ הושלם עבור 15 בקרים!");
            showTab('schedule');
        }

        function addTask(name, task, loc, start, dur, note) {
            const end = addMinutes(start, dur);
            masterSchedule.push({ name, task, loc, start, end, dur, note });
        }

        // --- UI Helpers ---
        function addMinutes(timeStr, mins) {
            let [h, m] = timeStr.split(':').map(Number);
            let date = new Date(0, 0, 0, h, m + mins);
            return date.toTimeString().substring(0, 5);
        }

        function isTimeBefore(t1, t2) {
            return t1 < t2;
        }

        function renderSchedule() {
            const body = document.getElementById('schedule-body');
            body.innerHTML = masterSchedule.map(s => `
                <tr class="${s.task.includes('נסיעה') ? 'travel-row' : ''}">
                    <td class="p-3 border-b font-bold">${s.name}</td>
                    <td class="p-3 border-b">${s.task}</td>
                    <td class="p-3 border-b">${s.loc}</td>
                    <td class="p-3 border-b">${s.start}</td>
                    <td class="p-3 border-b">${s.end}</td>
                    <td class="p-3 border-b">${s.dur} דק'</td>
                    <td class="p-3 border-b text-xs text-gray-500">${s.note}</td>
                </tr>
            `).join('');
        }

        function updateKPIs() {
            document.getElementById('kpi-shifts').innerText = inspectors.length;
            document.getElementById('kpi-inspections').innerText = masterSchedule.filter(s => s.task.includes('בקרת')).length;
            document.getElementById('kpi-travels').innerText = masterSchedule.filter(s => s.task.includes('נסיעה')).length;
        }

        function exportToCSV() {
            let csv = "בקר,משימה,מיקום,התחלה,סיום,משך,הערות\n";
            masterSchedule.forEach(s => {
                csv += `${s.name},${s.task},${s.loc},${s.start},${s.end},${s.dur},${s.note}\n`;
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `schedule_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        // Init
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('he-IL');
        document.getElementById('inspectors-body').innerHTML = inspectors.map(i => `
            <tr><td class="p-2 border-b">${i.name}</td><td class="p-2 border-b">${i.shift}</td><td class="p-2 border-b">${i.start}</td><td class="p-2 border-b">${i.end}</td></tr>
        `).join('');
        document.getElementById('stations-body').innerHTML = stations.map(s => `
            <tr><td class="p-2 border-b font-bold">${s.name}</td><td class="p-2 border-b">${s.type}</td><td class="p-2 border-b">${s.dur}</td><td class="p-2 border-b">${s.geo}</td><td class="p-2 border-b font-bold text-blue-600">${s.target}</td><td class="p-2 border-b">${s.actual}</td></tr>
        `).join('');
    </script>
</body>
</html>
