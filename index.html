<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Bus Live - Stride API</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap');
        body { font-family: 'Assistant', sans-serif; }
        #map { height: calc(100vh - 80px); width: 100%; }
        .bus-icon {
            background-color: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: all 0.5s ease-in-out;
        }
        .update-pulse {
            animation: pulse-blue 1s shadow;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">

    <!-- Header -->
    <header class="bg-blue-900 text-white p-4 shadow-lg flex flex-wrap justify-between items-center z-[1001] relative">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-black italic tracking-tighter text-blue-100">STRIDE <span class="text-blue-400 font-bold">LIVE</span></h1>
            <div id="status" class="text-xs bg-blue-800 px-3 py-1 rounded-full opacity-80">注...</div>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- Selector for Refresh Rate -->
            <div class="flex items-center gap-2 bg-blue-800 p-1 px-3 rounded-lg border border-blue-700">
                <label for="refresh-rate" class="text-xs font-bold text-blue-200">拽爪 专注:</label>
                <select id="refresh-rate" onchange="updateRefreshInterval(this.value)" class="bg-transparent text-white text-sm outline-none font-bold cursor-pointer">
                    <option value="5000" class="bg-blue-900">5 砖转</option>
                    <option value="10000" selected class="bg-blue-900">10 砖转</option>
                    <option value="30000" class="bg-blue-900">30 砖转</option>
                    <option value="60000" class="bg-blue-900">拽 转</option>
                </select>
            </div>
            <button onclick="fetchBuses()" class="bg-blue-500 hover:bg-blue-400 text-white px-4 py-1 rounded-lg font-bold text-sm transition-all shadow-md">专注 注砖</button>
        </div>
    </header>

    <div class="flex flex-col md:flex-row h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-80 bg-white shadow-xl z-10 overflow-hidden flex flex-col hidden md:flex" style="height: calc(100vh - 80px);">
            <div class="p-4 border-b bg-gray-50">
                <h2 class="font-bold text-gray-700">专砖转 住 (100 专)</h2>
                <p id="counter-text" class="text-[10px] text-gray-500 uppercase font-bold tracking-widest mt-1">爪 转 转</p>
            </div>
            <div id="bus-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Bus items will be injected here -->
            </div>
        </aside>

        <!-- Map Container -->
        <div class="flex-1 relative">
            <div id="map"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 爪 注专转 ---
        let busMarkers = {};
        let refreshTimer = null;
        let currentRate = 10000; // 专专转  10 砖转

        // --- 转 驻 ---
        const map = L.map('map', { zoomControl: false }).setView([32.0853, 34.7818], 12);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '漏 OpenStreetMap'
        }).addTo(map);

        // --- GraphQL Query ---
        const STRIDE_QUERY = `
        query {
          siri_vehicle_locations(order_by: {recorded_at_time: desc}, limit: 100) {
            id
            latitude
            longitude
            recorded_at_time
            bearing
            velocity
            siri_ride {
              gtfs_ride {
                gtfs_route {
                  route_short_name
                  route_long_name
                }
              }
            }
          }
        }`;

        async function fetchBuses() {
            const statusEl = document.getElementById('status');
            statusEl.innerText = "注 转...";
            
            try {
                const response = await fetch('https://open-bus-stride-api.hasadna.org.il/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: STRIDE_QUERY })
                });

                const result = await response.json();
                if (!result.data || !result.data.siri_vehicle_locations) throw new Error("No data");

                const buses = result.data.siri_vehicle_locations;
                updateMap(buses);
                updateList(buses);
                
                statusEl.innerText = `注: ${new Date().toLocaleTimeString('he-IL')}`;
            } catch (error) {
                console.error("Fetch Error:", error);
                statusEl.innerText = "砖 专 砖专转";
            }
        }

        function updateMap(buses) {
            // 专砖转 -IDs  砖注 砖专转
            const currentIds = buses.map(b => b.id);

            // 住专转 住 砖 拽 转专 " 专
            Object.keys(busMarkers).forEach(id => {
                if (!currentIds.includes(parseInt(id))) {
                    map.removeLayer(busMarkers[id]);
                    delete busMarkers[id];
                }
            });

            buses.forEach(bus => {
                if (!bus.latitude || !bus.longitude) return;

                const routeName = bus.siri_ride?.gtfs_ride?.gtfs_route?.route_short_name || "?";
                const longName = bus.siri_ride?.gtfs_ride?.gtfs_route?.route_long_name || " 注";
                const recordedTime = new Date(bus.recorded_at_time);
                const delaySeconds = Math.floor((new Date() - recordedTime) / 1000);

                if (busMarkers[bus.id]) {
                    // 注 拽 拽 (爪 拽  驻驻 转)
                    busMarkers[bus.id].setLatLng([bus.latitude, bus.longitude]);
                } else {
                    // 爪专转 拽 砖
                    const icon = L.divIcon({
                        className: 'bus-icon',
                        html: `<div>${routeName}</div>`,
                        iconSize: [26, 26]
                    });

                    const marker = L.marker([bus.latitude, bus.longitude], { icon: icon })
                        .bindPopup(`
                            <div class="text-right" dir="rtl">
                                <h3 class="font-bold text-blue-700">拽 ${routeName}</h3>
                                <p class="text-xs text-gray-600 mb-2">${longName}</p>
                                <div class="bg-gray-100 p-2 rounded text-[10px] space-y-1">
                                    <p> <b> :</b> ${recordedTime.toLocaleTimeString()}</p>
                                    <p>憋 <b>专 爪转:</b> ${delaySeconds} 砖转</p>
                                    <p> <b>专转:</b> ${bus.velocity || 0} 拽"砖</p>
                                </div>
                            </div>
                        `);

                    marker.addTo(map);
                    busMarkers[bus.id] = marker;
                }
            });
        }

        function updateList(buses) {
            const listContainer = document.getElementById('bus-list');
            listContainer.innerHTML = "";

            buses.forEach(bus => {
                const routeName = bus.siri_ride?.gtfs_ride?.gtfs_route?.route_short_name || "?";
                const longName = bus.siri_ride?.gtfs_ride?.gtfs_route?.route_long_name || " 注";
                
                const div = document.createElement('div');
                div.className = "p-3 bg-white border border-gray-100 rounded-lg shadow-sm hover:border-blue-400 hover:shadow-md cursor-pointer transition-all group";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-black text-blue-600 text-lg">拽 ${routeName}</span>
                        <span class="text-[10px] text-gray-400 italic">${new Date(bus.recorded_at_time).toLocaleTimeString('he-IL')}</span>
                    </div>
                    <div class="text-[11px] text-gray-500 truncate group-hover:text-blue-900">${longName}</div>
                `;
                div.onclick = () => {
                    map.setView([bus.latitude, bus.longitude], 17);
                    if (busMarkers[bus.id]) busMarkers[bus.id].openPopup();
                };
                listContainer.appendChild(div);
            });
        }

        // ---  拽爪 专注 ---
        function updateRefreshInterval(val) {
            currentRate = parseInt(val);
            console.log(`拽爪 专注 砖 : ${currentRate / 1000} 砖转`);
            
            // 驻住 专 拽 驻注 砖
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(fetchBuses, currentRate);
            
            // 砖 转  砖砖转砖 专 转
            fetchBuses();
        }

        // --- 驻注 专砖转 ---
        function startApp() {
            fetchBuses();
            refreshTimer = setInterval(fetchBuses, currentRate);
        }

        startApp();

    </script>
</body>
</html>
