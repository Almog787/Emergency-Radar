<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>VOXEL ENGINE AAA - GitHub Pages Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #020617; font-family: 'Segoe UI', sans-serif; }
        #hud { position: absolute; top: 30px; left: 30px; color: #38bdf8; pointer-events: none; z-index: 10; }
        #loading { position: absolute; inset: 0; background: #020617; color: #38bdf8; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; font-size: 20px; letter-spacing: 4px; }
        .btn-audio { position: absolute; bottom: 20px; right: 20px; background: rgba(56, 189, 248, 0.2); border: 1px solid #38bdf8; color: #38bdf8; padding: 10px; cursor: pointer; pointer-events: all; }
    </style>
</head>
<body>
    <div id="loading">
        <div style="border: 3px solid #38bdf8; border-top-color: transparent; width: 40px; height: 40px; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
        INITIALIZING VOXEL ENGINE...
    </div>
    <div id="hud">
        <h1 style="margin:0; font-size: 32px; text-shadow: 0 0 20px #38bdf8;">VOXEL COMMANDER</h1>
        <p id="status">> SYSTEM READY | POST-PROCESSING: ACTIVE</p>
    </div>
    <button class="btn-audio" onclick="initAudio()">הפעל סאונד (Web Audio)</button>

    <!-- ספריות -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <!-- Post-Processing Scripts -->
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script>
        let scene, camera, renderer, composer, raycaster, mouse, audioCtx;
        let levelData, explosionData;
        const buildings = [];

        /** 1. סינתזת סאונד (ללא קבצים חיצוניים) **/
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.querySelector('.btn-audio').style.display = 'none';
        }

        function playExplosionSound() {
            if (!audioCtx) return;
            const noise = audioCtx.createBufferSource();
            const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < buffer.length; i++) data[i] = Math.random() * 2 - 1;
            noise.buffer = buffer;

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(1000, audioCtx.currentTime);
            filter.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.5);

            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);

            noise.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            noise.start();
        }

        /** 2. טעינת נתונים **/
        async function start() {
            try {
                const [lRes, eRes] = await Promise.all([fetch('level.json'), fetch('explosion.json')]);
                levelData = await lRes.json();
                explosionData = await eRes.json();
                document.getElementById('loading').remove();
                initEngine();
            } catch (e) {
                document.getElementById('loading').innerText = "ERROR: JSON FILES MISSING";
            }
        }

        /** 3. מנוע גרפי **/
        function initEngine() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(levelData.environment.sky);
            scene.fog = new THREE.FogExp2(levelData.environment.sky, 0.01);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(120, 80, 150);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Post-Processing (Bloom)
            const renderScene = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), levelData.config.bloomIntensity, 0.4, 0.85);
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // תאורה
            scene.add(new THREE.HemisphereLight(0xffffff, 0x000000, 0.5));
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(50, 100, 50);
            scene.add(sun);

            createCity();

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            window.addEventListener('mousedown', onShoot);
            animate();
        }

        function createCity() {
            scene.add(new THREE.GridHelper(600, 60, levelData.environment.accent, 0x0f172a));
            const voxelGeo = new THREE.BoxGeometry(1.9, 1.9, 1.9);

            levelData.buildings.forEach(b => {
                const group = new THREE.Group();
                const voxels = [];
                for(let y=0; y<b.h; y++) {
                    for(let x=0; x<b.w; x++) {
                        for(let z=0; z<b.d; z++) {
                            const mat = new THREE.MeshStandardMaterial({ color: b.color, metalness: 0.8, roughness: 0.2 });
                            const v = new THREE.Mesh(voxelGeo, mat);
                            v.position.set(x*2 - (b.w), y*2 + 1, z*2 - (b.d));
                            group.add(v);
                            voxels.push(v);
                        }
                    }
                }
                group.position.set(b.x, 0, b.z);
                scene.add(group);
                buildings.push({ group, voxels, destroyed: false });
            });
        }

        function onShoot(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            if (intersects.length > 0) {
                const target = intersects[0].point;
                let hitB = buildings.find(b => b.group === intersects[0].object.parent);
                launch(target, hitB);
            }
        }

        function launch(target, building) {
            const shell = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshBasicMaterial({color: 0xffffff}));
            shell.position.set(150, 50, 150);
            scene.add(shell);

            gsap.to(shell.position, {
                x: target.x, z: target.z, duration: 0.6, ease: "none",
                onComplete: () => { scene.remove(shell); detonate(target, building); }
            });
            gsap.to(shell.position, { y: target.y + 60, duration: 0.3, yoyo: true, repeat: 1, ease: "power2.out" });
        }

        /** 4. מערכת פיצוץ AAA **/
        function detonate(pos, building) {
            playExplosionSound();

            // פלאש
            const flash = new THREE.PointLight(0xffaa00, explosionData.vfx.flashIntensity, 200);
            flash.position.copy(pos);
            scene.add(flash);
            gsap.to(flash, { intensity: 0, duration: 1, onComplete: () => scene.remove(flash) });

            // גל הדף
            const ring = new THREE.Mesh(new THREE.RingGeometry(1, 2, 32), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.7, side: THREE.DoubleSide }));
            ring.position.copy(pos); ring.rotation.x = Math.PI/2;
            scene.add(ring);
            gsap.to(ring.scale, { x: explosionData.vfx.shockwaveRadius || 50, y: explosionData.vfx.shockwaveRadius || 50, duration: 0.8, ease: "power3.out" });
            gsap.to(ring.material, { opacity: 0, duration: 0.8, onComplete: () => scene.remove(ring) });

            // חלקיקים
            spawnParticles(pos, explosionData.vfx.fireCount, 0xff4400, 3);
            spawnParticles(pos, explosionData.vfx.sparkCount, 0xffffff, 0.5);

            // פירוק מבנה
            if (building && !building.destroyed) {
                building.destroyed = true;
                building.voxels.forEach((v, i) => {
                    const p = explosionData.shardPhysics[i % explosionData.shardPhysics.length] || {angle: Math.random()*6, power: 2};
                    const worldPos = new THREE.Vector3();
                    v.getWorldPosition(worldPos);
                    scene.attach(v);

                    gsap.to(v.position, {
                        x: worldPos.x + Math.cos(p.angle) * (p.power * explosionData.physics.shardForce),
                        z: worldPos.z + Math.sin(p.angle) * (p.power * explosionData.physics.shardForce),
                        y: worldPos.y + Math.random() * 50,
                        duration: 2, ease: "expo.out"
                    });
                    gsap.to(v.position, { y: 1, duration: 1.5, delay: 0.8, ease: "bounce.out" });
                    v.material.emissive.setHex(0xff0000);
                    gsap.to(v.material.color, { r: 0, g: 0, b: 0, duration: 4 });
                });
            }

            // רעידת מצלמה
            gsap.fromTo(camera.position, { x: camera.position.x + 5 }, { x: camera.position.x, duration: 0.05, repeat: 15, yoyo: true });
        }

        function spawnParticles(pos, count, color, size) {
            for(let i=0; i<count; i++) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(Math.random() * size), new THREE.MeshBasicMaterial({color, transparent: true}));
                p.position.copy(pos);
                scene.add(p);
                const v = new THREE.Vector3((Math.random()-0.5)*60, Math.random()*60, (Math.random()-0.5)*60);
                gsap.to(p.position, { x: pos.x+v.x, y: pos.y+v.y, z: pos.z+v.z, duration: 1.5, ease: "power3.out" });
                gsap.to(p.scale, { x: 0, y: 0, z: 0, duration: 1.5, onComplete: () => scene.remove(p) });
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = Date.now() * 0.0001;
            camera.position.x = Math.cos(t) * 180;
            camera.position.z = Math.sin(t) * 180;
            camera.lookAt(0, 0, 0);
            composer.render(); // שימוש ב-Composer במקום ב-Renderer
        }

        start();
        @keyframes spin { to { transform: rotate(360deg); } }
    </script>
</body>
</html>
