<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Earth Breaker: Ultra Graphics</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Inter', sans-serif; user-select: none; }
        #start-screen {
            position: absolute; inset: 0; background: radial-gradient(circle at center, #1a1a2e 0%, #000 100%);
            z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        #start-btn {
            padding: 20px 60px; font-size: 24px; background: #ff4b2b; color: white; border: none;
            border-radius: 50px; cursor: pointer; box-shadow: 0 0 30px #ff4b2b; font-weight: 900; transition: 0.3s;
        }
        #start-btn:hover { transform: scale(1.1); filter: brightness(1.2); }
        #ui { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 100; }
        #weapon-bar { display: flex; justify-content: center; gap: 15px; padding: 40px; pointer-events: auto; }
        .w-btn { width: 70px; height: 70px; background: rgba(0,0,0,0.8); border: 1px solid #444; border-radius: 50%; cursor: pointer; transition: 0.3s; font-size: 30px; display: flex; align-items: center; justify-content: center; }
        .w-btn.active { border-color: #00f3ff; box-shadow: 0 0 20px #00f3ff; transform: scale(1.1); }
        #game-over { position: absolute; inset: 0; background: black; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 300; color: #ff4b2b; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 5vw; margin: 0; letter-spacing: 10px;">EARTH <span style="color: #ff4b2b;">BREAKER</span></h1>
        <p style="opacity: 0.6; margin-bottom: 30px;">ULTRA GRAPHICS ENGINE</p>
        <button id="start-btn" onclick="initGame()">INITIALIZE SYSTEM</button>
    </div>

    <div id="ui" style="display: none;">
        <div style="padding: 20px; color: #00f3ff; font-weight: bold; font-family: monospace; letter-spacing: 2px; text-align: center; width: 100%;">
            STRUCTURAL INTEGRITY: <span id="status-text">100%</span>
        </div>
        <div id="weapon-bar">
            <button class="w-btn active" onclick="setW('nuke')">ğŸš€</button>
            <button class="w-btn" onclick="setW('asteroid')">â˜„ï¸</button>
            <button class="w-btn" onclick="setW('laser')">âš¡</button>
            <button class="w-btn" onclick="setW('monster')">ğŸ‘¾</button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.js';

        // --- ×¡×¤×¨×™×•×ª ××¤×§×˜×™× (Post-Processing) ---
        // ×× ×—× ×• ×˜×•×¢× ×™× ×¡×¤×¨×™×•×ª ×—×™×¦×•× ×™×•×ª ×œ-Bloom (×”×–×•×”×¨ ×”×§×•×œ× ×•×¢×™)
        const BLOOM_SCENE = 1;

        let scene, camera, renderer, earth, core, clouds, starField;
        let weapon = 'nuke', isOver = false, shake = 0;
        let totalDamage = 0;
        let debris = [];
        let minions = [];
        const textureLoader = new THREE.TextureLoader();

        // --- ××ª×—×•×œ ×¡××•× ×“ ---
        const playSfx = (url, vol = 0.5) => {
            const a = new Audio(url);
            a.volume = vol;
            a.play();
        };

        window.initGame = function() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui').style.display = 'flex';

            // --- ×¡×¦× ×” ×•××¦×œ××” ---
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 4;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.body.appendChild(renderer.domElement);

            // --- ×ª××•×¨×” ---
            const ambient = new THREE.AmbientLight(0x404040, 0.5); // ××•×¨ ×¡×‘×™×‘×ª×™ ×—×œ×©
            scene.add(ambient);
            
            const sun = new THREE.DirectionalLight(0xffffff, 1.5);
            sun.position.set(5, 3, 5);
            scene.add(sun);

            // --- ×œ×™×‘×ª ×”×××’××” ---
            const coreGeo = new THREE.SphereGeometry(0.9, 32, 32);
            const coreMat = new THREE.MeshStandardMaterial({ 
                color: 0xff2200, 
                emissive: 0xff0000, 
                emissiveIntensity: 5
            });
            core = new THREE.Mesh(coreGeo, coreMat);
            scene.add(core);

            // --- ×›×“×•×¨ ×”××¨×¥ (High End) ---
            const earthGeo = new THREE.IcosahedronGeometry(1, 20); // ×¨×–×•×œ×•×¦×™×” ×’×‘×•×”×” ×××•×“
            const earthMat = new THREE.MeshStandardMaterial({
                map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
                bumpMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_normal_2048.jpg'),
                bumpScale: 0.05,
                metalness: 0,
                roughness: 1,
                vertexColors: true
            });

            // Specular Map (×‘×¨×§ ×‘××•×§×™×™× ×•×¡×™×)
            earthMat.roughnessMap = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_specular_2048.jpg');

            const count = earthGeo.attributes.position.count;
            earthGeo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(count * 3), 3));
            for(let i=0; i<count; i++) earthGeo.attributes.color.setXYZ(i, 1, 1, 1);

            earth = new THREE.Mesh(earthGeo, earthMat);
            scene.add(earth);

            // --- ×¢× × ×™× ---
            clouds = new THREE.Mesh(
                new THREE.SphereGeometry(1.02, 64, 64),
                new THREE.MeshStandardMaterial({
                    map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png'),
                    transparent: true, opacity: 0.4
                })
            );
            scene.add(clouds);

            // --- ×›×•×›×‘×™× ××™×›×•×ª×™×™× ---
            const stars = [];
            for (let i = 0; i < 5000; i++) {
                stars.push(THREE.MathUtils.randFloatSpread(100), THREE.MathUtils.randFloatSpread(100), THREE.MathUtils.randFloatSpread(100));
            }
            const starGeo = new THREE.BufferGeometry();
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(stars, 3));
            starField = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0x888888, size: 0.05 }));
            scene.add(starField);

            window.addEventListener('pointerdown', onAttack);
            animate();
        };

        window.setW = (t) => {
            weapon = t;
            document.querySelectorAll('.w-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        function onAttack(e) {
            if(isOver) return;
            const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
            const ray = new THREE.Raycaster();
            ray.setFromCamera(mouse, camera);
            const intersects = ray.intersectObject(earth);
            if(intersects.length > 0) fire(intersects[0].point);
        }

        function fire(pt) {
            if(weapon === 'nuke') nukeEffect(pt);
            if(weapon === 'asteroid') asteroidEffect(pt);
            if(weapon === 'laser') laserEffect(pt);
            if(weapon === 'monster') monsterEffect(pt);
        }

        // --- × ×©×§×™× ××©×•×¤×¨×™× ---

        function nukeEffect(pt) {
            playSfx('https://labs.phaser.io/assets/audio/SoundEffects/explosion.mp3');
            createBlast(pt, 0xffaa00, 3);
            decompose(pt, 0.5, 0.6);
            shake = 1.2;
        }

        function asteroidEffect(pt) {
            const rock = new THREE.Mesh(new THREE.DodecahedronGeometry(0.15, 0), new THREE.MeshStandardMaterial({color: 0x555555}));
            rock.position.copy(pt).multiplyScalar(5);
            scene.add(rock);
            
            // ×× ×™××¦×™×” ×—×œ×§×”
            const startPos = rock.position.clone();
            let alpha = 0;
            const step = () => {
                alpha += 0.05;
                rock.position.lerpVectors(startPos, pt, alpha);
                rock.rotation.x += 0.1;
                if(alpha < 1) requestAnimationFrame(step);
                else {
                    scene.remove(rock);
                    createBlast(pt, 0xff4400, 2);
                    decompose(pt, 0.4, 0.4);
                    shake = 0.5;
                }
            };
            step();
        }

        function laserEffect(pt) {
            const line = new THREE.Mesh(new THREE.CylinderGeometry(0.01, 0.01, 10), new THREE.MeshBasicMaterial({color: 0x00f3ff}));
            line.position.copy(pt).multiplyScalar(2);
            line.lookAt(pt); line.rotateX(Math.PI/2);
            scene.add(line);
            setTimeout(() => scene.remove(line), 100);
            createBlast(pt, 0x00f3ff, 0.6);
            decompose(pt, 0.2, 0.1);
            playSfx('https://labs.phaser.io/assets/audio/SoundEffects/alien_death.wav', 0.3);
        }

        function monsterEffect(pt) {
            for(let i=0; i<10; i++) {
                const m = new THREE.Mesh(new THREE.BoxGeometry(0.03, 0.03, 0.03), new THREE.MeshBasicMaterial({color: 0x88ff00}));
                m.position.copy(pt);
                m.userData = { 
                    v: new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize().multiplyScalar(0.015),
                    life: 200 + Math.random()*200
                };
                scene.add(m);
                minions.push(m);
            }
        }

        // --- ×× ×•×¢ ×”×¤×™×¨×•×§ (DESTRUCTION) ---
        function decompose(pt, radius, strength) {
            const pos = earth.geometry.attributes.position;
            const cols = earth.geometry.attributes.color;
            const v = new THREE.Vector3();
            const localPt = earth.worldToLocal(pt.clone());

            for(let i=0; i<pos.count; i++) {
                v.set(pos.getX(i), pos.getY(i), pos.getZ(i));
                const d = v.distanceTo(localPt);
                
                if(d < radius) {
                    const power = (radius - d) / radius;
                    
                    // ×”×–×–×ª ×§×•×“×§×•×“×™× ×¤× ×™××” ×œ×—×©×™×¤×ª ×”×œ×™×‘×”
                    v.multiplyScalar(1 - (power * strength)); 
                    pos.setXYZ(i, v.x, v.y, v.z);
                    
                    // ×¦×‘×™×¢×” ×œ"×©×¨×•×£" (××“×•× ×œ×•×”×˜)
                    cols.setXYZ(i, 1, power*0.2, 0); 
                    
                    totalDamage += power * 0.02;

                    // ×™×¦×™×¨×ª ×©×‘×¨×™ ×¡×œ×¢ ×¤×™×–×™×™× ××“×™ ×¤×¢×
                    if(Math.random() > 0.99) spawnChunk(pt);
                }
            }
            pos.needsUpdate = true;
            cols.needsUpdate = true;
            earth.geometry.computeVertexNormals();
            
            document.getElementById('status-text').innerText = Math.max(0, Math.round(100 - totalDamage)) + '%';
            if(totalDamage >= 100) triggerEnd();
        }

        function spawnChunk(pt) {
            const chunk = new THREE.Mesh(
                new THREE.BoxGeometry(0.05, 0.05, 0.05),
                new THREE.MeshStandardMaterial({color: 0x333333})
            );
            chunk.position.copy(pt);
            chunk.userData.v = pt.clone().normalize().multiplyScalar(0.02 + Math.random()*0.02);
            scene.add(chunk);
            debris.push(chunk);
            if(debris.length > 50) scene.remove(debris.shift());
        }

        function createBlast(pt, color, scale) {
            const light = new THREE.PointLight(color, 10 * scale, 3);
            light.position.copy(pt);
            scene.add(light);
            setTimeout(() => scene.remove(light), 500);

            // Shockwave
            const ring = new THREE.Mesh(
                new THREE.RingGeometry(0.05, 0.1, 32),
                new THREE.MeshBasicMaterial({color, transparent: true, opacity: 0.8, side: THREE.DoubleSide})
            );
            ring.position.copy(pt); ring.lookAt(0,0,0);
            scene.add(ring);
            gsap.to(ring.scale, {x: 15*scale, y: 15*scale, duration: 0.5});
            gsap.to(ring.material, {opacity: 0, duration: 0.5, onComplete: () => scene.remove(ring)});
        }

        function triggerEnd() {
            if(isOver) return;
            isOver = true;
            playSfx('https://labs.phaser.io/assets/audio/SoundEffects/explosion.mp3', 1);
            gsap.to(earth.scale, {x:0, y:0, z:0, duration: 2});
            gsap.to(clouds.scale, {x:0, y:0, z:0, duration: 2});
            gsap.to(core.scale, {x:10, y:10, z:10, duration: 1});
            setTimeout(() => {
                alert("PLANET DESTROYED");
                location.reload();
            }, 2000);
        }

        // --- ×œ×•×œ××ª ×”××©×—×§ ---
        function animate() {
            requestAnimationFrame(animate);
            
            if(!isOver) {
                earth.rotation.y += 0.001;
                clouds.rotation.y += 0.0012;
                core.rotation.y -= 0.002;
            }

            // ×¢×“×›×•×Ÿ ×©×‘×¨×™×
            debris.forEach(c => c.position.add(c.userData.v));

            // ×¢×“×›×•×Ÿ ×—×™×™×–×¨×™×
            minions.forEach((m, i) => {
                m.position.add(m.userData.v);
                m.position.normalize().multiplyScalar(1.01); // ×”×¦××“×” ×œ×¤× ×™ ×”×©×˜×—
                if(Math.random() > 0.95) decompose(m.position, 0.05, 0.02);
                m.userData.life--;
                if(m.userData.life <= 0) {
                    scene.remove(m);
                    minions.splice(i, 1);
                }
            });

            // ×¨×¢×™×“×ª ××¦×œ××”
            if(shake > 0) {
                camera.position.x = (Math.random()-0.5) * shake;
                camera.position.y = (Math.random()-0.5) * shake;
                shake *= 0.9;
            } else {
                camera.position.x = 0; camera.position.y = 0;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
