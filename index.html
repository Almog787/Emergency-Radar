<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>JSON VOXEL ENGINE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #loading { position: absolute; width: 100%; height: 100%; background: #000; color: #00f2ff; display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #ui { position: absolute; top: 20px; left: 20px; color: #fff; pointer-events: none; }
    </style>
</head>
<body>
    <div id="loading">טוען נתוני JSON...</div>
    <div id="ui">
        <h2 id="level-name">מערכת ארטילריה ווקסלית</h2>
        <p>לחץ על המבנים להשמדה</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <script>
        let scene, camera, renderer, raycaster, mouse;
        let levelData, explosionData;
        const buildings = [];

        async function loadGame() {
            try {
                // טעינת הקבצים במקביל
                const [lvlRes, expRes] = await Promise.all([
                    fetch('level.json'),
                    fetch('explosion.json')
                ]);
                levelData = await lvlRes.json();
                explosionData = await expRes.json();
                
                document.getElementById('loading').style.display = 'none';
                initScene();
                createWorld();
                animate();
            } catch (err) {
                document.getElementById('loading').innerText = "שגיאה בטעינת קבצי JSON. וודא שאתה מריץ על שרת.";
                console.error(err);
            }
        }

        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(levelData.environment.skyColor);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(80, 60, 100);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
            scene.add(hemi);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('mousedown', onMouseDown);
        }

        function createWorld() {
            // יצירת קרקע
            const grid = new THREE.GridHelper(400, 50, levelData.environment.gridColor, 0x222222);
            scene.add(grid);

            // בניית מבנים מה-JSON
            const voxelGeo = new THREE.BoxGeometry(1.8, 1.8, 1.8);
            levelData.buildings.forEach(bInfo => {
                const group = new THREE.Group();
                const voxels = [];
                for(let y=0; y<bInfo.h; y++) {
                    for(let x=-1; x<=1; x++) {
                        for(let z=-1; z<=1; z++) {
                            const mat = new THREE.MeshStandardMaterial({ color: 0x64748b, metalness: 0.6 });
                            const v = new THREE.Mesh(voxelGeo, mat);
                            v.position.set(x*2, y*2 + 1, z*2);
                            group.add(v);
                            voxels.push(v);
                        }
                    }
                }
                group.position.set(bInfo.x, 0, bInfo.z);
                scene.add(group);
                buildings.push({ group, voxels, destroyed: false });
            });
        }

        function onMouseDown(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(buildings.map(b => b.group), true);
            if (intersects.length > 0) {
                const targetPoint = intersects[0].point;
                let building = buildings.find(b => b.group === intersects[0].object.parent);
                if(building && !building.destroyed) fire(targetPoint, building);
            }
        }

        function fire(target, building) {
            const shell = new THREE.Mesh(new THREE.SphereGeometry(1), new THREE.MeshBasicMaterial({color: 0xffff00}));
            shell.position.set(100, 50, 100);
            scene.add(shell);

            gsap.to(shell.position, {
                x: target.x, y: target.y, z: target.z,
                duration: 0.8,
                onComplete: () => {
                    scene.remove(shell);
                    explode(building, target);
                }
            });
        }

        function explode(building, pos) {
            building.destroyed = true;
            
            // שימוש בנתוני הפיצוץ מה-JSON
            building.voxels.forEach((v, i) => {
                const data = explosionData.shards[i % explosionData.shards.length];
                const worldPos = new THREE.Vector3();
                v.getWorldPosition(worldPos);
                scene.attach(v);

                gsap.to(v.position, {
                    x: worldPos.x + Math.cos(data.angle) * data.vel,
                    y: worldPos.y + Math.random() * 20,
                    z: worldPos.z + Math.sin(data.angle) * data.vel,
                    duration: 1.5, ease: "expo.out", delay: data.delay
                });

                gsap.to(v.position, {
                    y: 1, duration: 1, delay: data.delay + 0.8, ease: "bounce.out"
                });

                v.material.emissive.setHex(0x00f2ff);
            });

            // רעידת מסך
            gsap.fromTo(camera.position, {x: camera.position.x+2}, {x: camera.position.x, duration: 0.1, repeat: 5});
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = Date.now() * 0.0001;
            camera.position.x = Math.cos(t) * 120;
            camera.position.z = Math.sin(t) * 120;
            camera.lookAt(0,0,0);
            renderer.render(scene, camera);
        }

        loadGame();
    </script>
</body>
</html>
