<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-Light Pro - Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --gantt-bg: #ffffff;
            --gantt-grid: #f1f5f9;
            --gantt-line: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --gantt-bg: #1e293b;
            --gantt-grid: #334155;
            --gantt-line: #475569;
        }

        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        /* --- Animations --- */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .nav-btn.active { 
            border-bottom: 4px solid var(--primary); 
            color: var(--primary); 
            font-weight: 800; 
            background-color: rgba(59, 130, 246, 0.1); 
        }
        
        /* --- Gantt Styles --- */
        .gantt-container { overflow-x: auto; position: relative; background: var(--gantt-bg); border-radius: 0.75rem; border: 1px solid var(--border-color); }
        .gantt-header { display: flex; border-bottom: 2px solid var(--border-color); background: var(--bg-body); position: sticky; top: 0; z-index: 20; }
        .gantt-row { display: flex; border-bottom: 1px solid var(--gantt-line); height: 60px; align-items: center; position: relative; }
        .gantt-label { width: 160px; flex-shrink: 0; font-weight: bold; padding: 0 1rem; position: sticky; right: 0; background: var(--bg-card); z-index: 10; border-left: 2px solid var(--border-color); color: var(--text-main); }
        
        .gantt-timeline { position: relative; flex-grow: 1; min-width: 1440px; height: 100%; background: repeating-linear-gradient(90deg, transparent, transparent 79px, var(--gantt-grid) 80px); }
        
        .gantt-block { 
            position: absolute; height: 70%; top: 15%; border-radius: 6px; 
            font-size: 11px; display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: white; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            z-index: 1; border: 1px solid rgba(255,255,255,0.2); select-none: none;
        }
        .gantt-block:active { cursor: grabbing; cursor: -webkit-grabbing; transform: scale(1.02); z-index: 50; }
        
        /* Conflict Visuals */
        .conflict { 
            background: repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #b91c1c 10px, #b91c1c 20px) !important;
            border: 2px solid #fff;
            animation: pulseRed 1.5s infinite;
            z-index: 40 !important;
        }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Colors */
        .bg-inspection { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .bg-travel { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bg-anchor { background: linear-gradient(135deg, #9333ea, #7e22ce); }
        .bg-admin { background: linear-gradient(135deg, #64748b, #475569); }

        /* Dark Mode Input Fixes */
        [data-theme="dark"] input, [data-theme="dark"] select {
            background-color: #334155;
            border-color: #475569;
            color: white;
        }
    </style>
</head>
<body data-theme="light">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center font-bold text-xl">R</div>
                <div>
                    <h1 class="text-xl font-black tracking-wider italic">R-LIGHT <span class="text-blue-400">PRO</span></h1>
                    <p class="text-[10px] text-slate-400 opacity-80">v4.0 | ×©×™×‘×•×¥ ×—×›×, ×’×™×‘×•×™×™× ×•×’×× ×˜ ×“×™× ××™</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-2 rounded-full bg-slate-700 hover:bg-slate-600 transition" title="××¦×‘ ×›×”×”/×‘×”×™×¨">
                    ğŸŒ—
                </button>
                
                <!-- Backups -->
                <button onclick="showBackupsModal()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg text-xs font-bold transition">
                    <span>â†º</span> ×©×—×–×•×¨ ×’×™×‘×•×™
                </button>

                <button onclick="resetSystem()" class="bg-red-600/80 hover:bg-red-600 px-3 py-2 rounded-lg text-xs font-bold transition">
                    ××¤×¡ ××¢×¨×›×ª
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-card border-b border-color sticky top-[72px] z-40 shadow-sm">
        <div class="container mx-auto flex overflow-x-auto">
            <button onclick="showTab('dashboard')" id="btn-dashboard" class="nav-btn active flex-1 py-4 px-6 font-bold text-slate-500 transition-all whitespace-nowrap">×œ×•×— ×‘×§×¨×”</button>
            <button onclick="showTab('gantt')" id="btn-gantt" class="nav-btn flex-1 py-4 px-6 font-bold text-slate-500 transition-all whitespace-nowrap">×’×× ×˜ (×¢×¨×™×›×” ×—×™×”)</button>
            <button onclick="showTab('constraints')" id="btn-constraints" class="nav-btn flex-1 py-4 px-6 font-bold text-slate-500 transition-all whitespace-nowrap">××™×œ×•×¦×™×</button>
            <button onclick="showTab('schedule')" id="btn-schedule" class="nav-btn flex-1 py-4 px-6 font-bold text-slate-500 transition-all whitespace-nowrap">×˜×‘×œ×”</button>
            <button onclick="showTab('stations')" id="btn-stations" class="nav-btn flex-1 py-4 px-6 font-bold text-slate-500 transition-all whitespace-nowrap">×¡×˜×˜×•×¡</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 min-h-screen">

        <!-- Backups Modal -->
        <div id="backups-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
            <div class="card w-full max-w-md p-6 rounded-2xl shadow-2xl">
                <h3 class="text-xl font-bold mb-4 flex justify-between">
                    ×”×™×¡×˜×•×¨×™×™×ª ×’×¨×¡××•×ª
                    <button onclick="document.getElementById('backups-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500">âœ•</button>
                </h3>
                <div id="backups-list" class="space-y-2 max-h-[300px] overflow-y-auto"></div>
                <p class="text-xs text-muted mt-4 italic">×”××¢×¨×›×ª ×©×•××¨×ª ××•×˜×•××˜×™×ª ×’×¨×¡×” ×œ×¤× ×™ ×›×œ ×”×¨×¦×ª ×©×™×‘×•×¥.</p>
            </div>
        </div>

        <!-- Tab: Dashboard -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Control -->
                <div class="card p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">ğŸš€ ×”×¨×¦×ª ×©×™×‘×•×¥</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-muted block mb-1">×ª××¨×™×š ×”×ª×—×œ×”:</label>
                            <input type="date" id="start-date" class="w-full p-3 border rounded-xl outline-none transition-all">
                        </div>
                        <button onclick="runGenerator()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl shadow-lg transition-all transform active:scale-95">
                            ×‘×¦×¢ ×©×™×‘×•×¥ ×—×›×
                        </button>
                    </div>
                </div>

                <!-- Alerts -->
                <div class="card p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4 text-red-500 flex items-center gap-2">âš ï¸ ×”×ª×¨××•×ª ×•×§×•× ×¤×œ×™×§×˜×™×</h2>
                    <div id="conflict-alerts" class="space-y-2 max-h-[180px] overflow-y-auto text-sm">
                        <p class="text-muted italic">××™×Ÿ ×§×•× ×¤×œ×™×§×˜×™× ×›×¨×’×¢.</p>
                    </div>
                </div>

                <!-- Stats -->
                <div class="card p-6 rounded-2xl shadow-sm flex flex-col justify-center items-center text-center bg-slate-800 text-white border-none">
                    <div class="text-5xl font-black text-blue-400 mb-2" id="stat-total-jobs">0</div>
                    <div class="text-sm uppercase tracking-widest text-slate-400 font-bold">××©×™××•×ª ×©×•×‘×¦×•</div>
                </div>
            </div>
        </div>

        <!-- Tab: Gantt (Drag & Drop) -->
        <div id="gantt" class="tab-content space-y-4">
            <div class="card p-4 rounded-2xl flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold">×ª×¨×©×™× ×’×× ×˜ ××™× ×˜×¨××§×˜×™×‘×™</h2>
                    <p class="text-xs text-muted">×’×¨×•×¨ ××©×™××•×ª ×œ×©×™× ×•×™ ×–×× ×™×. ×§×•× ×¤×œ×™×§×˜×™× ×™×¡×•×× ×• ×‘××“×•×.</p>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-muted">×™×•×:</label>
                    <select id="gantt-day-filter" onchange="renderGantt()" class="border p-2 rounded-xl font-bold text-blue-600 outline-none"></select>
                </div>
            </div>

            <div class="gantt-container shadow-xl">
                <div class="gantt-header" id="gantt-header"></div>
                <div id="gantt-area" class="divide-y divide-slate-100 dark:divide-slate-700"></div>
            </div>
            
            <div class="flex flex-wrap gap-4 justify-center mt-4 text-xs font-bold text-muted">
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-inspection"></div> ×‘×§×¨×”</div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-travel"></div> × ×¡×™×¢×”</div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-anchor"></div> ×¢×•×’×Ÿ</div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-red-500 border border-white"></div> ×”×ª× ×’×©×•×ª</div>
            </div>
        </div>

        <!-- Tab: Constraints -->
        <div id="constraints" class="tab-content space-y-6">
            <div class="card rounded-2xl overflow-hidden">
                <div class="p-4 bg-slate-100 dark:bg-slate-800 border-b border-color font-bold">ğŸ¥ × ×™×”×•×œ ×”×™×¢×“×¨×•×™×•×ª</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center text-sm">
                        <thead class="bg-slate-900 text-white">
                            <tr><th class="p-4 text-right">×©× ×”×‘×§×¨</th><th class="p-4">×'</th><th class="p-4">×‘'</th><th class="p-4">×’'</th><th class="p-4">×“'</th><th class="p-4">×”'</th><th class="p-4">×•'</th><th class="p-4">×©'</th></tr>
                        </thead>
                        <tbody id="constraints-body" class="divide-y divide-color"></tbody>
                    </table>
                </div>
            </div>

            <div class="card p-6 rounded-2xl">
                <h3 class="text-lg font-bold mb-4">âš“ ×”×•×¡×¤×ª ×¢×•×’×Ÿ ×™×“× ×™</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <select id="anchor-insp" class="w-full border p-2.5 rounded-lg outline-none"></select>
                    <select id="anchor-day" class="w-full border p-2.5 rounded-lg outline-none">
                        <option value="0">×¨××©×•×Ÿ</option><option value="1">×©× ×™</option><option value="2">×©×œ×™×©×™</option><option value="3">×¨×‘×™×¢×™</option><option value="4">×—××™×©×™</option><option value="5">×©×™×©×™</option><option value="6">×©×‘×ª</option>
                    </select>
                    <input type="time" id="anchor-time" class="w-full border p-2.5 rounded-lg outline-none">
                    <select id="anchor-station" class="w-full border p-2.5 rounded-lg outline-none"></select>
                    <button onclick="addAnchor()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2.5 rounded-lg transition-all">×”×•×¡×£</button>
                </div>
                <div id="anchors-list" class="mt-4 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Tab: Schedule Table -->
        <div id="schedule" class="tab-content space-y-4">
            <div class="card p-4 rounded-2xl flex justify-between items-center">
                <h2 class="text-xl font-bold">×˜×‘×œ×ª ×©×™×‘×•×¥ ××¤×•×¨×˜×ª</h2>
                <button onclick="exportCSV()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-700">×™×™×¦×•× ×œ-Excel</button>
            </div>
            <div class="card rounded-2xl overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-900 text-white">
                        <tr><th class="p-4">×™×•×</th><th class="p-4">×‘×§×¨</th><th class="p-4">××©×™××”</th><th class="p-4">××™×§×•×</th><th class="p-4">×©×¢×•×ª</th></tr>
                    </thead>
                    <tbody id="schedule-body" class="divide-y divide-color"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Stations -->
        <div id="stations" class="tab-content">
            <div class="card rounded-2xl overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-100 dark:bg-slate-800">
                        <tr><th class="p-4">×ª×—× ×”</th><th class="p-4 text-center">×™×¢×“</th><th class="p-4 text-center">×‘×•×¦×¢</th><th class="p-4 w-1/3">×”×ª×§×“××•×ª</th></tr>
                    </thead>
                    <tbody id="stations-body" class="divide-y divide-color"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration ---
        const inspectorsDB = [
            { name: "×“× ×™××œ ××‘×¨×”×", shift: "×‘×•×§×¨", start: "×ª× ×¤×ª" }, { name: "×¨×•× ×™×ª ×œ×•×™", shift: "×‘×•×§×¨", start: "×”×§×•×××™×•×ª" },
            { name: "×™×•×¡×™ ×›×”×Ÿ", shift: "×‘×•×§×¨", start: "××œ×™×¤×œ×˜" }, { name: "××™×›×œ ×©×—×¨", shift: "×‘×•×§×¨", start: "×©××•×œ ×”××œ×š" },
            { name: "××‘×™ ×‘×™×˜×•×Ÿ", shift: "×‘×•×§×¨", start: "×‘×Ÿ ×’×•×¨×™×•×Ÿ" }, { name: "×©×¨×” ×’×•×œ×Ÿ", shift: "×‘×•×§×¨", start: "×™×•×¡×¤×˜×œ" },
            { name: "×¢×•××¨ ×¤×¨×¥", shift: "×‘×•×§×¨", start: "×§×¨×™×ª ××¨×™×”" }, { name: "× ×•×¢×” ×§×™×¨×œ", shift: "×‘×•×§×¨", start: "×‘×œ×¤×•×¨" },
            { name: "××œ×™×¨×Ÿ ×¡×‘×’", shift: "×¢×¨×‘", start: "×ª× ×¤×ª" }, { name: "×’×œ×™×ª ×“×™×¡×˜×œ", shift: "×¢×¨×‘", start: "×”×§×•×××™×•×ª" },
            { name: "××©×” ××©×›× ×–×™", shift: "×¢×¨×‘", start: "××¨×œ×•×–×•×¨×•×‘" }, { name: "×“× ×” ×¤×¨×™×“×¨", shift: "×¢×¨×‘", start: "××œ× ×‘×™" },
            { name: "×’×™× ×–×•-××¨×¥", shift: "×¢×¨×‘", start: "×§×¨×™×ª ××¨×™×”" }, { name: "×¨×•×ª× ×¡×œ×¢", shift: "×¢×¨×‘", start: "×™×¤×•" },
            { name: "××¡×™ ×¢×–×¨", shift: "×¢×¨×‘", start: "×©××•×œ ×”××œ×š" }
        ];

        const stationsDB = [
            { name: "×ª× ×¤×ª", geo: 1, target: 20 }, { name: "×¤×™× ×¡×§×¨", geo: 2, target: 20 }, { name: "×§×¨×™×ª ××¨×™×”", geo: 4, target: 25 },
            { name: "×©× ×§×¨", geo: 6, target: 20 }, { name: "××”×¨×•× ×•×‘×™×¥", geo: 9, target: 30 }, { name: "×‘×Ÿ ×’×•×¨×™×•×Ÿ", geo: 11, target: 30 },
            { name: "×‘×™××œ×™×§", geo: 12, target: 30 }, { name: "××¨×œ×•×–×•×¨×•×‘", geo: 14, target: 35 }, { name: "×©××•×œ ×”××œ×š", geo: 15, target: 35 },
            { name: "×§×¨×œ×™×‘×š", geo: 17, target: 30 }, { name: "××œ× ×‘×™", geo: 18, target: 30 }, { name: "××œ×™×¤×œ×˜", geo: 19, target: 25 },
            { name: "×‘×œ×•××¤×™×œ×“", geo: 21, target: 20 }, { name: "×™×¤×•", geo: 23, target: 20 }, { name: "×™×•×¡×¤×˜×œ", geo: 28, target: 25 },
            { name: "×‘×œ×¤×•×¨", geo: 30, target: 25 }, { name: "×‘× ×™××™×Ÿ", geo: 31, target: 25 }, { name: "×”×§×•×××™×•×ª", geo: 34, target: 25 }
        ];

        const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "×©×‘×ª"];
        
        // --- State Management ---
        let state = {
            startDate: new Date().toISOString().split('T')[0],
            schedule: [],
            constraints: {},
            anchors: [],
            stationCounts: {},
            backups: [], // New: Backup Array
            theme: 'light'
        };

        // --- Init ---
        function init() {
            const saved = localStorage.getItem('railway_pro_v4');
            if (saved) state = JSON.parse(saved);
            
            // Set Theme
            document.body.setAttribute('data-theme', state.theme || 'light');
            
            // Init Inputs
            document.getElementById('start-date').value = state.startDate;
            
            // Populate Selects
            document.getElementById('anchor-insp').innerHTML = inspectorsDB.map(i => `<option>${i.name}</option>`).join('');
            document.getElementById('anchor-station').innerHTML = stationsDB.map(s => `<option>${s.name}</option>`).join('');
            document.getElementById('gantt-day-filter').innerHTML = days.map((d, i) => `<option value="${i}">${d}</option>`).join('');

            refreshUI();
        }

        function save() {
            state.startDate = document.getElementById('start-date').value;
            localStorage.setItem('railway_pro_v4', JSON.stringify(state));
            refreshUI();
        }

        // --- Core Features: Backups & Theme ---
        
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', state.theme);
            save();
        }

        function createBackup(note = "×’×™×‘×•×™ ××•×˜×•××˜×™") {
            const backup = {
                id: Date.now(),
                date: new Date().toLocaleString('he-IL'),
                note: note,
                data: JSON.parse(JSON.stringify(state)) // Deep copy
            };
            // Limit to last 5 backups
            state.backups.unshift(backup);
            if(state.backups.length > 5) state.backups.pop();
        }

        function showBackupsModal() {
            const list = document.getElementById('backups-list');
            list.innerHTML = state.backups.map(b => `
                <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700 rounded-lg border border-color">
                    <div class="text-sm">
                        <div class="font-bold">${b.date}</div>
                        <div class="text-xs text-muted">${b.note}</div>
                    </div>
                    <button onclick="restoreBackup(${b.id})" class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded font-bold hover:bg-blue-200">×©×—×–×¨</button>
                </div>
            `).join('');
            if(state.backups.length === 0) list.innerHTML = '<div class="text-center text-muted p-4">××™×Ÿ ×’×™×‘×•×™×™× ×–××™× ×™×</div>';
            document.getElementById('backups-modal').classList.remove('hidden');
        }

        function restoreBackup(id) {
            const backup = state.backups.find(b => b.id === id);
            if(backup && confirm("×”×× ×œ×©×—×–×¨ ×œ×’×¨×¡×” ×-" + backup.date + "?")) {
                // Keep backups array, restore everything else
                const currentBackups = state.backups;
                state = JSON.parse(JSON.stringify(backup.data));
                state.backups = currentBackups;
                save();
                location.reload();
            }
        }

        // --- Logic Engine (Simplified for brevity but functional) ---
        function runGenerator() {
            createBackup("×œ×¤× ×™ ×”×¨×¦×ª ×©×™×‘×•×¥ ×—×“×©"); // Create Backup
            state.schedule = [];
            stationsDB.forEach(s => state.stationCounts[s.name] = 0);
            
            const startObj = new Date(document.getElementById('start-date').value);

            for (let d = 0; d < 7; d++) {
                const dateStr = new Date(startObj.getTime() + d * 86400000).toISOString().split('T')[0];

                inspectorsDB.forEach(insp => {
                    if (state.constraints[`${insp.name}_${dateStr}`]) return;
                    
                    let time = insp.shift === "×‘×•×§×¨" ? "06:00" : "14:00";
                    let end = insp.shift === "×‘×•×§×¨" ? "14:30" : "22:30";
                    let loc = insp.start;

                    // Anchors
                    const dayAnchors = state.anchors.filter(a => a.inspector === insp.name && parseInt(a.dayIndex) === d).sort((a,b)=>a.time.localeCompare(b.time));

                    let safety = 0;
                    while(time < end && safety < 60) {
                        safety++;
                        
                        // Check Anchor proximity
                        const nextAnc = dayAnchors.find(a => a.time >= time);
                        if(nextAnc) {
                            const travel = calcTravel(loc, nextAnc.station);
                            const tDiff = timeDiff(time, nextAnc.time);
                            if(tDiff <= travel + 10) {
                                if(loc !== nextAnc.station) {
                                    addTask(d, dateStr, insp.name, "× ×™×•×“", nextAnc.station, time, travel, "travel");
                                    time = addMin(time, travel);
                                }
                                if(time < nextAnc.time) {
                                    addTask(d, dateStr, insp.name, "×”××ª× ×”", nextAnc.station, time, timeDiff(time, nextAnc.time), "admin");
                                    time = nextAnc.time;
                                }
                                addTask(d, dateStr, insp.name, "×¢×•×’×Ÿ", nextAnc.station, time, 45, "anchor");
                                state.stationCounts[nextAnc.station]++;
                                time = addMin(time, 45);
                                loc = nextAnc.station;
                                continue;
                            }
                        }

                        // Regular
                        let nextSt = findBest(loc);
                        let trvl = calcTravel(loc, nextSt.name);
                        
                        if(nextAnc && addMin(time, trvl+35) > nextAnc.time) {
                            addTask(d, dateStr, insp.name, "×”××ª× ×”", loc, time, 15, "admin");
                            time = addMin(time, 15);
                        } else {
                            if(trvl > 5) {
                                addTask(d, dateStr, insp.name, "× ×¡×™×¢×”", nextSt.name, time, trvl, "travel");
                                time = addMin(time, trvl);
                            }
                            addTask(d, dateStr, insp.name, "×‘×§×¨×ª ×ª×—× ×”", nextSt.name, time, 30, "inspection");
                            state.stationCounts[nextSt.name]++;
                            time = addMin(time, 30);
                            loc = nextSt.name;
                        }
                    }
                    if(time < end) addTask(d, dateStr, insp.name, "×¡×’×™×¨×”", "××©×¨×“", time, timeDiff(time, end), "admin");
                });
            }
            save();
            showTab('gantt');
        }

        function findBest(curr) {
            let best=null, min=Infinity;
            const cGeo = stationsDB.find(s=>s.name===curr)?.geo || 1;
            stationsDB.forEach(s => {
                if(s.name===curr) return;
                let score = Math.abs(s.geo - cGeo)*2 + (state.stationCounts[s.name]||0)*10;
                if(score<min) { min=score; best=s; }
            });
            return best || stationsDB[0];
        }

        function calcTravel(l1,l2) {
            const s1=stationsDB.find(s=>s.name===l1), s2=stationsDB.find(s=>s.name===l2);
            return (s1&&s2) ? Math.abs(s1.geo - s2.geo)*3+5 : 10;
        }

        function addTask(idx, date, insp, task, loc, start, dur, type) {
            state.schedule.push({ 
                id: Date.now() + Math.random(), // Unique ID for DragDrop
                dIdx: idx, date, inspector: insp, task, loc, start, dur, type, end: addMin(start, dur) 
            });
        }

        function addMin(t, m) {
            let [h,n] = t.split(':').map(Number);
            return new Date(0,0,0,h,n+m).toTimeString().substring(0,5);
        }
        function timeDiff(t1,t2) {
            let [h1,m1] = t1.split(':').map(Number);
            let [h2,m2] = t2.split(':').map(Number);
            return (h2*60+m2)-(h1*60+m1);
        }

        // --- Render UI ---
        function refreshUI() {
            renderConstraintsTable();
            renderAnchorsList();
            renderScheduleTable();
            renderStationsKPI();
            document.getElementById('stat-total-jobs').innerText = state.schedule.length;
            renderGantt();
        }

        // --- Gantt Drag & Drop Logic ---
        
        function renderGantt() {
            const dIdx = parseInt(document.getElementById('gantt-day-filter').value);
            const header = document.getElementById('gantt-header');
            const area = document.getElementById('gantt-area');
            
            // Render Header
            header.innerHTML = `<div class="gantt-label bg-slate-100 dark:bg-slate-800">×‘×§×¨ / ×©×¢×”</div>`;
            for(let h=6; h<=23; h++) header.innerHTML += `<div class="flex-grow text-center text-[10px] font-bold text-muted border-r border-color min-w-[80px]">${h}:00</div>`;

            // Render Rows
            const pxPerMin = 1.333; // 80px / 60min
            area.innerHTML = inspectorsDB.map(insp => {
                const date = new Date(new Date(state.startDate).getTime() + dIdx*86400000).toISOString().split('T')[0];
                const isOff = state.constraints[`${insp.name}_${date}`];
                const tasks = state.schedule.filter(s => s.dIdx === dIdx && s.inspector === insp.name);
                
                let rowHtml = `<div class="gantt-row ${isOff?'bg-red-50/20':''}" ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${insp.name}', ${dIdx})">
                    <div class="gantt-label">${insp.name}</div>
                    <div class="gantt-timeline">`;
                
                // Grid lines
                for(let i=0; i<=18; i++) rowHtml += `<div class="absolute h-full border-r border-color border-dashed pointer-events-none" style="left:${i*80}px"></div>`;

                if(!isOff) {
                    // Check conflicts
                    const conflicts = checkConflicts(tasks);

                    rowHtml += tasks.map(t => {
                        let [h,m] = t.start.split(':').map(Number);
                        let left = ((h*60+m) - 360) * pxPerMin;
                        let width = t.dur * pxPerMin;
                        let bg = t.type === 'travel' ? 'bg-travel' : t.type==='anchor' ? 'bg-anchor' : t.type==='inspection' ? 'bg-inspection' : 'bg-admin';
                        if(conflicts.includes(t.id)) bg = "conflict"; // Red Pulse

                        return `<div class="gantt-block ${bg}" 
                                style="left:${left}px; width:${width}px;" 
                                draggable="true" 
                                ondragstart="handleDragStart(event, ${t.id})"
                                title="${t.task} (${t.start}-${t.end})">
                                ${width > 40 ? `<span class="truncate font-bold">${t.loc}</span>` : ''}
                                ${width > 60 ? `<span class="opacity-80 text-[9px]">${t.start}</span>` : ''}
                            </div>`;
                    }).join('');
                } else {
                    rowHtml += `<div class="absolute inset-0 flex items-center justify-center text-red-400 font-bold italic">×™×•× ×—×•×¤×© / ××—×œ×”</div>`;
                }

                return rowHtml + `</div></div>`;
            }).join('');

            checkAllConflicts();
        }

        // -- Drag Drop Handlers --
        let draggedTaskId = null;

        function handleDragStart(e, id) {
            draggedTaskId = id;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', id); // For Firefox
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary for Drop
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e, newInspName, dIdx) {
            e.preventDefault();
            const task = state.schedule.find(t => t.id === draggedTaskId);
            if (!task) return;

            // Calculate new time based on drop position X
            const rect = e.currentTarget.querySelector('.gantt-timeline').getBoundingClientRect();
            const offsetX = e.clientX - rect.left + e.currentTarget.scrollLeft; // Account for scroll
            const pxPerMin = 1.333;
            
            const totalMins = offsetX / pxPerMin;
            const newStartMins = 360 + totalMins; // Start from 06:00 (360 mins)
            
            // Round to nearest 5 mins
            const roundedMins = Math.round(newStartMins / 5) * 5;
            
            const h = Math.floor(roundedMins / 60);
            const m = Math.round(roundedMins % 60);
            const newTimeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;

            // Update Task
            task.start = newTimeStr;
            task.end = addMin(newTimeStr, task.dur);
            task.inspector = newInspName; // Allow moving between inspectors
            task.dIdx = dIdx;

            save(); // Saves and Re-renders Gantt
        }

        function checkConflicts(tasks) {
            let ids = [];
            for(let i=0; i<tasks.length; i++) {
                for(let j=i+1; j<tasks.length; j++) {
                    let t1 = tasks[i], t2 = tasks[j];
                    if(t1.start < t2.end && t1.end > t2.start) {
                        ids.push(t1.id, t2.id);
                    }
                }
            }
            return ids;
        }

        function checkAllConflicts() {
            const alertBox = document.getElementById('conflict-alerts');
            alertBox.innerHTML = '';
            let found = false;
            
            // Group by Day and Inspector
            for(let d=0; d<7; d++) {
                inspectorsDB.forEach(insp => {
                    const tasks = state.schedule.filter(s => s.dIdx === d && s.inspector === insp.name);
                    const conflicts = checkConflicts(tasks);
                    if(conflicts.length > 0) {
                        found = true;
                        alertBox.innerHTML += `<div class="text-red-500 font-bold border-b border-slate-100 pb-1">âš ï¸ ×”×ª× ×’×©×•×ª: ${insp.name} ×‘×™×•× ${days[d]}</div>`;
                    }
                });
            }
            if(!found) alertBox.innerHTML = `<p class="text-green-500 font-bold text-sm">âœ“ ×”×œ×•"×– ×ª×§×™×Ÿ</p>`;
        }

        // --- Standard Renders ---
        function renderConstraintsTable() {
            const startObj = new Date(state.startDate);
            document.getElementById('constraints-body').innerHTML = inspectorsDB.map(insp => {
                let row = `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition"><td class="p-3 text-right bg-card sticky left-0 font-bold border-l border-color">${insp.name}</td>`;
                for(let i=0; i<7; i++) {
                    const date = new Date(startObj.getTime() + i*86400000).toISOString().split('T')[0];
                    row += `<td class="p-3 border-l border-color"><input type="checkbox" class="w-5 h-5 accent-blue-600" ${state.constraints[`${insp.name}_${date}`]?'checked':''} onchange="updateConst('${insp.name}','${date}',this.checked)"></td>`;
                }
                return row + `</tr>`;
            }).join('');
        }
        function updateConst(n,d,v) { if(v) state.constraints[`${n}_${d}`]='sick'; else delete state.constraints[`${n}_${d}`]; save(); }
        
        function addAnchor() {
            const t = document.getElementById('anchor-time').value;
            if(!t) return;
            state.anchors.push({id:Date.now(), inspector:document.getElementById('anchor-insp').value, dayIndex:document.getElementById('anchor-day').value, time:t, station:document.getElementById('anchor-station').value});
            save(); renderAnchorsList();
        }
        function renderAnchorsList() {
            document.getElementById('anchors-list').innerHTML = state.anchors.map(a => `<div class="bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-100 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2">âš“ ${a.inspector} ${days[a.dayIndex]} ${a.time} <button onclick="removeAnchor(${a.id})" class="hover:text-red-500">âœ•</button></div>`).join('');
        }
        function removeAnchor(id) { state.anchors = state.anchors.filter(a=>a.id!==id); save(); renderAnchorsList(); }

        function renderScheduleTable() {
            document.getElementById('schedule-body').innerHTML = state.schedule.map(j => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition border-b border-color">
                    <td class="p-3 text-muted font-bold">${days[j.dIdx]}</td><td class="p-3 font-bold">${j.inspector}</td><td class="p-3">${j.task}</td><td class="p-3 text-muted">${j.loc}</td><td class="p-3 font-mono">${j.start}-${j.end}</td>
                </tr>`).join('');
        }

        function renderStationsKPI() {
            document.getElementById('stations-body').innerHTML = stationsDB.map(st => {
                const act = state.stationCounts[st.name] || 0;
                const pct = Math.min(100, Math.round((act/st.target)*100));
                return `<tr class="border-b border-color">
                    <td class="p-4 font-bold">${st.name}</td><td class="p-4 text-center text-muted">${st.target}</td><td class="p-4 text-center font-black">${act}</td>
                    <td class="p-4"><div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full overflow-hidden"><div class="h-full ${pct<70?'bg-red-500':pct<100?'bg-amber-500':'bg-green-500'}" style="width:${pct}%"></div></div></td>
                </tr>`;
            }).join('');
        }
        
        function exportCSV() {
            let csv = "\uFEFF×™×•×,×‘×§×¨,××©×™××”,××™×§×•×,×”×ª×—×œ×”,×¡×™×•×\n" + state.schedule.map(j => `${days[j.dIdx]},${j.inspector},${j.task},${j.loc},${j.start},${j.end}`).join('\n');
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); link.download="schedule.csv"; link.click();
        }

        function resetSystem() { if(confirm("×œ××—×•×§ ×”×›×œ?")) { localStorage.removeItem('railway_pro_v4'); location.reload(); } }

        window.onload = init;
    </script>
</body>
</html>
