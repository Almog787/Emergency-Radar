<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuantIntel Pro | Ultimate Terminal</title>
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono&display=swap');
        
        :root {
            --primary: #3b82f6;
            --bg-dark: #0f172a;
            --panel: #1e293b;
            --positive: #10b981;
            --negative: #f43f5e;
        }

        body { 
            background-color: var(--bg-dark); 
            color: #f1f5f9; 
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* נמנע מכפל גלילה, המכולות הפנימיות יגללו */
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
        }

        /* Watchlist styles */
        .watchlist-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .active-stock {
            background: rgba(59, 130, 246, 0.15) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        /* Tab styling */
        .tab-btn {
            position: relative;
            padding: 0.5rem 1rem;
            font-weight: 700;
            font-size: 0.75rem;
            color: #94a3b8;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: #fff;
            background: var(--primary);
            border-radius: 0.5rem;
        }

        /* Chart stability */
        #chart-container {
            width: 100%;
            height: 100%;
            min-height: 350px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        [dir="rtl"] .text-left-align { text-align: right; }
        [dir="ltr"] .text-left-align { text-align: left; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="h-16 shrink-0 glass-card rounded-none border-b flex items-center justify-between px-6 z-50">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg">
                <i class="fas fa-microchip text-white text-xl"></i>
            </div>
            <h1 class="font-black text-xl tracking-tighter uppercase italic">Quant<span class="text-blue-500">Intel</span></h1>
        </div>

        <div class="flex items-center gap-4">
            <div class="flex bg-slate-800 rounded-lg p-1 border border-white/5">
                <button onclick="setLang('en')" id="btn-en" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all active tab-active bg-blue-600 text-white">EN</button>
                <button onclick="setLang('he')" id="btn-he" class="px-3 py-1 text-[10px] font-bold rounded-md transition-all text-slate-400">עב</button>
            </div>
            <div id="clock" class="hidden sm:block text-xs font-bold font-mono text-slate-400 tracking-widest">00:00:00</div>
        </div>
    </header>

    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        
        <!-- Sidebar Watchlist -->
        <aside class="w-full lg:w-80 bg-slate-900/50 border-b lg:border-b-0 lg:border-r border-white/5 flex flex-col shrink-0 overflow-hidden">
            <div class="p-4 hidden lg:block">
                <h3 id="ui-watchlist-label" class="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em]">Market Watchlist</h3>
            </div>
            <div id="rankings-list" class="flex lg:flex-col p-2 gap-2 overflow-x-auto lg:overflow-y-auto no-scrollbar lg:pb-10">
                <!-- Data from JS -->
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
            
            <!-- Asset Header Card -->
            <div class="glass-card p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-6 w-full md:w-auto">
                    <div>
                        <h2 id="v-symbol" class="text-5xl font-black italic tracking-tighter text-white leading-none">---</h2>
                        <div id="v-name" class="text-slate-500 text-xs font-bold uppercase mt-2">Select an asset</div>
                    </div>
                    <div class="px-6 border-l border-white/10 ml-4 hidden md:block">
                        <div id="ui-price-label" class="text-[10px] text-slate-500 uppercase font-black mb-1">Market Price</div>
                        <div id="v-price" class="text-3xl font-bold font-mono">---</div>
                    </div>
                </div>
                <div class="flex items-center gap-6 md:text-right">
                    <div class="px-4 border-r border-white/10 md:border-0">
                        <div id="ui-score-label" class="text-[10px] text-slate-500 uppercase font-black mb-1">AI Health Score</div>
                        <div id="v-score" class="text-4xl font-black text-blue-500">--</div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="space-y-4">
                <div class="flex justify-between items-center px-2">
                    <div class="flex gap-2 bg-slate-900 rounded-xl p-1 shadow-inner">
                        <button onclick="switchView('interactive')" id="tab-int" class="tab-btn active">Interactive</button>
                        <button onclick="switchView('static')" id="tab-stat" class="tab-btn">Institutional</button>
                    </div>
                    <div id="v-change-badge" class="text-xs font-bold px-3 py-1 rounded-full bg-slate-800">---</div>
                </div>

                <div class="glass-card p-1 min-h-[400px] lg:h-[550px] shadow-2xl relative bg-slate-950/50" id="chart-wrapper">
                    <!-- הגרף ימלא את המקום הזה -->
                    <div id="chart-container"></div>
                    <div id="static-view" class="hidden absolute inset-0 flex items-center justify-center p-4">
                        <img id="v-chart-img" class="max-h-full rounded-xl shadow-2xl border border-white/5" src="" alt="Institutional Graph">
                    </div>
                </div>
            </div>

            <!-- Stats & Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-card p-6 md:col-span-2">
                    <h4 id="ui-signals-label" class="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest">Intelligence Signals</h4>
                    <div id="v-signals" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="glass-card p-6 flex flex-col justify-center border-l-4 border-blue-600">
                    <div id="ui-adx-label" class="text-[10px] text-slate-500 font-black uppercase mb-1">Trend Strength (ADX)</div>
                    <div id="v-adx" class="text-2xl font-black text-white italic">--</div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const i18n = {
            en: { price: "Price", score: "AI Score", signals: "Signals", int: "Interactive", stat: "Institutional", dir: "ltr", watchlist: "Market Watchlist" },
            he: { price: "מחיר", score: "ציון AI", signals: "איתותים", int: "אינטראקטיבי", stat: "מוסדי", dir: "rtl", watchlist: "רשימת מעקב" }
        };

        let currentLang = 'en', chart, candleSeries, currentRankings = [], activeSymbol = '', resizeObserver;

        async function init() {
            try {
                const res = await fetch('data/market_rankings.json?v=' + Date.now());
                currentRankings = await res.json();
                renderWatchlist();
                if(currentRankings.length) loadStock(currentRankings[0]);
                
                setInterval(() => {
                    document.getElementById('clock').innerText = new Date().toLocaleTimeString();
                }, 1000);
            } catch (e) {
                console.error("Initialization failed. Data not ready?");
            }
        }

        function setLang(lang) {
            currentLang = lang;
            const data = i18n[lang];
            document.documentElement.dir = data.dir;
            document.getElementById('ui-price-label').innerText = data.price;
            document.getElementById('ui-score-label').innerText = data.score;
            document.getElementById('ui-signals-label').innerText = data.signals;
            document.getElementById('tab-int').innerText = data.int;
            document.getElementById('tab-stat').innerText = data.stat;
            document.getElementById('ui-watchlist-label').innerText = data.watchlist;
            
            document.getElementById('btn-en').className = lang === 'en' ? "px-3 py-1 text-[10px] font-bold rounded-md bg-blue-600 text-white shadow-lg" : "px-3 py-1 text-[10px] font-bold rounded-md text-slate-400";
            document.getElementById('btn-he').className = lang === 'he' ? "px-3 py-1 text-[10px] font-bold rounded-md bg-blue-600 text-white shadow-lg" : "px-3 py-1 text-[10px] font-bold rounded-md text-slate-400";
            
            renderWatchlist();
        }

        function renderWatchlist() {
            const list = document.getElementById('rankings-list');
            list.innerHTML = currentRankings.map(s => `
                <div onclick="loadStockByName('${s.symbol}')" class="flex-shrink-0 w-32 lg:w-full p-4 rounded-2xl lg:rounded-none border lg:border-0 lg:border-b border-white/5 cursor-pointer hover:bg-white/5 transition flex flex-col lg:flex-row lg:justify-between lg:items-center ${s.symbol === activeSymbol ? 'active-stock' : ''}">
                    <div>
                        <div class="text-white font-black text-sm lg:text-lg italic">${s.symbol}</div>
                        <div class="text-[8px] text-slate-500 font-bold uppercase truncate max-w-[80px] lg:max-w-none">${s.name}</div>
                    </div>
                    <div class="text-right mt-2 lg:mt-0">
                        <div class="text-[10px] lg:text-xs font-bold text-blue-400 mono">${s.score}</div>
                        <div class="text-[8px] lg:text-[10px] ${s.change >= 0 ? 'text-emerald-500' : 'text-rose-500'} font-black">${s.change >= 0 ? '+' : ''}${s.change.toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');
        }

        function loadStockByName(sym) {
            const stock = currentRankings.find(x => x.symbol === sym);
            loadStock(stock);
        }

        async function loadStock(s) {
            activeSymbol = s.symbol;
            renderWatchlist();

            document.getElementById('v-symbol').innerText = s.symbol;
            document.getElementById('v-name').innerText = s.name;
            document.getElementById('v-price').innerText = `$${s.price.toFixed(2)}`;
            document.getElementById('v-score').innerText = s.score;
            document.getElementById('v-adx').innerText = s.adx.toFixed(1);
            
            const chgBadge = document.getElementById('v-change-badge');
            chgBadge.innerText = `${s.change >= 0 ? '+' : ''}${s.change.toFixed(2)}%`;
            chgBadge.className = `text-xs font-bold px-3 py-1 rounded-full ${s.change >= 0 ? 'bg-emerald-500/10 text-emerald-500' : 'bg-rose-500/10 text-rose-500'}`;

            // Update Static Chart Image
            document.getElementById('v-chart-img').src = `charts/${s.symbol.toLowerCase()}.png?v=${Date.now()}`;

            // Update Signals
            const signals = currentLang === 'en' ? s.signals.en : s.signals.he;
            document.getElementById('v-signals').innerHTML = signals.map(sig => 
                `<span class="bg-slate-800 text-blue-400 text-[9px] md:text-[10px] px-2 py-1 rounded-lg border border-white/5 font-bold uppercase">${sig}</span>`
            ).join('');

            // Load & Render Interactive Data
            const res = await fetch(`data/${s.symbol.toLowerCase()}_daily.json?v=` + Date.now());
            const detail = await res.json();
            renderChart(detail.history);
        }

        function renderChart(data) {
            const container = document.getElementById('chart-container');
            if (chart) {
                chart.remove();
            }

            chart = LightweightCharts.createChart(container, {
                layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#64748b', fontSize: 11 },
                grid: { vertLines: { color: 'rgba(255,255,255,0.02)' }, horzLines: { color: 'rgba(255,255,255,0.02)' } },
                timeScale: { borderColor: 'rgba(255,255,255,0.1)', timeVisible: false },
                rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)' },
                handleScroll: { vertTouchDrag: false }
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#10b981', downColor: '#f43f5e', borderVisible: false, wickUpColor: '#10b981', wickDownColor: '#f43f5e'
            });

            // Convert to valid Chart items
            const formatted = data.map(d => ({
                time: d.Date.split(' ')[0], // Clean YYYY-MM-DD
                open: parseFloat(d.Open),
                high: parseFloat(d.High),
                low: parseFloat(d.Low),
                close: parseFloat(d.Close)
            }));

            candleSeries.setData(formatted);

            // SMA 200 Overlay
            const smaLine = chart.addLineSeries({ color: '#f59e0b', lineWidth: 1.5, priceLineVisible: false });
            smaLine.setData(data.filter(d => d.SMA200 > 0).map(d => ({ time: d.Date.split(' ')[0], value: d.SMA200 })));

            chart.timeScale().fitContent();

            // RESPONSIVE FIX: האזנה לשינויי גודל של ה-Container עצמו
            if (resizeObserver) resizeObserver.disconnect();
            resizeObserver = new ResizeObserver(entries => {
                const { width, height } = entries[0].contentRect;
                chart.resize(width, height);
                chart.timeScale().fitContent();
            });
            resizeObserver.observe(container);
        }

        function switchView(view) {
            const chartDiv = document.getElementById('chart-container');
            const staticDiv = document.getElementById('static-view');
            const tabInt = document.getElementById('tab-int');
            const tabStat = document.getElementById('tab-stat');

            if(view === 'interactive') {
                chartDiv.classList.remove('hidden');
                staticDiv.classList.add('hidden');
                tabInt.classList.add('active');
                tabStat.classList.remove('active');
            } else {
                chartDiv.classList.add('hidden');
                staticDiv.classList.remove('hidden');
                tabStat.classList.add('active');
                tabInt.classList.remove('active');
            }
        }

        init();
    </script>
</body>
</html>
