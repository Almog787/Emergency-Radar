<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLOBAL RADAR PRO | Live Traffic & Emergency</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;500;800&family=Orbitron:wght@400;700;900&display=swap');
        
        body { background-color: #000; margin: 0; overflow: hidden; color: #00ff41; font-family: 'JetBrains Mono', monospace; }
        .hud-panel { background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(0, 243, 255, 0.2); pointer-events: auto; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        /* Scanline and Glow */
        .scan-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 50%, rgba(0, 243, 255, 0.03) 50%); background-size: 100% 4px; z-index: 5; pointer-events: none; }
        
        .emergency-item { border-right: 3px solid #ff003c; background: rgba(255, 0, 60, 0.1); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <div class="scan-overlay"></div>
    <div id="globeViz" class="absolute inset-0 z-0"></div>

    <!-- HUD Elements -->
    <div class="absolute inset-0 pointer-events-none flex flex-col p-6 z-10">
        
        <!-- Top Bar -->
        <header class="flex justify-between items-start mb-6 pointer-events-none">
            <div class="flex items-center gap-6 pointer-events-auto">
                <div class="hud-panel p-4 rounded-2xl border-cyan-500/30">
                    <i class="fas fa-radar text-2xl text-cyan-400 animate-spin-slow"></i>
                </div>
                <div>
                    <h1 class="orbitron text-2xl font-black text-white tracking-tighter">GLOBAL_RADAR_PRO</h1>
                    <p class="text-[10px] font-bold text-cyan-500 opacity-70 uppercase tracking-widest">Live Airspace Intercept v9.0</p>
                </div>
            </div>

            <div class="hud-panel px-6 py-2 rounded-xl text-right pointer-events-auto">
                <div id="clock" class="orbitron text-xl font-bold text-white">00:00:00</div>
                <div class="text-[8px] text-cyan-500 font-black uppercase tracking-widest">Satellite Sync Active</div>
            </div>
        </header>

        <div class="flex-1 flex gap-6 overflow-hidden">
            <!-- Left: Live Feed -->
            <aside class="w-80 flex flex-col gap-6 pointer-events-auto overflow-hidden">
                <div class="hud-panel rounded-3xl flex-1 flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center font-bold">
                        <span class="text-xs uppercase tracking-widest">Active_Emergencies</span>
                        <span id="emergency-count" class="text-red-500 orbitron">0</span>
                    </div>
                    <div id="emergency-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                        <div class="p-10 text-center opacity-30 italic text-xs">Scanning for Squawk 7700...</div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="hud-panel p-5 rounded-3xl space-y-2">
                    <div class="flex justify-between text-[10px] font-bold">
                        <span>GLOBAL_TRAFFIC</span>
                        <span id="total-count" class="text-white">0</span>
                    </div>
                    <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden">
                        <div id="load-bar" class="bg-cyan-500 h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-[9px] opacity-50 font-bold uppercase mt-2">
                        <span>Audio: <button onclick="toggleAudio()" id="audio-status" class="text-cyan-400">ON</button></span>
                        <span>Lang: <button onclick="toggleLang()" class="text-cyan-400">EN/HE</button></span>
                    </div>
                </div>
            </aside>

            <!-- Center: Focus Panel -->
            <div class="flex-1 flex items-end justify-center pb-10">
                <div id="focus-hud" class="hud-panel px-10 py-6 rounded-3xl border-cyan-500/50 hidden animate-bounce">
                    <div class="flex items-center gap-10 text-center">
                        <div>
                            <div class="text-[8px] font-bold text-cyan-500 uppercase">Target_ID</div>
                            <div id="f-id" class="orbitron text-2xl font-black text-white tracking-widest">---</div>
                        </div>
                        <div class="h-10 w-px bg-cyan-900/50"></div>
                        <div>
                            <div class="text-[8px] font-bold text-slate-500 uppercase">Country_Origin</div>
                            <div id="f-country" class="text-xs font-bold text-slate-200">---</div>
                        </div>
                        <div class="h-10 w-px bg-cyan-900/50"></div>
                        <div>
                            <div class="text-[8px] font-bold text-slate-500 uppercase">Altitude</div>
                            <div id="f-alt" class="text-xs font-bold text-white">0 m</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- System State ---
        let audioEnabled = true;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // --- Globe Setup ---
        const world = Globe()
            (document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
            .showAtmosphere(true)
            .atmosphereColor('#00f3ff')
            .pointColor(p => p.emergency ? '#ff003c' : '#00ff41')
            .pointRadius(p => p.emergency ? 0.25 : 0.08)
            .pointAltitude(p => p.alt / 100000) // Visual altitude scaling
            .pointLabel(p => `
                <div style="background: rgba(0,0,0,0.8); color: white; padding: 5px; border: 1px solid ${p.emergency ? 'red' : 'cyan'}; border-radius: 4px; font-family: monospace; font-size: 10px;">
                    <b>ID: ${p.id}</b><br>
                    Origin: ${p.country}<br>
                    Altitude: ${Math.round(p.alt)}m<br>
                    Squawk: ${p.squawk || 'None'}
                </div>
            `)
            .onPointClick(p => focusTarget(p));

        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.3;

        // --- Audio Synth ---
        function playPing(isEmergency = false) {
            if (!audioEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(isEmergency ? 330 : 880, audioCtx.currentTime);
            osc.type = isEmergency ? 'sawtooth' : 'sine';
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (isEmergency ? 1 : 0.4));
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + (isEmergency ? 1 : 0.4));
        }

        // --- Main Data Engine ---
        async function updateRadar() {
            try {
                // Fetching OpenSky States
                const res = await fetch('https://opensky-network.org/api/states/all');
                const data = await res.json();
                
                // Process only planes with coordinates
                const allPlanes = data.states
                    .filter(s => s[5] && s[6]) // Longitude & Latitude must exist
                    .map(s => ({
                        id: s[1]?.trim() || 'UNK',
                        lng: s[5],
                        lat: s[6],
                        alt: s[7] || 0,
                        country: s[2],
                        squawk: s[14],
                        emergency: s[14] === "7700"
                    }));

                const emergencies = allPlanes.filter(p => p.emergency);
                
                // Update Globe
                world.pointsData(allPlanes);

                // Update UI Stats
                document.getElementById('total-count').innerText = allPlanes.length.toLocaleString();
                document.getElementById('emergency-count').innerText = emergencies.length;
                document.getElementById('load-bar').style.width = Math.min((allPlanes.length / 10000) * 100, 100) + "%";

                // Update Sidebar List
                updateEmergencySidebar(emergencies);

                if (emergencies.length > 0) playPing(true);

            } catch (e) {
                console.error("ðŸ“¡ Signal Lost. Retrying link...");
            }
        }

        function updateEmergencySidebar(emergencies) {
            const list = document.getElementById('emergency-list');
            if (emergencies.length === 0) {
                list.innerHTML = `<div class="p-10 text-center opacity-20 text-xs italic">Airspace Secure (No 7700 Detected)</div>`;
                return;
            }

            list.innerHTML = emergencies.map(p => `
                <div class="p-3 rounded-xl cursor-pointer emergency-item flex justify-between items-center" 
                     onclick="focusTarget({lat: ${p.lat}, lng: ${p.lng}, id: '${p.id}', country: '${p.country}', alt: ${p.alt}})">
                    <div>
                        <div class="text-[10px] font-black text-white">${p.id}</div>
                        <div class="text-[8px] text-red-500 uppercase font-bold">SQUAWK 7700</div>
                    </div>
                    <i class="fas fa-crosshairs text-red-500 text-xs"></i>
                </div>
            `).join('');
        }

        function focusTarget(p) {
            playPing(false);
            
            // Move Camera smoothly
            world.pointOfView({ lat: p.lat, lng: p.lng, altitude: 0.4 }, 1500);
            
            // Show Focus HUD
            const hud = document.getElementById('focus-hud');
            hud.classList.remove('hidden');
            document.getElementById('f-id').innerText = p.id;
            document.getElementById('f-country').innerText = p.country;
            document.getElementById('f-alt').innerText = Math.round(p.alt).toLocaleString() + " m";
        }

        // --- UI Utilities ---
        function toggleAudio() {
            audioEnabled = !audioEnabled;
            document.getElementById('audio-status').innerText = audioEnabled ? "ON" : "OFF";
            if (audioEnabled) audioCtx.resume();
        }

        function toggleCinema() {
            document.body.classList.toggle('cinema-mode');
        }

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB');
        }, 1000);

        // Initial Run
        updateRadar();
        setInterval(updateRadar, 30000); // Update every 30 seconds

        window.addEventListener('resize', () => {
            world.width(window.innerWidth).height(window.innerHeight);
        });
    </script>
</body>
</html>
