<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×©×™×‘×•×¥ ××ª×§×“××ª - R-Light Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        :root { --primary: #1e3a8a; --secondary: #3b82f6; --bg-light: #f8fafc; }
        body { font-family: 'Assistant', sans-serif; background-color: var(--bg-light); color: #1e293b; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn.active { border-bottom: 3px solid var(--secondary); color: var(--primary); font-weight: 800; background-color: #eff6ff; }
        th { background-color: #1e293b; color: white; position: sticky; top: 0; z-index: 10; }
        .gantt-container { overflow-x: auto; white-space: nowrap; padding-bottom: 20px; }
        .gantt-row { display: flex; border-bottom: 1px solid #e2e8f0; height: 50px; align-items: center; position: relative; }
        .gantt-label { width: 150px; flex-shrink: 0; font-weight: bold; padding-right: 10px; position: sticky; right: 0; background: white; z-index: 5; border-left: 2px solid #ddd; }
        .gantt-timeline { position: relative; flex-grow: 1; min-width: 1200px; height: 100%; background: repeating-linear-gradient(90deg, #fff, #fff 59px, #f1f5f9 60px); }
        .gantt-block { position: absolute; height: 70%; top: 15%; border-radius: 6px; font-size: 11px; display: flex; justify-content: center; align-items: center; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; cursor: pointer; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .gantt-block:hover { transform: scale(1.05); z-index: 20; }
        .kpi-alert { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black tracking-wider flex items-center gap-2">
                    <span class="text-blue-400">âš¡</span> R-Light Pro
                </h1>
                <p class="text-xs text-slate-400">××¢×¨×›×ª ×©×™×‘×•×¥ ×—×›××” | ×ª×™×§×•×Ÿ ×œ×•×œ××” | Gantt</p>
            </div>
            <div class="flex gap-3">
                <button onclick="resetSystem()" class="text-xs bg-red-800 hover:bg-red-700 px-3 py-1 rounded transition">××¤×¡ ××¢×¨×›×ª</button>
                <div class="text-right hidden md:block">
                    <div id="header-date" class="font-bold"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b shadow-sm sticky top-[70px] z-40">
        <div class="container mx-auto flex overflow-x-auto">
            <button onclick="showTab('dashboard')" class="nav-btn active flex-1 py-3 px-4 font-bold text-slate-600 min-w-[100px]">×œ×•×— ×‘×§×¨×”</button>
            <button onclick="showTab('constraints')" class="nav-btn flex-1 py-3 px-4 font-bold text-slate-600 min-w-[120px]">××™×œ×•×¦×™× ×•×¢×•×’× ×™×</button>
            <button onclick="showTab('gantt')" class="nav-btn flex-1 py-3 px-4 font-bold text-slate-600 min-w-[100px]">×ª×¨×©×™× Gantt</button>
            <button onclick="showTab('schedule')" class="nav-btn flex-1 py-3 px-4 font-bold text-slate-600 min-w-[100px]">×˜×‘×œ×ª ×©×™×‘×•×¥</button>
            <button onclick="showTab('stations')" class="nav-btn flex-1 py-3 px-4 font-bold text-slate-600 min-w-[100px]">×¡×˜×˜×•×¡ ×ª×—× ×•×ª</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 min-h-screen pb-20">

        <!-- Tab 1: Dashboard -->
        <div id="dashboard" class="tab-content block fade-in space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800">ğŸš€ ×”×¨×¦×ª ×©×™×‘×•×¥</h2>
                    <label class="text-sm font-bold text-slate-500">×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×'):</label>
                    <input type="date" id="start-date" class="w-full mt-1 mb-4 p-2 border rounded-lg bg-slate-50">
                    <button onclick="generateSchedule()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">
                        ×‘×¦×¢ ×©×™×‘×•×¥ ×—×›×
                    </button>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-700">âš ï¸ ×”×ª×¨××•×ª KPI</h2>
                    <div id="dashboard-alerts" class="space-y-2 max-h-[150px] overflow-y-auto italic text-slate-400 text-sm">×˜×¨× ×‘×•×¦×¢ ×©×™×‘×•×¥...</div>
                </div>
                <div class="bg-slate-800 text-white p-6 rounded-2xl shadow text-center">
                    <div class="text-4xl font-black text-blue-400 mb-2" id="stat-total-jobs">0</div>
                    <div class="text-sm uppercase opacity-70">××©×™××•×ª ×©×•×‘×¦×•</div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Constraints -->
        <div id="constraints" class="tab-content hidden fade-in space-y-6">
            <div class="bg-white rounded-2xl shadow overflow-hidden">
                <div class="p-4 bg-slate-100 border-b font-bold">ğŸ¥ × ×™×”×•×œ ×”×™×¢×“×¨×•×™×•×ª</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center text-sm">
                        <thead class="bg-slate-800 text-white">
                            <tr>
                                <th class="p-3 text-right sticky left-0 z-20 bg-slate-800">×‘×§×¨</th>
                                <th class="p-3">×</th><th class="p-3">×‘</th><th class="p-3">×’</th><th class="p-3">×“</th><th class="p-3">×”</th><th class="p-3">×•</th><th class="p-3">×©</th>
                            </tr>
                        </thead>
                        <tbody id="constraints-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
                <h3 class="text-lg font-bold mb-4 italic">âš“ ×”×•×¡×¤×ª ×¢×•×’×Ÿ ×™×“× ×™</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <select id="anchor-insp" class="border p-2 rounded"></select>
                    <select id="anchor-day" class="border p-2 rounded">
                        <option value="0">×¨××©×•×Ÿ</option><option value="1">×©× ×™</option><option value="2">×©×œ×™×©×™</option><option value="3">×¨×‘×™×¢×™</option><option value="4">×—××™×©×™</option><option value="5">×©×™×©×™</option><option value="6">×©×‘×ª</option>
                    </select>
                    <input type="time" id="anchor-time" class="border p-2 rounded">
                    <select id="anchor-station" class="border p-2 rounded"></select>
                    <button onclick="addAnchor()" class="bg-green-600 text-white font-bold py-2 rounded">×”×•×¡×£ ×¢×•×’×Ÿ</button>
                </div>
                <div id="anchors-list" class="mt-4 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Tab 3: Gantt -->
        <div id="gantt" class="tab-content hidden fade-in">
            <div class="bg-white p-4 rounded-t-xl border-x border-t flex justify-between">
                <h2 class="font-bold italic text-slate-700">×ª×¨×©×™× Gantt ×©×‘×•×¢×™</h2>
                <select id="gantt-day-filter" onchange="renderGantt()" class="border p-1 rounded font-bold text-blue-700"></select>
            </div>
            <div id="gantt-area" class="gantt-container bg-white border p-4 shadow-inner"></div>
        </div>

        <!-- Tab 4: Schedule -->
        <div id="schedule" class="tab-content hidden fade-in">
            <div class="bg-white rounded-xl shadow overflow-x-auto">
                <table class="w-full text-right text-sm">
                    <thead>
                        <tr><th class="p-3">×™×•×</th><th class="p-3">×‘×§×¨</th><th class="p-3">××©×™××”</th><th class="p-3">××™×§×•×</th><th class="p-3">×–×× ×™×</th></tr>
                    </thead>
                    <tbody id="schedule-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab 5: Stations -->
        <div id="stations" class="tab-content hidden fade-in">
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead>
                        <tr><th class="p-3">×ª×—× ×”</th><th class="p-3">×™×¢×“ ×©×‘×•×¢×™</th><th class="p-3">×‘×•×¦×¢</th><th class="p-3 w-1/3">×”×ª×§×“××•×ª</th></tr>
                    </thead>
                    <tbody id="stations-body"></tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // --- ××¡×“ × ×ª×•× ×™× ---
        const stationsDB = [
            { name: "×ª× ×¤×ª", geo: 1, target: 20 }, { name: "×¤×™× ×¡×§×¨", geo: 2, target: 20 },
            { name: "×§×¨×™×ª ××¨×™×”", geo: 4, target: 25 }, { name: "×©× ×§×¨", geo: 6, target: 20 },
            { name: "××”×¨×•× ×•×‘×™×¥", geo: 9, target: 30 }, { name: "×‘×Ÿ ×’×•×¨×™×•×Ÿ", geo: 11, target: 30 },
            { name: "×‘×™××œ×™×§", geo: 12, target: 30 }, { name: "××¨×œ×•×–×•×¨×•×‘", geo: 14, target: 35 },
            { name: "×©××•×œ ×”××œ×š", geo: 15, target: 35 }, { name: "×§×¨×œ×™×‘×š", geo: 17, target: 30 },
            { name: "××œ× ×‘×™", geo: 18, target: 30 }, { name: "××œ×™×¤×œ×˜", geo: 19, target: 25 },
            { name: "×‘×œ×•××¤×™×œ×“", geo: 21, target: 20 }, { name: "×™×¤×•", geo: 23, target: 20 },
            { name: "×™×•×¡×¤×˜×œ", geo: 28, target: 25 }, { name: "×‘×œ×¤×•×¨", geo: 30, target: 25 },
            { name: "×‘× ×™××™×Ÿ", geo: 31, target: 25 }, { name: "×”×§×•×××™×•×ª", geo: 34, target: 25 }
        ];

        const inspectorsDB = [
            { name: "×“× ×™××œ ××‘×¨×”×", shift: "×‘×•×§×¨", start: "×ª× ×¤×ª" }, { name: "×¨×•× ×™×ª ×œ×•×™", shift: "×‘×•×§×¨", start: "×”×§×•×××™×•×ª" },
            { name: "×™×•×¡×™ ×›×”×Ÿ", shift: "×‘×•×§×¨", start: "××œ×™×¤×œ×˜" }, { name: "××™×›×œ ×©×—×¨", shift: "×‘×•×§×¨", start: "×©××•×œ ×”××œ×š" },
            { name: "××‘×™ ×‘×™×˜×•×Ÿ", shift: "×‘×•×§×¨", start: "×‘×Ÿ ×’×•×¨×™×•×Ÿ" }, { name: "×©×¨×” ×’×•×œ×Ÿ", shift: "×‘×•×§×¨", start: "×™×•×¡×¤×˜×œ" },
            { name: "×¢×•××¨ ×¤×¨×¥", shift: "×‘×•×§×¨", start: "×§×¨×™×ª ××¨×™×”" }, { name: "× ×•×¢×” ×§×™×¨×œ", shift: "×‘×•×§×¨", start: "×‘×œ×¤×•×¨" },
            { name: "××œ×™×¨×Ÿ ×¡×‘×’", shift: "×¢×¨×‘", start: "×ª× ×¤×ª" }, { name: "×’×œ×™×ª ×“×™×¡×˜×œ", shift: "×¢×¨×‘", start: "×”×§×•×××™×•×ª" },
            { name: "××©×” ××©×›× ×–×™", shift: "×¢×¨×‘", start: "××¨×œ×•×–×•×¨×•×‘" }, { name: "×“× ×” ×¤×¨×™×“×¨", shift: "×¢×¨×‘", start: "××œ× ×‘×™" },
            { name: "×’×™× ×–×•-××¨×¥", shift: "×¢×¨×‘", start: "×§×¨×™×ª ××¨×™×”" }, { name: "×¨×•×ª× ×¡×œ×¢", shift: "×¢×¨×‘", start: "×™×¤×•" },
            { name: "××¡×™ ×¢×–×¨", shift: "×¢×¨×‘", start: "×©××•×œ ×”××œ×š" }
        ];

        const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "×©×‘×ª"];
        
        let state = {
            startDate: new Date().toISOString().split('T')[0],
            schedule: [],
            constraints: {},
            anchors: [],
            stationCounts: {}
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×œ×™×‘×” ---
        function init() {
            const saved = localStorage.getItem('railwaySchedulerStateV2');
            if (saved) state = JSON.parse(saved);
            
            document.getElementById('start-date').value = state.startDate;
            document.getElementById('header-date').innerText = new Date().toLocaleDateString('he-IL');

            const iSel = document.getElementById('anchor-insp');
            const sSel = document.getElementById('anchor-station');
            iSel.innerHTML = inspectorsDB.map(i => `<option>${i.name}</option>`).join('');
            sSel.innerHTML = stationsDB.map(s => `<option>${s.name}</option>`).join('');

            renderConstraintsTable();
            renderAnchorsList();
            if(state.schedule.length) {
                renderScheduleTable();
                renderStationsKPI();
                renderGanttFilters();
                updateDashboardStats();
            }
        }

        function save() {
            state.startDate = document.getElementById('start-date').value;
            localStorage.setItem('railwaySchedulerStateV2', JSON.stringify(state));
        }

        function resetSystem() {
            if(confirm("×œ××¤×¡ ×”×›×œ?")) { localStorage.removeItem('railwaySchedulerStateV2'); location.reload(); }
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            if(id === 'gantt') renderGantt();
        }

        // --- ××œ×’×•×¨×™×ª× ×©×™×‘×•×¥ (×¢× ×ª×™×§×•×Ÿ ×œ×•×œ××” ××™× ×¡×•×¤×™×ª) ---
        function generateSchedule() {
            state.schedule = [];
            stationsDB.forEach(s => state.stationCounts[s.name] = 0);
            const startObj = new Date(document.getElementById('start-date').value);

            for (let dIdx = 0; dIdx < 7; dIdx++) {
                const dateStr = new Date(startObj.getTime() + dIdx*86400000).toISOString().split('T')[0];

                inspectorsDB.forEach(insp => {
                    if (state.constraints[`${insp.name}_${dateStr}`]) return;

                    let currentTime = insp.shift === "×‘×•×§×¨" ? "06:00" : "14:00";
                    const shiftEnd = insp.shift === "×‘×•×§×¨" ? "14:30" : "22:30";
                    let currentLoc = insp.start;
                    
                    const dayAnchors = state.anchors
                        .filter(a => a.inspector === insp.name && a.dayIndex === dIdx)
                        .sort((a,b) => a.time.localeCompare(b.time));

                    let safetyNet = 0; // ×”×’× ×” ××œ×•×œ××” ××™× ×¡×•×¤×™×ª

                    while (currentTime < shiftEnd && safetyNet < 50) {
                        safetyNet++;
                        
                        const nextAnchor = dayAnchors.find(a => a.time >= currentTime);
                        
                        // ×‘×“×™×§×ª ×œ×—×¥ ×–××Ÿ ×œ×¢×•×’×Ÿ
                        if (nextAnchor) {
                            const travelToAnchor = calcTravel(currentLoc, nextAnchor.station);
                            const tToA = timeDiff(currentTime, nextAnchor.time);
                            
                            if (tToA <= travelToAnchor + 10) {
                                if(currentLoc !== nextAnchor.station) {
                                    addJob(dIdx, dateStr, insp.name, "× ×™×•×“ ×œ×¢×•×’×Ÿ", nextAnchor.station, currentTime, travelToAnchor, "travel");
                                    currentTime = addMinutes(currentTime, travelToAnchor);
                                }
                                if(currentTime < nextAnchor.time) {
                                    addJob(dIdx, dateStr, insp.name, "×”××ª× ×” ×œ×¢×•×’×Ÿ", nextAnchor.station, currentTime, timeDiff(currentTime, nextAnchor.time), "admin");
                                    currentTime = nextAnchor.time;
                                }
                                addJob(dIdx, dateStr, insp.name, "×¢×•×’×Ÿ ×™×“× ×™", nextAnchor.station, currentTime, 45, "anchor");
                                state.stationCounts[nextAnchor.station]++;
                                currentTime = addMinutes(currentTime, 45);
                                currentLoc = nextAnchor.station;
                                continue;
                            }
                        }

                        // ×©×™×‘×•×¥ ×¨×’×™×œ
                        let nextSt = findBest(currentLoc);
                        const travel = calcTravel(currentLoc, nextSt.name);
                        const totalNeeded = travel + 35; // × ×¡×™×¢×” + ×–××Ÿ ×‘×§×¨×” ××™× ×™××œ×™

                        if (nextAnchor && addMinutes(currentTime, totalNeeded) > nextAnchor.time) {
                            // ××™×Ÿ ×–××Ÿ ×œ××©×™××” ×©×œ××” ×œ×¤× ×™ ×”×¢×•×’×Ÿ
                            addJob(dIdx, dateStr, insp.name, "×× ×”×œ×”/×”××ª× ×”", currentLoc, currentTime, 15, "admin");
                            currentTime = addMinutes(currentTime, 15);
                        } else {
                            if(travel > 5) {
                                addJob(dIdx, dateStr, insp.name, "× ×¡×™×¢×”", nextSt.name, currentTime, travel, "travel");
                                currentTime = addMinutes(currentTime, travel);
                            }
                            addJob(dIdx, dateStr, insp.name, "×‘×§×¨×ª ×ª×—× ×”", nextSt.name, currentTime, 30, "inspection");
                            state.stationCounts[nextSt.name]++;
                            currentTime = addMinutes(currentTime, 30);
                            currentLoc = nextSt.name;
                        }
                    }
                    
                    if (currentTime < shiftEnd) {
                        addJob(dIdx, dateStr, insp.name, "×¡×’×™×¨×ª ××©××¨×ª", "×§×¦×”", currentTime, timeDiff(currentTime, shiftEnd), "admin");
                    }
                });
            }
            save();
            renderScheduleTable();
            renderStationsKPI();
            renderGanttFilters();
            updateDashboardStats();
            showTab('gantt');
        }

        // --- ×¢×–×¨×™ ×—×™×©×•×‘ ---
        function findBest(curr) {
            let best = null, min = Infinity;
            const cSt = stationsDB.find(s => s.name === curr) || stationsDB[0]; // ×× ×™×¢×ª ×§×¨×™×¡×” ×× ×”××™×§×•× ×”×•× "××©×¨×“"
            stationsDB.forEach(s => {
                if(s.name === curr) return;
                const d = Math.abs(s.geo - cSt.geo);
                const score = d * 2 + (state.stationCounts[s.name] || 0) * 10;
                if(score < min) { min = score; best = s; }
            });
            return best;
        }

        function calcTravel(l1, l2) {
            const s1 = stationsDB.find(s => s.name === l1);
            const s2 = stationsDB.find(s => s.name === l2);
            if(!s1 || !s2) return 10;
            return Math.abs(s1.geo - s2.geo) * 3 + 5;
        }

        function addMinutes(t, m) {
            const [h, min] = t.split(':').map(Number);
            const d = new Date(0,0,0, h, min + m);
            return d.toTimeString().substring(0,5);
        }

        function timeDiff(t1, t2) {
            const [h1, m1] = t1.split(':').map(Number);
            const [h2, m2] = t2.split(':').map(Number);
            return (h2*60 + m2) - (h1*60 + m1);
        }

        function addJob(dIdx, date, insp, task, loc, start, dur, type) {
            if(dur <= 0) return;
            state.schedule.push({ dIdx, date, inspector: insp, task, loc, start, dur, type, end: addMinutes(start, dur) });
        }

        // --- ×¨×™× ×“×•×¨ ×××©×§ ---
        function renderConstraintsTable() {
            const tbody = document.getElementById('constraints-body');
            tbody.innerHTML = inspectorsDB.map(insp => {
                let row = `<tr class="border-b"><td class="p-2 font-bold text-right bg-white sticky left-0">${insp.name}</td>`;
                for(let i=0; i<7; i++) {
                    const date = new Date(new Date(state.startDate).getTime() + i*86400000).toISOString().split('T')[0];
                    const key = `${insp.name}_${date}`;
                    row += `<td class="p-2 border-l"><input type="checkbox" ${state.constraints[key]?'checked':''} onchange="updateConst('${insp.name}','${date}',this.checked)"></td>`;
                }
                return row + `</tr>`;
            }).join('');
        }

        function updateConst(name, date, val) {
            if(val) state.constraints[`${name}_${date}`] = 'sick';
            else delete state.constraints[`${name}_${date}`];
            save();
        }

        function addAnchor() {
            state.anchors.push({
                id: Date.now(),
                inspector: document.getElementById('anchor-insp').value,
                dayIndex: parseInt(document.getElementById('anchor-day').value),
                time: document.getElementById('anchor-time').value,
                station: document.getElementById('anchor-station').value
            });
            save(); renderAnchorsList();
        }

        function renderAnchorsList() {
            document.getElementById('anchors-list').innerHTML = state.anchors.map(a => `
                <div class="bg-purple-100 p-1 px-2 rounded text-[10px] flex gap-2">
                    ${a.inspector} | ${days[a.dayIndex]} ${a.time} | <button onclick="removeAnchor(${a.id})" class="text-red-600 font-bold">X</button>
                </div>
            `).join('');
        }

        function removeAnchor(id) { state.anchors = state.anchors.filter(a => a.id !== id); save(); renderAnchorsList(); }

        function renderScheduleTable() {
            document.getElementById('schedule-body').innerHTML = state.schedule.map(j => `
                <tr class="border-b ${j.type==='travel'?'bg-slate-50 italic':''}">
                    <td class="p-2 text-xs">${days[j.dIdx]}</td><td class="p-2 font-bold">${j.inspector}</td>
                    <td class="p-2">${j.task}</td><td class="p-2">${j.loc}</td><td class="p-2 font-mono">${j.start}-${j.end}</td>
                </tr>
            `).join('');
        }

        function renderStationsKPI() {
            const alertBox = document.getElementById('dashboard-alerts');
            alertBox.innerHTML = "";
            document.getElementById('stations-body').innerHTML = stationsDB.map(st => {
                const act = state.stationCounts[st.name] || 0;
                const pct = Math.min(100, Math.round((act/st.target)*100));
                if(pct < 80) alertBox.innerHTML += `<div class="bg-red-50 p-1 text-[10px] border-b">${st.name}: ${act}/${st.target}</div>`;
                return `<tr class="border-b ${pct<80?'kpi-alert':''}">
                    <td class="p-3 font-bold">${st.name}</td><td class="p-3 text-center">${st.target}</td>
                    <td class="p-3 text-center font-black">${act}</td>
                    <td class="p-3"><div class="w-full bg-gray-200 h-2 rounded"><div class="bg-green-600 h-2 rounded" style="width:${pct}%"></div></div></td>
                </tr>`;
            }).join('');
        }

        function renderGanttFilters() {
            document.getElementById('gantt-day-filter').innerHTML = days.map((d,i) => `<option value="${i}">${d}</option>`).join('');
        }

        function renderGantt() {
            const dIdx = parseInt(document.getElementById('gantt-day-filter').value);
            const area = document.getElementById('gantt-area');
            const pxMin = 1.5;
            area.innerHTML = inspectorsDB.map(insp => {
                const tasks = state.schedule.filter(s => s.dIdx === dIdx && s.inspector === insp.name);
                return `<div class="gantt-row"><div class="gantt-label">${insp.name}</div><div class="gantt-timeline">
                    ${tasks.map(t => {
                        const [h,m] = t.start.split(':').map(Number);
                        const left = ((h*60 + m) - 360) * pxMin;
                        const width = t.dur * pxMin;
                        let color = "bg-blue-600";
                        if(t.type==='travel') color="bg-amber-400";
                        if(t.type==='admin') color="bg-slate-400";
                        if(t.type==='anchor') color="bg-purple-600";
                        return `<div class="gantt-block ${color}" style="left:${left}px; width:${width}px" title="${t.task}">${t.dur>15?t.loc:''}</div>`;
                    }).join('')}
                </div></div>`;
            }).join('');
        }

        function updateDashboardStats() { document.getElementById('stat-total-jobs').innerText = state.schedule.length; }

        window.onload = init;
    </script>
</body>
</html>
