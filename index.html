<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-Light Pro - ××¢×¨×›×ª ×©×™×‘×•×¥ ×©×‘×•×¢×™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        :root { --primary: #1e3a8a; --secondary: #3b82f6; --bg-light: #f8fafc; }
        body { font-family: 'Assistant', sans-serif; background-color: var(--bg-light); color: #1e293b; overflow-x: hidden; }
        
        /* Tabs Transition */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Navigation Styles */
        .nav-btn.active { border-bottom: 4px solid var(--secondary); color: var(--primary); font-weight: 800; background-color: #eff6ff; }
        
        /* Improved Gantt Styles */
        .gantt-container { overflow-x: auto; position: relative; background: white; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
        .gantt-header { display: flex; border-bottom: 2px solid #e2e8f0; background: #f1f5f9; position: sticky; top: 0; z-index: 20; }
        .gantt-row { display: flex; border-bottom: 1px solid #f1f5f9; height: 60px; align-items: center; position: relative; transition: background 0.2s; }
        .gantt-row:hover { background: #f8fafc; }
        .gantt-label { width: 160px; flex-shrink: 0; font-weight: bold; padding: 0 1rem; position: sticky; right: 0; background: white; z-index: 10; border-left: 2px solid #e2e8f0; box-shadow: -2px 0 5px rgba(0,0,0,0.05); }
        
        .gantt-timeline { position: relative; flex-grow: 1; min-width: 1440px; height: 100%; }
        .gantt-grid-line { position: absolute; top: 0; bottom: 0; border-right: 1px dashed #e2e8f0; pointer-events: none; }
        
        .gantt-block { position: absolute; height: 75%; top: 12.5%; border-radius: 8px; font-size: 11px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 0 4px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .gantt-block:hover { transform: scale(1.02); z-index: 30; filter: brightness(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .gantt-block .time-tag { font-size: 9px; opacity: 0.9; font-weight: normal; }

        /* Type Colors */
        .bg-inspection { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .bg-travel { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bg-admin { background: linear-gradient(135deg, #64748b, #475569); }
        .bg-anchor { background: linear-gradient(135deg, #9333ea, #7e22ce); }

        .kpi-alert { animation: borderPulse 2s infinite; }
        @keyframes borderPulse { 0% { border-color: #ef4444; } 50% { border-color: #fee2e2; } 100% { border-color: #ef4444; } }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black tracking-wider flex items-center gap-2 italic">
                    <span class="text-blue-400">âš¡</span> R-LIGHT <span class="text-blue-500 text-sm font-normal">PRO</span>
                </h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-left">
                    <div id="header-date" class="text-sm font-bold text-slate-300"></div>
                </div>
                <button onclick="resetSystem()" class="bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white px-3 py-1 rounded-lg text-xs font-bold transition-all border border-red-600/50">××¤×¡ ××¢×¨×›×ª</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b shadow-md sticky top-[64px] z-40">
        <div class="container mx-auto flex overflow-x-auto no-scrollbar">
            <button onclick="showTab('dashboard')" id="btn-dashboard" class="nav-btn active flex-1 py-4 px-6 font-bold text-slate-600 transition-all whitespace-nowrap">×œ×•×— ×‘×§×¨×”</button>
            <button onclick="showTab('constraints')" id="btn-constraints" class="nav-btn flex-1 py-4 px-6 font-bold text-slate-600 transition-all whitespace-nowrap">××™×œ×•×¦×™× ×•×¢×•×’× ×™×</button>
            <button onclick="showTab('gantt')" id="btn-gantt" class="nav-btn flex-1 py-4 px-6 font-bold text-slate-600 transition-all whitespace-nowrap">×ª×¨×©×™× ×’×× ×˜</button>
            <button onclick="showTab('schedule')" id="btn-schedule" class="nav-btn flex-1 py-4 px-6 font-bold text-slate-600 transition-all whitespace-nowrap">×˜×‘×œ×ª ×©×™×‘×•×¥</button>
            <button onclick="showTab('stations')" id="btn-stations" class="nav-btn flex-1 py-4 px-6 font-bold text-slate-600 transition-all whitespace-nowrap">×¡×˜×˜×•×¡ ×ª×—× ×•×ª</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6 min-h-screen">

        <!-- Tab: Dashboard -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 text-slate-800 flex items-center gap-2">ğŸš€ ×”×¨×¦×ª ×©×™×‘×•×¥</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 block mb-1">×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×'):</label>
                            <input type="date" id="start-date" class="w-full p-3 border rounded-xl bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                        </div>
                        <button onclick="generateSchedule()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl shadow-lg transition-all transform active:scale-95 shadow-blue-200">
                            ×‘×¦×¢ ×©×™×‘×•×¥ ×©×‘×•×¢×™ ×—×›×
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 text-red-600 flex items-center gap-2">âš ï¸ ×”×ª×¨××•×ª KPI</h2>
                    <div id="dashboard-alerts" class="space-y-2 max-h-[180px] overflow-y-auto">
                        <p class="text-sm text-slate-400 italic">×˜×¨× ×‘×•×¦×¢ ×©×™×‘×•×¥ ×œ×©×‘×•×¢ ×”× ×•×›×—×™...</p>
                    </div>
                </div>

                <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-sm flex flex-col justify-center items-center text-center">
                    <div class="text-5xl font-black text-blue-400 mb-2" id="stat-total-jobs">0</div>
                    <div class="text-sm uppercase tracking-widest text-slate-400 font-bold">××©×™××•×ª ×©×•×‘×¦×• ×”×©×‘×•×¢</div>
                </div>
            </div>
        </div>

        <!-- Tab: Constraints -->
        <div id="constraints" class="tab-content space-y-6">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b font-bold flex justify-between items-center text-slate-700">
                    <span>ğŸ¥ × ×™×”×•×œ ×”×™×¢×“×¨×•×™×•×ª (××—×œ×”/×—×•×¤×©)</span>
                    <span class="text-xs font-normal text-slate-500 italic">×©×™× ×•×™×™× × ×©××¨×™× ××•×˜×•××˜×™×ª</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center text-sm">
                        <thead class="bg-slate-800 text-white">
                            <tr>
                                <th class="p-4 text-right sticky left-0 z-20 bg-slate-800">×©× ×”×‘×§×¨</th>
                                <th class="p-4">×'</th><th class="p-4">×‘'</th><th class="p-4">×’'</th><th class="p-4">×“'</th><th class="p-4">×”'</th><th class="p-4">×•'</th><th class="p-4">×©'</th>
                            </tr>
                        </thead>
                        <tbody id="constraints-body" class="divide-y"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
                <h3 class="text-lg font-bold mb-4 text-slate-800 flex items-center gap-2">âš“ ×”×•×¡×¤×ª ×¢×•×’×Ÿ ×™×“× ×™ (××©×™××” ×§×©×™×—×”)</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">×‘×§×¨</label>
                        <select id="anchor-insp" class="w-full border p-2.5 rounded-lg bg-slate-50 outline-none"></select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">×™×•×</label>
                        <select id="anchor-day" class="w-full border p-2.5 rounded-lg bg-slate-50 outline-none">
                            <option value="0">×¨××©×•×Ÿ</option><option value="1">×©× ×™</option><option value="2">×©×œ×™×©×™</option><option value="3">×¨×‘×™×¢×™</option><option value="4">×—××™×©×™</option><option value="5">×©×™×©×™</option><option value="6">×©×‘×ª</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">×©×¢×”</label>
                        <input type="time" id="anchor-time" class="w-full border p-2.5 rounded-lg bg-slate-50 outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">×ª×—× ×”</label>
                        <select id="anchor-station" class="w-full border p-2.5 rounded-lg bg-slate-50 outline-none"></select>
                    </div>
                    <button onclick="addAnchor()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-black py-2.5 rounded-lg shadow-md transition-all">×”×•×¡×£ ×¢×•×’×Ÿ</button>
                </div>
                <div id="anchors-list" class="mt-6 flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Tab: Gantt -->
        <div id="gantt" class="tab-content space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold text-slate-800">×ª×¨×©×™× ×’×× ×˜ ×•×™×–×•××œ×™</h2>
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-slate-500">×‘×—×¨ ×™×•× ×œ×ª×¦×•×’×”:</label>
                    <select id="gantt-day-filter" onchange="renderGantt()" class="border-2 border-blue-100 p-2 rounded-xl font-bold text-blue-700 focus:border-blue-500 outline-none"></select>
                </div>
            </div>

            <div class="gantt-container shadow-xl">
                <!-- Hour Header -->
                <div class="gantt-header" id="gantt-header"></div>
                <!-- Rows -->
                <div id="gantt-area" class="divide-y"></div>
            </div>
            
            <div class="flex flex-wrap gap-4 justify-center mt-4">
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-inspection"></div><span class="text-xs font-bold">×‘×§×¨×ª ×ª×—× ×”</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-travel"></div><span class="text-xs font-bold">× ×¡×™×¢×”</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-anchor"></div><span class="text-xs font-bold">×¢×•×’×Ÿ ×™×“× ×™</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-admin"></div><span class="text-xs font-bold">×× ×”×œ×”/×¡×’×™×¨×”</span></div>
            </div>
        </div>

        <!-- Tab: Schedule Table -->
        <div id="schedule" class="tab-content space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">×˜×‘×œ×ª ×©×™×‘×•×¥ ××¤×•×¨×˜×ª</h2>
                <button onclick="exportCSV()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-700 transition-all">×™×™×¦×•× ×œ-Excel</button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-800 text-white">
                        <tr>
                            <th class="p-4">×™×•×</th>
                            <th class="p-4">×‘×§×¨</th>
                            <th class="p-4">××©×™××”</th>
                            <th class="p-4">××™×§×•×</th>
                            <th class="p-4">×©×¢×•×ª</th>
                            <th class="p-4">×¡×•×’</th>
                        </tr>
                    </thead>
                    <tbody id="schedule-body" class="divide-y"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Stations KPI -->
        <div id="stations" class="tab-content">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-100 text-slate-700">
                        <tr>
                            <th class="p-4">×ª×—× ×”</th>
                            <th class="p-4 text-center">×™×¢×“ ×©×‘×•×¢×™</th>
                            <th class="p-4 text-center">×‘×•×¦×¢ ×‘×¤×•×¢×œ</th>
                            <th class="p-4 w-1/3">×”×ª×§×“××•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="stations-body" class="divide-y"></tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // --- Configuration & Data ---
        const stationsDB = [
            { name: "×ª× ×¤×ª", geo: 1, target: 20 }, { name: "×¤×™× ×¡×§×¨", geo: 2, target: 20 },
            { name: "×§×¨×™×ª ××¨×™×”", geo: 4, target: 25 }, { name: "×©× ×§×¨", geo: 6, target: 20 },
            { name: "××”×¨×•× ×•×‘×™×¥", geo: 9, target: 30 }, { name: "×‘×Ÿ ×’×•×¨×™×•×Ÿ", geo: 11, target: 30 },
            { name: "×‘×™××œ×™×§", geo: 12, target: 30 }, { name: "××¨×œ×•×–×•×¨×•×‘", geo: 14, target: 35 },
            { name: "×©××•×œ ×”××œ×š", geo: 15, target: 35 }, { name: "×§×¨×œ×™×‘×š", geo: 17, target: 30 },
            { name: "××œ× ×‘×™", geo: 18, target: 30 }, { name: "××œ×™×¤×œ×˜", geo: 19, target: 25 },
            { name: "×‘×œ×•××¤×™×œ×“", geo: 21, target: 20 }, { name: "×™×¤×•", geo: 23, target: 20 },
            { name: "×™×•×¡×¤×˜×œ", geo: 28, target: 25 }, { name: "×‘×œ×¤×•×¨", geo: 30, target: 25 },
            { name: "×‘× ×™××™×Ÿ", geo: 31, target: 25 }, { name: "×”×§×•×××™×•×ª", geo: 34, target: 25 }
        ];

        const inspectorsDB = [
            { name: "×“× ×™××œ ××‘×¨×”×", shift: "×‘×•×§×¨", start: "×ª× ×¤×ª" }, { name: "×¨×•× ×™×ª ×œ×•×™", shift: "×‘×•×§×¨", start: "×”×§×•×××™×•×ª" },
            { name: "×™×•×¡×™ ×›×”×Ÿ", shift: "×‘×•×§×¨", start: "××œ×™×¤×œ×˜" }, { name: "××™×›×œ ×©×—×¨", shift: "×‘×•×§×¨", start: "×©××•×œ ×”××œ×š" },
            { name: "××‘×™ ×‘×™×˜×•×Ÿ", shift: "×‘×•×§×¨", start: "×‘×Ÿ ×’×•×¨×™×•×Ÿ" }, { name: "×©×¨×” ×’×•×œ×Ÿ", shift: "×‘×•×§×¨", start: "×™×•×¡×¤×˜×œ" },
            { name: "×¢×•××¨ ×¤×¨×¥", shift: "×‘×•×§×¨", start: "×§×¨×™×ª ××¨×™×”" }, { name: "× ×•×¢×” ×§×™×¨×œ", shift: "×‘×•×§×¨", start: "×‘×œ×¤×•×¨" },
            { name: "××œ×™×¨×Ÿ ×¡×‘×’", shift: "×¢×¨×‘", start: "×ª× ×¤×ª" }, { name: "×’×œ×™×ª ×“×™×¡×˜×œ", shift: "×¢×¨×‘", start: "×”×§×•×××™×•×ª" },
            { name: "××©×” ××©×›× ×–×™", shift: "×¢×¨×‘", start: "××¨×œ×•×–×•×¨×•×‘" }, { name: "×“× ×” ×¤×¨×™×“×¨", shift: "×¢×¨×‘", start: "××œ× ×‘×™" },
            { name: "×’×™× ×–×•-××¨×¥", shift: "×¢×¨×‘", start: "×§×¨×™×ª ××¨×™×”" }, { name: "×¨×•×ª× ×¡×œ×¢", shift: "×¢×¨×‘", start: "×™×¤×•" },
            { name: "××¡×™ ×¢×–×¨", shift: "×¢×¨×‘", start: "×©××•×œ ×”××œ×š" }
        ];

        const days = ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™", "×—××™×©×™", "×©×™×©×™", "×©×‘×ª"];
        
        let state = {
            startDate: new Date().toISOString().split('T')[0],
            schedule: [],
            constraints: {},
            anchors: [],
            stationCounts: {}
        };

        // --- Core Functions ---

        function init() {
            const saved = localStorage.getItem('railway_pro_state_v3');
            if (saved) {
                state = JSON.parse(saved);
            }
            
            document.getElementById('start-date').value = state.startDate;
            document.getElementById('header-date').innerText = new Date().toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Populate Selects
            document.getElementById('anchor-insp').innerHTML = inspectorsDB.map(i => `<option>${i.name}</option>`).join('');
            document.getElementById('anchor-station').innerHTML = stationsDB.map(s => `<option>${s.name}</option>`).join('');
            document.getElementById('gantt-day-filter').innerHTML = days.map((d, i) => `<option value="${i}">${d}</option>`).join('');

            refreshUI();
        }

        function save() {
            state.startDate = document.getElementById('start-date').value;
            localStorage.setItem('railway_pro_state_v3', JSON.stringify(state));
        }

        function refreshUI() {
            renderConstraintsTable();
            renderAnchorsList();
            renderScheduleTable();
            renderStationsKPI();
            updateDashboardStats();
            renderGanttHeader();
            renderGantt();
        }

        function resetSystem() {
            if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×•×”×©×™×‘×•×¦×™×?")) {
                localStorage.removeItem('railway_pro_state_v3');
                location.reload();
            }
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-' + id).classList.add('active');
            if (id === 'gantt') renderGantt();
        }

        // --- Logic Engine ---

        function generateSchedule() {
            state.schedule = [];
            // Reset counts for the new simulation
            stationsDB.forEach(s => state.stationCounts[s.name] = 0);
            
            const startObj = new Date(document.getElementById('start-date').value);

            for (let dIdx = 0; dIdx < 7; dIdx++) {
                const currentDate = new Date(startObj.getTime() + dIdx * 86400000);
                const dateStr = currentDate.toISOString().split('T')[0];

                inspectorsDB.forEach(insp => {
                    // Check Leave/Sick
                    if (state.constraints[`${insp.name}_${dateStr}`]) return;

                    let currentTime = insp.shift === "×‘×•×§×¨" ? "06:00" : "14:00";
                    const shiftEnd = insp.shift === "×‘×•×§×¨" ? "14:30" : "22:30";
                    let currentLoc = insp.start;
                    
                    const dayAnchors = state.anchors
                        .filter(a => a.inspector === insp.name && parseInt(a.dayIndex) === dIdx)
                        .sort((a, b) => a.time.localeCompare(b.time));

                    let safetyNet = 0;

                    while (currentTime < shiftEnd && safetyNet < 60) {
                        safetyNet++;
                        
                        const nextAnchor = dayAnchors.find(a => a.time >= currentTime);
                        
                        if (nextAnchor) {
                            const travelToAnchor = calcTravel(currentLoc, nextAnchor.station);
                            const tToA = timeDiffMinutes(currentTime, nextAnchor.time);
                            
                            if (tToA <= travelToAnchor + 10) {
                                if (currentLoc !== nextAnchor.station) {
                                    addJob(dIdx, dateStr, insp.name, "× ×™×•×“ ×œ×¢×•×’×Ÿ", nextAnchor.station, currentTime, travelToAnchor, "travel");
                                    currentTime = addMinutes(currentTime, travelToAnchor);
                                }
                                if (currentTime < nextAnchor.time) {
                                    addJob(dIdx, dateStr, insp.name, "×”××ª× ×”", nextAnchor.station, currentTime, timeDiffMinutes(currentTime, nextAnchor.time), "admin");
                                    currentTime = nextAnchor.time;
                                }
                                addJob(dIdx, dateStr, insp.name, "×¢×•×’×Ÿ ×™×“× ×™", nextAnchor.station, currentTime, 45, "anchor");
                                state.stationCounts[nextAnchor.station]++;
                                currentTime = addMinutes(currentTime, 45);
                                currentLoc = nextAnchor.station;
                                continue;
                            }
                        }

                        let nextSt = findBestStation(currentLoc);
                        const travel = calcTravel(currentLoc, nextSt.name);
                        const totalNeeded = travel + 35; 

                        if (nextAnchor && addMinutes(currentTime, totalNeeded) > nextAnchor.time) {
                            const waitTime = 15;
                            addJob(dIdx, dateStr, insp.name, "×× ×”×œ×”", currentLoc, currentTime, waitTime, "admin");
                            currentTime = addMinutes(currentTime, waitTime);
                        } else {
                            if (travel > 5) {
                                addJob(dIdx, dateStr, insp.name, "× ×¡×™×¢×”", nextSt.name, currentTime, travel, "travel");
                                currentTime = addMinutes(currentTime, travel);
                            }
                            addJob(dIdx, dateStr, insp.name, "×‘×§×¨×ª ×ª×—× ×”", nextSt.name, currentTime, 30, "inspection");
                            state.stationCounts[nextSt.name]++;
                            currentTime = addMinutes(currentTime, 30);
                            currentLoc = nextSt.name;
                        }
                    }
                    
                    if (currentTime < shiftEnd) {
                        addJob(dIdx, dateStr, insp.name, "×¡×’×™×¨×ª ××©××¨×ª", "×§×¦×”", currentTime, timeDiffMinutes(currentTime, shiftEnd), "admin");
                    }
                });
            }
            save();
            refreshUI();
            showTab('gantt');
            alert("×”×©×™×‘×•×¥ ×”×•×©×œ× ×•× ×©××¨ ×‘×”×¦×œ×—×”!");
        }

        function findBestStation(curr) {
            let best = null, min = Infinity;
            const currentStationData = stationsDB.find(s => s.name === curr) || stationsDB[0];
            stationsDB.forEach(s => {
                if (s.name === curr) return;
                const dist = Math.abs(s.geo - currentStationData.geo);
                const score = dist * 2.5 + (state.stationCounts[s.name] || 0) * 12;
                if (score < min) { min = score; best = s; }
            });
            return best;
        }

        function calcTravel(l1, l2) {
            const s1 = stationsDB.find(s => s.name === l1);
            const s2 = stationsDB.find(s => s.name === l2);
            if (!s1 || !s2) return 10;
            return Math.abs(s1.geo - s2.geo) * 3 + 6;
        }

        function addMinutes(t, m) {
            const [h, min] = t.split(':').map(Number);
            const d = new Date(0, 0, 0, h, min + m);
            return d.toTimeString().substring(0, 5);
        }

        function timeDiffMinutes(t1, t2) {
            const [h1, m1] = t1.split(':').map(Number);
            const [h2, m2] = t2.split(':').map(Number);
            return (h2 * 60 + m2) - (h1 * 60 + m1);
        }

        function addJob(dIdx, date, insp, task, loc, start, dur, type) {
            if (dur <= 0) return;
            state.schedule.push({ dIdx, date, inspector: insp, task, loc, start, dur, type, end: addMinutes(start, dur) });
        }

        // --- Render UI ---

        function renderConstraintsTable() {
            const tbody = document.getElementById('constraints-body');
            const startObj = new Date(state.startDate);
            tbody.innerHTML = inspectorsDB.map(insp => {
                let row = `<tr class="hover:bg-slate-50 transition-colors"><td class="p-3 font-bold text-right bg-white sticky left-0 border-l">${insp.name}</td>`;
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startObj.getTime() + i * 86400000).toISOString().split('T')[0];
                    const key = `${insp.name}_${date}`;
                    row += `<td class="p-3 border-l">
                                <input type="checkbox" class="w-5 h-5 accent-blue-600 cursor-pointer" ${state.constraints[key] ? 'checked' : ''} 
                                onchange="updateConst('${insp.name}','${date}',this.checked)">
                            </td>`;
                }
                return row + `</tr>`;
            }).join('');
        }

        function updateConst(name, date, val) {
            if (val) state.constraints[`${name}_${date}`] = 'sick';
            else delete state.constraints[`${name}_${date}`];
            save();
            updateDashboardStats();
        }

        function addAnchor() {
            const time = document.getElementById('anchor-time').value;
            if (!time) return alert("× × ×œ×”×–×™×Ÿ ×©×¢×”");
            state.anchors.push({
                id: Date.now(),
                inspector: document.getElementById('anchor-insp').value,
                dayIndex: document.getElementById('anchor-day').value,
                time: time,
                station: document.getElementById('anchor-station').value
            });
            save();
            renderAnchorsList();
        }

        function removeAnchor(id) {
            state.anchors = state.anchors.filter(a => a.id !== id);
            save();
            renderAnchorsList();
        }

        function renderAnchorsList() {
            document.getElementById('anchors-list').innerHTML = state.anchors.map(a => `
                <div class="bg-purple-50 text-purple-700 border border-purple-200 px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-2">
                    âš“ ${a.inspector} | ${days[a.dayIndex]} ${a.time} | ${a.station}
                    <button onclick="removeAnchor(${a.id})" class="text-purple-400 hover:text-red-500 font-bold ml-1">âœ•</button>
                </div>
            `).join('');
        }

        function renderScheduleTable() {
            document.getElementById('schedule-body').innerHTML = state.schedule.map(j => `
                <tr class="hover:bg-slate-50 transition-colors ${j.type === 'travel' ? 'bg-slate-50/50 italic text-slate-500' : ''}">
                    <td class="p-3 font-bold text-slate-400">${days[j.dIdx]}</td>
                    <td class="p-3 font-bold text-slate-800">${j.inspector}</td>
                    <td class="p-3">
                        <span class="px-2 py-0.5 rounded-md text-[10px] font-bold uppercase ${j.type === 'anchor' ? 'bg-purple-100 text-purple-700' : 'bg-slate-100'}">
                            ${j.task}
                        </span>
                    </td>
                    <td class="p-3">${j.loc}</td>
                    <td class="p-3 font-mono font-bold">${j.start} - ${j.end}</td>
                    <td class="p-3 text-[10px] font-bold text-slate-400 uppercase">${j.type}</td>
                </tr>
            `).join('');
        }

        function renderStationsKPI() {
            const alertBox = document.getElementById('dashboard-alerts');
            alertBox.innerHTML = "";
            let lowKPI = false;

            document.getElementById('stations-body').innerHTML = stationsDB.map(st => {
                const act = state.stationCounts[st.name] || 0;
                const pct = Math.min(100, Math.round((act / st.target) * 100));
                
                if (pct < 70) {
                    lowKPI = true;
                    alertBox.innerHTML += `<div class="bg-red-50 p-2 rounded-lg border border-red-100 text-[11px] text-red-700 font-bold mb-1">×ª×—× ×ª ${st.name} ×‘×¤×™×’×•×¨: ${act}/${st.target}</div>`;
                }

                return `<tr class="${pct < 70 ? 'bg-red-50/30' : ''}">
                    <td class="p-4 font-bold text-slate-700">${st.name}</td>
                    <td class="p-4 text-center text-slate-400">${st.target}</td>
                    <td class="p-4 text-center font-black text-slate-800">${act}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="flex-grow bg-slate-200 h-2 rounded-full overflow-hidden">
                                <div class="h-full ${pct < 40 ? 'bg-red-500' : pct < 80 ? 'bg-amber-500' : 'bg-green-500'} transition-all duration-1000" style="width:${pct}%"></div>
                            </div>
                            <span class="text-[10px] font-bold text-slate-500 w-8">${pct}%</span>
                        </div>
                    </td>
                </tr>`;
            }).join('');

            if (!lowKPI && state.schedule.length > 0) alertBox.innerHTML = `<p class="text-green-600 font-bold text-sm">âœ“ ×›×œ ×”×ª×—× ×•×ª ×¢×•××“×•×ª ×‘×™×¢×“!</p>`;
        }

        // --- Improved Gantt Chart ---

        function renderGanttHeader() {
            const header = document.getElementById('gantt-header');
            header.innerHTML = `<div class="gantt-label bg-slate-200 border-l-2 border-slate-300">×‘×§×¨ / ×©×¢×”</div>`;
            for (let h = 6; h <= 23; h++) {
                header.innerHTML += `<div class="flex-grow text-center text-[10px] font-bold text-slate-500 py-2 border-r border-slate-300 min-w-[80px]">${h < 10 ? '0' + h : h}:00</div>`;
            }
        }

        function renderGantt() {
            const dIdx = parseInt(document.getElementById('gantt-day-filter').value);
            const area = document.getElementById('gantt-area');
            const pxPerMin = 1.333; // (80px per hour / 60)
            
            area.innerHTML = inspectorsDB.map(insp => {
                const tasks = state.schedule.filter(s => s.dIdx === dIdx && s.inspector === insp.name);
                const date = new Date(new Date(state.startDate).getTime() + dIdx * 86400000).toISOString().split('T')[0];
                const isOff = state.constraints[`${insp.name}_${date}`];

                let row = `<div class="gantt-row ${isOff ? 'bg-red-50/50 opacity-60' : ''}">
                             <div class="gantt-label">${insp.name}</div>
                             <div class="gantt-timeline">`;

                // Add grid lines for hours
                for (let i = 0; i <= 17; i++) {
                    row += `<div class="gantt-grid-line" style="left: ${i * 80}px"></div>`;
                }

                if (isOff) {
                    row += `<div class="absolute inset-0 flex items-center justify-center text-red-500 font-bold text-[10px] italic">×—×•×¤×© / ××—×œ×”</div>`;
                } else {
                    row += tasks.map(t => {
                        const [h, m] = t.start.split(':').map(Number);
                        const left = ((h * 60 + m) - 360) * pxPerMin;
                        const width = t.dur * pxPerMin;
                        
                        let colorClass = "bg-admin";
                        if (t.type === 'inspection') colorClass = "bg-inspection";
                        if (t.type === 'travel') colorClass = "bg-travel";
                        if (t.type === 'anchor') colorClass = "bg-anchor";

                        return `<div class="gantt-block ${colorClass}" 
                                     style="left:${left}px; width:${width}px" 
                                     title="${t.task} | ${t.start}-${t.end}">
                                    <span class="font-bold truncate w-full text-center">${width > 40 ? t.loc : ''}</span>
                                    <span class="time-tag">${width > 60 ? t.start : ''}</span>
                                </div>`;
                    }).join('');
                }
                return row + `</div></div>`;
            }).join('');
        }

        function updateDashboardStats() {
            document.getElementById('stat-total-jobs').innerText = state.schedule.length;
        }

        function exportCSV() {
            if (state.schedule.length === 0) return alert("××™×Ÿ ×œ×•\"×– ×œ×™×™×¦×•×");
            let csv = "\uFEFF×™×•×,×‘×§×¨,××©×™××”,××™×§×•×,×”×ª×—×œ×”,×¡×™×•×\n";
            state.schedule.forEach(j => {
                csv += `${days[j.dIdx]},${j.inspector},${j.task},${j.loc},${j.start},${j.end}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Railway_Schedule_${state.startDate}.csv`;
            link.click();
        }

        // Initialize Application
        window.onload = init;
    </script>
</body>
</html>
