<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-Light Enterprise - JSON Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        
        :root { --bg-body: #f8fafc; --bg-card: #ffffff; --text: #0f172a; --border: #e2e8f0; }
        body { font-family: 'Assistant', sans-serif; background: var(--bg-body); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; }
        .content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        
        /* Components */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: bold; transition: 0.2s; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #2563eb; color: white; } .btn-primary:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; color: white; } .btn-danger:hover { background: #b91c1c; }
        .btn-success { background: #16a34a; color: white; }
        
        /* Gantt */
        .gantt-wrapper { overflow-x: auto; background: white; border: 1px solid var(--border); border-radius: 8px; }
        .gantt-row { display: flex; height: 50px; border-bottom: 1px solid #f1f5f9; position: relative; }
        .gantt-label { width: 150px; flex-shrink: 0; border-left: 2px solid #e2e8f0; background: #f8fafc; display: flex; align-items: center; padding-right: 10px; font-weight: bold; position: sticky; right: 0; z-index: 10; }
        .gantt-timeline { flex: 1; min-width: 1000px; position: relative; background: repeating-linear-gradient(90deg, transparent, transparent 59px, #f1f5f9 60px); }
        
        .task-block {
            position: absolute; height: 70%; top: 15%; border-radius: 4px; font-size: 11px;
            color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1; overflow: hidden; white-space: nowrap;
            transition: transform 0.1s;
        }
        .task-block:hover { transform: scale(1.02); z-index: 20; }
        .task-block.violation { border: 2px solid #ef4444; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; items-center; z-index: 100; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* JSON Editor */
        #json-editor { width: 100%; height: 400px; font-family: monospace; font-size: 12px; background: #1e293b; color: #a5b4fc; padding: 10px; border-radius: 8px; }

        /* Colors */
        .bg-insp { background: #3b82f6; } .bg-travel { background: #f59e0b; } .bg-anchor { background: #8b5cf6; } .bg-admin { background: #64748b; }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="main-layout">
        <aside class="sidebar p-4">
            <div class="text-2xl font-black italic mb-8 flex items-center gap-2">
                <i class="fas fa-subway text-blue-400"></i> R-LIGHT <span class="text-xs bg-blue-600 px-1 rounded">JSON</span>
            </div>
            
            <nav class="space-y-2 flex-1">
                <button onclick="showPage('dashboard')" class="w-full text-right p-3 rounded hover:bg-slate-700 font-bold"><i class="fas fa-chart-pie w-6"></i> דאשבורד</button>
                <button onclick="showPage('gantt')" class="w-full text-right p-3 rounded hover:bg-slate-700 font-bold"><i class="fas fa-stream w-6"></i> גאנט ועריכה</button>
                <button onclick="showPage('json')" class="w-full text-right p-3 rounded hover:bg-slate-700 font-bold"><i class="fas fa-code w-6"></i> קובץ נתונים (JSON)</button>
            </nav>

            <div class="mt-auto pt-4 border-t border-slate-700">
                <div class="text-xs text-slate-400 mb-2">סטטוס סנכרון:</div>
                <div id="sync-status" class="flex items-center gap-2 text-green-400 text-sm font-bold">
                    <i class="fas fa-check-circle"></i> מסונכרן
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            
            <!-- PAGE: DASHBOARD -->
            <div id="page-dashboard" class="space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">לוח בקרה ראשי</h1>
                    <div class="flex gap-2">
                        <input type="date" id="start-date" class="border p-2 rounded bg-white">
                        <button onclick="runScheduler()" class="btn btn-primary"><i class="fas fa-magic"></i> צור שיבוץ אוטומטי</button>
                    </div>
                </div>

                <!-- Alerts Section -->
                <div class="card p-4 border-r-4 border-red-500">
                    <h3 class="font-bold text-lg mb-2 text-red-600"><i class="fas fa-exclamation-triangle"></i> חריגות והתראות (Live)</h3>
                    <div id="alerts-list" class="space-y-2 max-h-40 overflow-y-auto text-sm">
                        <div class="text-gray-400 italic">המערכת תקינה.</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card p-6 text-center">
                        <div class="text-4xl font-black text-blue-600" id="stat-tasks">0</div>
                        <div class="text-gray-500 font-bold">משימות פעילות</div>
                    </div>
                    <div class="card p-6 text-center">
                        <div class="text-4xl font-black text-purple-600" id="stat-anchors">0</div>
                        <div class="text-gray-500 font-bold">עוגנים ידניים</div>
                    </div>
                    <div class="card p-6 text-center">
                        <div class="text-4xl font-black text-red-600" id="stat-violations">0</div>
                        <div class="text-gray-500 font-bold">חריגות נהלים</div>
                    </div>
                </div>
            </div>

            <!-- PAGE: GANTT -->
            <div id="page-gantt" class="hidden space-y-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold">עריכת משמרות</h1>
                    <select id="gantt-day-filter" onchange="renderGantt()" class="border p-2 rounded font-bold"></select>
                </div>
                
                <div class="gantt-wrapper shadow-lg">
                    <div id="gantt-header" class="flex border-bottom bg-slate-50">
                        <div class="gantt-label">בקר / שעה</div>
                        <!-- Hours generated by JS -->
                    </div>
                    <div id="gantt-body"></div>
                </div>
                <div class="text-xs text-gray-500 mt-2 flex gap-4">
                    <span><i class="fas fa-square text-blue-500"></i> בקרה</span>
                    <span><i class="fas fa-square text-orange-400"></i> נסיעה</span>
                    <span><i class="fas fa-square text-purple-500"></i> עוגן</span>
                    <span><i class="fas fa-square text-red-500"></i> חריגה (לחץ לעריכה)</span>
                </div>
            </div>

            <!-- PAGE: JSON -->
            <div id="page-json" class="hidden space-y-4">
                <h1 class="text-2xl font-bold">ניהול קובץ נתונים (DB)</h1>
                <p class="text-sm text-gray-600">זהו הלב של המערכת. כל שינוי כאן ישפיע מיד על התצוגה וההתראות.</p>
                
                <div class="flex gap-2 mb-2">
                    <button onclick="downloadJSON()" class="btn btn-success text-xs"><i class="fas fa-download"></i> הורד קובץ</button>
                    <button onclick="document.getElementById('file-input').click()" class="btn btn-primary text-xs"><i class="fas fa-upload"></i> טען קובץ</button>
                    <input type="file" id="file-input" class="hidden" onchange="uploadJSON(this)">
                    <button onclick="saveJsonFromEditor()" class="btn btn-primary text-xs ml-auto"><i class="fas fa-save"></i> שמור שינויים ידניים</button>
                </div>
                
                <textarea id="json-editor" spellcheck="false"></textarea>
            </div>

        </main>
    </div>

    <!-- EDIT MODAL -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">עריכת משימה</h3>
            <input type="hidden" id="edit-id">
            
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold">סוג משימה</label>
                    <select id="edit-type" class="w-full border p-2 rounded">
                        <option value="insp">בקרת תחנה</option>
                        <option value="travel">נסיעה</option>
                        <option value="anchor">עוגן</option>
                        <option value="admin">מנהלה</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold">מיקום</label>
                    <select id="edit-loc" class="w-full border p-2 rounded"></select>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-bold">התחלה</label>
                        <input type="time" id="edit-start" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-xs font-bold">משך (דקות)</label>
                        <input type="number" id="edit-dur" class="w-full border p-2 rounded">
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-between">
                <button onclick="deleteTask()" class="text-red-500 font-bold text-sm">מחק משימה</button>
                <div class="flex gap-2">
                    <button onclick="closeModal()" class="btn bg-gray-200 text-gray-700">ביטול</button>
                    <button onclick="saveTaskEdit()" class="btn btn-primary">שמור</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * R-LIGHT ENTERPRISE ENGINE
         * Single Source of Truth: `db` object.
         */

        // --- Initial Data Structure ---
        const defaultDB = {
            meta: { version: "6.0", lastUpdated: null },
            settings: { maxShiftHours: 9, minRestHours: 8 },
            inspectors: [
                {n:"דניאל אברהם", s:"morning", base:"תמ פת"}, {n:"רונית לוי", s:"morning", base:"הקוממיות"},
                {n:"יוסי כהן", s:"morning", base:"אליפלט"}, {n:"אלירן סבג", s:"evening", base:"תמ פת"},
                {n:"גלית דיסטל", s:"evening", base:"הקוממיות"}, {n:"משה אשכנזי", s:"evening", base:"ארלוזורוב"}
            ],
            stations: [
                {n:"תמ פת",g:1,t:20}, {n:"פינסקר",g:2,t:20}, {n:"קרית אריה",g:4,t:25}, {n:"שנקר",g:6,t:20},
                {n:"אהרונוביץ",g:9,t:30}, {n:"בן גוריון",g:11,t:30}, {n:"ביאליק",g:12,t:30}, {n:"ארלוזורוב",g:14,t:35},
                {n:"שאול המלך",g:15,t:35}, {n:"קרליבך",g:17,t:30}, {n:"אלנבי",g:18,t:30}, {n:"אליפלט",g:19,t:25},
                {n:"בלומפילד",g:21,t:20}, {n:"יפו",g:23,t:20}, {n:"יוספטל",g:28,t:25}, {n:"בלפור",g:30,t:25},
                {n:"בנימין",g:31,t:25}, {n:"הקוממיות",g:34,t:25}
            ],
            schedule: [], // The Tasks
            anchors: []
        };

        let db = JSON.parse(JSON.stringify(defaultDB)); // Active State
        const days = ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];

        // --- Initialization ---
        window.onload = () => {
            const saved = localStorage.getItem('rlight_db_v6');
            if(saved) db = JSON.parse(saved);
            
            document.getElementById('start-date').value = new Date().toISOString().split('T')[0];
            
            // Populate Filters & Selects
            const dayOpts = days.map((d,i)=>`<option value="${i}">${d}</option>`).join('');
            document.getElementById('gantt-day-filter').innerHTML = dayOpts;
            
            const stOpts = db.stations.map(s=>`<option>${s.n}</option>`).join('');
            document.getElementById('edit-loc').innerHTML = stOpts;

            updateSystem();
        };

        // --- Core System Update Loop ---
        function updateSystem() {
            db.meta.lastUpdated = new Date().toISOString();
            localStorage.setItem('rlight_db_v6', JSON.stringify(db));
            
            // Update JSON View
            document.getElementById('json-editor').value = JSON.stringify(db, null, 2);
            
            // Run Validation
            const violations = validateRules();
            renderAlerts(violations);
            
            // Update Stats
            document.getElementById('stat-tasks').innerText = db.schedule.length;
            document.getElementById('stat-anchors').innerText = db.anchors.length;
            document.getElementById('stat-violations').innerText = violations.length;

            // Render Active View
            if(!document.getElementById('page-gantt').classList.contains('hidden')) renderGantt(violations);
            
            // Sync Animation
            const sync = document.getElementById('sync-status');
            sync.innerHTML = `<i class="fas fa-sync fa-spin"></i> שומר...`;
            setTimeout(() => sync.innerHTML = `<i class="fas fa-check-circle"></i> מסונכרן`, 500);
        }

        // --- Validation Engine ---
        function validateRules() {
            const violations = [];
            
            // 1. Group tasks by inspector and day
            db.inspectors.forEach(insp => {
                for(let d=0; d<7; d++) {
                    const tasks = db.schedule.filter(t => t.insp === insp.n && t.dIdx === d).sort((a,b)=>a.start-b.start);
                    if(tasks.length === 0) continue;

                    // Rule: Max Shift Length
                    const shiftStart = tasks[0].start;
                    const shiftEnd = tasks[tasks.length-1].end;
                    const durationHours = (shiftEnd - shiftStart) / 60;
                    
                    if(durationHours > db.settings.maxShiftHours) {
                        violations.push({
                            type: 'hours', 
                            msg: `${insp.n} (יום ${days[d]}): משמרת ארוכה מדי (${durationHours.toFixed(1)} שעות)`,
                            taskIds: tasks.map(t=>t.id)
                        });
                    }

                    // Rule: Overlaps
                    for(let i=0; i<tasks.length-1; i++) {
                        if(tasks[i].end > tasks[i+1].start) {
                            violations.push({
                                type: 'overlap',
                                msg: `${insp.n} (יום ${days[d]}): חפיפת זמנים בין משימות`,
                                taskIds: [tasks[i].id, tasks[i+1].id]
                            });
                        }
                    }
                }
            });
            return violations;
        }

        function renderAlerts(violations) {
            const list = document.getElementById('alerts-list');
            if(violations.length === 0) {
                list.innerHTML = `<div class="text-green-600 font-bold"><i class="fas fa-check"></i> הכל תקין</div>`;
                return;
            }
            list.innerHTML = violations.map(v => `
                <div class="bg-red-50 text-red-700 p-2 rounded border border-red-200 text-xs font-bold flex items-center gap-2">
                    <i class="fas fa-times-circle"></i> ${v.msg}
                </div>
            `).join('');
        }

        // --- Scheduler Logic (Simplified for V6) ---
        function runScheduler() {
            db.schedule = []; // Clear
            const startDt = new Date(document.getElementById('start-date').value);
            
            for(let d=0; d<7; d++) {
                const dateStr = new Date(startDt.getTime() + d*86400000).toISOString().split('T')[0];
                
                db.inspectors.forEach(insp => {
                    let time = insp.s === "morning" ? 360 : 840; // 06:00 / 14:00
                    const end = insp.s === "morning" ? 870 : 1350;
                    let loc = insp.base;

                    while(time < end) {
                        // Simple Logic: Find best station
                        let best = db.stations[0], min = Infinity;
                        const cGeo = db.stations.find(s=>s.n===loc)?.g || 1;
                        
                        db.stations.forEach(s => {
                            if(s.n===loc) return;
                            let score = Math.abs(s.g - cGeo)*2 + Math.random()*5;
                            if(score < min) { min = score; best = s; }
                        });

                        const travel = Math.abs(best.g - cGeo)*3 + 5;
                        
                        // Add Travel
                        if(travel > 5) {
                            addTask(d, dateStr, insp.n, "נסיעה", best.n, time, travel, "travel");
                            time += travel;
                        }
                        
                        // Add Inspection
                        addTask(d, dateStr, insp.n, "בקרת תחנה", best.n, time, 30, "insp");
                        time += 30;
                        loc = best.n;
                    }
                });
            }
            updateSystem();
            showPage('gantt');
        }

        function addTask(dIdx, date, insp, task, loc, start, dur, type) {
            db.schedule.push({
                id: Date.now() + Math.random(),
                dIdx, date, insp, task, loc, start, dur, type, end: start+dur
            });
        }

        // --- Gantt & Editing ---
        function renderGantt(violations = []) {
            const dIdx = parseInt(document.getElementById('gantt-day-filter').value);
            const header = document.getElementById('gantt-header');
            const body = document.getElementById('gantt-body');
            
            // Header
            let hHtml = `<div class="gantt-label">בקר / שעה</div><div class="gantt-timeline flex">`;
            for(let h=6; h<=23; h++) hHtml += `<div style="flex:1; border-right:1px solid #e2e8f0; text-align:center; font-size:10px; color:#94a3b8;">${h}:00</div>`;
            header.innerHTML = hHtml + `</div>`;

            // Body
            const pxPerMin = 1000 / (18*60); // 1000px width / 18 hours
            
            body.innerHTML = db.inspectors.map(insp => {
                const tasks = db.schedule.filter(t => t.dIdx === dIdx && t.insp === insp.n);
                
                let row = `<div class="gantt-row"><div class="gantt-label">${insp.n}</div><div class="gantt-timeline">`;
                
                row += tasks.map(t => {
                    const left = (t.start - 360) * pxPerMin;
                    const width = t.dur * pxPerMin;
                    const isViolated = violations.some(v => v.taskIds.includes(t.id));
                    const bg = `bg-${t.type}`;
                    
                    return `<div class="task-block ${bg} ${isViolated?'violation':''}" 
                            style="left:${left}px; width:${width}px;"
                            onclick="openEditModal(${t.id})"
                            title="${t.task}">
                            ${width>30 ? t.loc : ''}
                            </div>`;
                }).join('');
                
                return row + `</div></div>`;
            }).join('');
        }

        // --- Modal Logic ---
        let currentEditId = null;

        function openEditModal(id) {
            const task = db.schedule.find(t => t.id === id);
            if(!task) return;
            currentEditId = id;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-type').value = task.type;
            document.getElementById('edit-loc').value = task.loc;
            document.getElementById('edit-start').value = minsToTime(task.start);
            document.getElementById('edit-dur').value = task.dur;
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function saveTaskEdit() {
            const task = db.schedule.find(t => t.id === currentEditId);
            if(task) {
                task.type = document.getElementById('edit-type').value;
                task.loc = document.getElementById('edit-loc').value;
                task.start = timeToMins(document.getElementById('edit-start').value);
                task.dur = parseInt(document.getElementById('edit-dur').value);
                task.end = task.start + task.dur;
                
                // Update Task Name based on type
                const map = {insp:"בקרת תחנה", travel:"נסיעה", anchor:"עוגן", admin:"מנהלה"};
                task.task = map[task.type];
                
                updateSystem();
                closeModal();
            }
        }

        function deleteTask() {
            if(confirm("למחוק משימה זו?")) {
                db.schedule = db.schedule.filter(t => t.id !== currentEditId);
                updateSystem();
                closeModal();
            }
        }

        function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); }

        // --- JSON File Handling ---
        function saveJsonFromEditor() {
            try {
                const newDb = JSON.parse(document.getElementById('json-editor').value);
                db = newDb;
                updateSystem();
                alert("הנתונים נשמרו בהצלחה!");
            } catch(e) { alert("שגיאה בפורמט JSON"); }
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(db, null, 2)], {type : 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'database.json';
            link.click();
        }

        function uploadJSON(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    db = JSON.parse(e.target.result);
                    updateSystem();
                    alert("הקובץ נטען בהצלחה!");
                } catch(err) { alert("קובץ לא תקין"); }
            };
            reader.readAsText(file);
        }

        // --- Helpers ---
        function showPage(id) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${id}`).classList.remove('hidden');
            if(id === 'gantt') renderGantt(validateRules());
        }
        function timeToMins(s) { let [h,m]=s.split(':').map(Number); return h*60+m; }
        function minsToTime(m) { 
            let h = Math.floor(m/60), n = Math.floor(m%60); 
            return `${h.toString().padStart(2,'0')}:${n.toString().padStart(2,'0')}`; 
        }
    </script>
</body>
</html>
